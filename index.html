<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Statement Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0f172a;
            --primary-light: #1e293b;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #0f172a;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #ecf0f5 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            animation: slideDown 0.6s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent) 0%, #1e40af 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 16px;
            margin-bottom: 5px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin: 30px 0 20px 0;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: 1px solid var(--border);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            transition: all 0.3s ease;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--primary);
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="password"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="file"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        input[type="file"] {
            cursor: pointer;
            padding: 10px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--primary-light);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .period-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .period-btn {
            padding: 10px 12px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        .period-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .period-btn:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .data-input {
            display: flex;
            flex-direction: column;
        }

        .ratio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .ratio-card {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .ratio-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ratio-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .ratio-trend {
            font-size: 12px;
            opacity: 0.9;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        .trend-neutral {
            color: var(--text-light);
        }

        .alert {
            padding: 14px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .alert-info {
            background: #dbeafe;
            color: #0c4a6e;
            border: 1px solid #bfdbfe;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .insights-container {
            background: linear-gradient(135deg, #f0f9ff 0%, #f5f3ff 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent);
            margin-bottom: 20px;
        }

        .insights-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 16px;
        }

        .insights-text {
            color: var(--text);
            line-height: 1.6;
            font-size: 14px;
        }

        .insights-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-light);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .table-responsive {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--primary-light);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: var(--bg);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 24px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--text);
        }

        .success-badge {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .error-badge {
            display: inline-block;
            background: var(--danger);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr;
            }

            .ratio-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .card {
                padding: 16px;
            }

            .logo {
                font-size: 24px;
            }

            .chart-container {
                height: 250px;
            }

            button {
                width: 100%;
            }
        }

        .hide {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üìä Financial Analyzer</div>
            <p class="subtitle">Analyze financial statements, calculate ratios & get AI insights</p>
        </header>

        <!-- Step 1: Analysis Period & File Upload -->
        <div class="card">
            <div class="section-title">üìÖ Step 1: Select Analysis Period</div>
            <p style="color: var(--text-light); margin-bottom: 20px; font-size: 14px;">Choose how many years you want to analyze (1-5 years)</p>
            <div class="period-selector">
                <button class="period-btn" onclick="setPeriod(1)">1 Year</button>
                <button class="period-btn" onclick="setPeriod(2)">2 Years</button>
                <button class="period-btn active" onclick="setPeriod(3)">3 Years</button>
                <button class="period-btn" onclick="setPeriod(4)">4 Years</button>
                <button class="period-btn" onclick="setPeriod(5)">5 Years</button>
            </div>
            <input type="hidden" id="analysisPeriod" value="3">
        </div>

        <!-- Step 2: File Upload -->
        <div class="card">
            <div class="section-title">üìÅ Step 2: Upload Financial Statements</div>
            <p style="color: var(--text-light); margin-bottom: 20px; font-size: 14px;">Upload PDF, Excel, or CSV files with financial data. We'll automatically extract the data.</p>
            
            <div class="form-group">
                <label>Company Name</label>
                <input type="text" id="companyName" placeholder="e.g., Apple Inc., Tesla, Microsoft">
            </div>

            <div class="form-group">
                <label>Upload Financial Statements (PDF, Excel, or CSV)</label>
                <input type="file" id="fileUpload" multiple accept=".pdf,.xlsx,.xls,.csv" onchange="handleFileUpload(event)">
                <small style="color: var(--text-light); margin-top: 8px; display: block;">Supported: PDF, Excel (.xlsx), CSV files. Attach as many as you need.</small>
            </div>

            <div id="uploadStatus" class="hide" style="margin-bottom: 16px;"></div>

            <button class="btn-primary" onclick="parseFiles()">
                <span>üîç Parse Files</span>
            </button>
        </div>

        <!-- Step 3: Data Entry / Review -->
        <div class="card">
            <div class="section-title">üìù Step 3: Financial Data (Auto-filled or Manual)</div>
            <p style="color: var(--text-light); margin-bottom: 20px; font-size: 14px;">Your data is automatically populated from uploaded files. You can edit or add data manually if needed.</p>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('auto-parsed')">üìÑ Auto-Parsed Data</button>
                <button class="tab-btn" onclick="switchTab('manual-entry')">‚úèÔ∏è Manual Entry</button>
            </div>

            <!-- Auto-Parsed Tab -->
            <div id="auto-parsed" class="tab-content active">
                <div id="parsedDataDisplay" style="margin-bottom: 20px; max-height: 400px; overflow-y: auto;"></div>
            </div>

            <!-- Manual Entry Tab -->
            <div id="manual-entry" class="tab-content">
                <div id="manualDataForm"></div>
                <button class="btn-secondary" onclick="addManualDataYear()">+ Add Year</button>
            </div>

            <button class="btn-success" style="margin-top: 20px;" onclick="proceedToAnalysis()">‚úì Proceed to Analysis</button>
        </div>

        <!-- Step 4: Financial Analysis -->
        <div class="card" id="analysisCard" style="display: none;">
            <div class="section-title">üìä Step 4: Financial Analysis Results</div>

            <!-- Year Selection for Charts -->
            <div style="margin-bottom: 20px;">
                <label style="margin-bottom: 10px;">Select Years to Display:</label>
                <div id="yearSelection" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
            </div>

            <!-- Charts Section -->
            <div style="margin-bottom: 30px;">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 15px;">üìà Key Trends</h3>
                <div class="chart-container">
                    <canvas id="ratioChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="profitabilityChart"></canvas>
                </div>
            </div>

            <!-- Ratios Section -->
            <div style="margin-bottom: 30px;">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 15px;">üìä Financial Ratios</h3>
                <div id="ratiosDisplay"></div>
            </div>

            <!-- Trend Analysis Section -->
            <div style="margin-bottom: 30px;">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 15px;">üìâ Trend Analysis</h3>
                <div id="trendAnalysis"></div>
            </div>

            <!-- AI Insights Section -->
            <div style="margin-bottom: 30px;">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 15px;">ü§ñ AI-Powered Insights</h3>
                
                <div style="margin-bottom: 16px;">
                    <label style="margin-bottom: 8px;">AI Provider (Optional)</label>
                    <select id="aiProvider">
                        <option value="none">No API Key (Built-in Analysis)</option>
                        <option value="openai">OpenAI (GPT-4)</option>
                        <option value="grok">Grok / xAI</option>
                        <option value="claude">Claude (Anthropic)</option>
                    </select>
                </div>

                <div id="apiKeyInput" style="display: none; margin-bottom: 16px;">
                    <label style="margin-bottom: 8px;">Enter Your API Key</label>
                    <input type="password" id="apiKey" placeholder="Your API key (stored locally only)">
                    <small style="color: var(--text-light); margin-top: 8px; display: block;">üîí Your API key is stored in your browser only, never sent to our servers.</small>
                </div>

                <button class="btn-primary" id="insightBtn" onclick="generateInsights()">Generate Insights</button>
                <div id="insightsDisplay" style="margin-top: 20px;"></div>
            </div>

            <!-- Export Section -->
            <div style="margin-bottom: 30px;">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 15px;">üíæ Export Report</h3>
                <div class="export-buttons">
                    <button class="btn-secondary btn-small" onclick="exportJSON()">üì• JSON</button>
                    <button class="btn-secondary btn-small" onclick="exportCSV()">üìä CSV</button>
                    <button class="btn-secondary btn-small" onclick="window.print()">üñ®Ô∏è Print</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer style="text-align: center; margin-top: 40px; padding-bottom: 20px; color: var(--text-light); font-size: 13px;">
            <p>üí° Financial Analyzer v1.0 | 100% Client-Side | No Data Stored</p>
            <p style="margin-top: 8px;">For privacy concerns: All analysis happens in your browser. Files are never uploaded to any server.</p>
        </footer>
    </div>

    <script>
        // ============================================================================
        // GLOBAL STATE MANAGEMENT
        // ============================================================================
        let appState = {
            analysisPeriod: 3,
            companyName: '',
            files: [],
            parsedData: {},
            manualData: {},
            financialData: {},
            ratios: {},
            trends: {},
            selectedYears: [],
            charts: {}
        };

        // ============================================================================
        // PERIOD SELECTION
        // ============================================================================
        function setPeriod(period) {
            appState.analysisPeriod = period;
            document.getElementById('analysisPeriod').value = period;
            
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            console.log('[v0] Analysis period set to:', period, 'years');
        }

        // ============================================================================
        // FILE UPLOAD & PARSING
        // ============================================================================
        function handleFileUpload(event) {
            appState.files = Array.from(event.target.files);
            const status = document.getElementById('uploadStatus');
            
            if (appState.files.length > 0) {
                status.className = 'alert alert-success';
                status.innerHTML = `‚úì ${appState.files.length} file(s) selected: ${appState.files.map(f => f.name).join(', ')}`;
            } else {
                status.className = 'hide';
            }
        }

        async function parseFiles() {
            const status = document.getElementById('uploadStatus');
            const companyName = document.getElementById('companyName').value.trim();

            if (!companyName) {
                status.className = 'alert alert-danger';
                status.textContent = '‚ùå Please enter company name';
                return;
            }

            if (appState.files.length === 0) {
                status.className = 'alert alert-warning';
                status.textContent = '‚ö†Ô∏è No files selected. You can manually enter data instead.';
                return;
            }

            appState.companyName = companyName;
            status.className = 'alert alert-info';
            status.innerHTML = '<div class="insights-loading"><div class="spinner"></div> Parsing files...</div>';

            try {
                for (const file of appState.files) {
                    if (file.type === 'application/pdf') {
                        await parsePDF(file);
                    } else if (file.type === 'text/csv') {
                        parseCSV(file);
                    } else if (file.type.includes('sheet') || file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        parseExcel(file);
                    }
                }

                status.className = 'alert alert-success';
                status.innerHTML = '‚úì Files parsed successfully!<br><small>Review extracted data in the "Auto-Parsed Data" tab below</small>';
                displayParsedData();
            } catch (error) {
                console.error('[v0] Parsing error:', error);
                status.className = 'alert alert-warning';
                status.innerHTML = `‚ö†Ô∏è Partial parsing successful. Review data below and fill gaps manually if needed.`;
                displayParsedData();
            }
        }

        // PDF.js Parser
        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let allText = '';
            for (let i = 1; i <= Math.min(pdf.numPages, 10); i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                allText += textContent.items.map(item => item.str).join(' ') + ' ';
            }

            extractFinancialDataFromText(allText, file.name);
        }

        // CSV Parser
        function parseCSV(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                Papa.parse(e.target.result, {
                    header: true,
                    complete: (results) => {
                        extractFinancialDataFromTable(results.data, file.name);
                    }
                });
            };
            reader.readAsText(file);
        }

        // Excel Parser
        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(sheet);
                extractFinancialDataFromTable(data, file.name);
            };
            reader.readAsBinaryString(file);
        }

        // Extract Financial Data from Text (PDF)
        function extractFinancialDataFromText(text, fileName) {
            const keywords = {
                revenue: ['revenue', 'sales', 'net sales', 'operating revenue'],
                netIncome: ['net income', 'net profit', 'earnings', 'bottom line'],
                totalAssets: ['total assets', 'assets'],
                totalLiabilities: ['total liabilities', 'liabilities'],
                currentAssets: ['current assets', 'working capital'],
                currentLiabilities: ['current liabilities'],
                equity: ['shareholders equity', 'total equity', 'equity'],
                operatingCashFlow: ['operating cash flow', 'cash from operations'],
                ebitda: ['ebitda', 'operating income'],
                costOfRevenue: ['cost of revenue', 'cost of goods sold', 'cogs']
            };

            const lowerText = text.toLowerCase();
            const extractedYear = {};

            // Try to extract numbers near keywords
            for (const [key, keywordList] of Object.entries(keywords)) {
                for (const keyword of keywordList) {
                    const regex = new RegExp(`${keyword}[^0-9]*([0-9,]+\\.?[0-9]*)`, 'gi');
                    const match = regex.exec(lowerText);
                    if (match) {
                        const value = parseFloat(match[1].replace(/,/g, ''));
                        if (value > 0) {
                            extractedYear[key] = value;
                            break;
                        }
                    }
                }
            }

            if (Object.keys(extractedYear).length > 0) {
                const year = new Date().getFullYear();
                appState.parsedData[year] = extractedYear;
            }
        }

        // Extract Financial Data from Tables (CSV/Excel)
        function extractFinancialDataFromTable(data, fileName) {
            const keywordMapping = {
                revenue: ['revenue', 'sales', 'net sales'],
                netIncome: ['net income', 'net profit', 'earnings'],
                totalAssets: ['total assets', 'assets'],
                totalLiabilities: ['total liabilities', 'liabilities'],
                currentAssets: ['current assets'],
                currentLiabilities: ['current liabilities'],
                equity: ['equity', 'shareholders equity'],
                operatingCashFlow: ['operating cash flow', 'cash flow'],
                ebitda: ['ebitda', 'operating income'],
                costOfRevenue: ['cost of revenue', 'cogs', 'cost of goods']
            };

            data.forEach((row, index) => {
                const extractedData = {};
                const year = 2024 - index;

                Object.entries(row).forEach(([header, value]) => {
                    const lowerHeader = header.toLowerCase();
                    for (const [key, keywords] of Object.entries(keywordMapping)) {
                        if (keywords.some(kw => lowerHeader.includes(kw))) {
                            const numValue = parseFloat(String(value).replace(/[^0-9.-]/g, ''));
                            if (!isNaN(numValue) && numValue !== 0) {
                                extractedData[key] = Math.abs(numValue);
                            }
                        }
                    }
                });

                if (Object.keys(extractedData).length > 0) {
                    appState.parsedData[year] = extractedData;
                }
            });
        }

        // Display Parsed Data
        function displayParsedData() {
            const display = document.getElementById('parsedDataDisplay');
            
            if (Object.keys(appState.parsedData).length === 0) {
                display.innerHTML = `
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è No financial data extracted from files. This is normal for complex PDFs. 
                        You can manually enter data in the "‚úèÔ∏è Manual Entry" tab.
                    </div>
                `;
                return;
            }

            let html = `<div style="margin-bottom: 16px;">
                <strong>Extracted Data:</strong>
                <button class="btn-secondary btn-small" onclick="clearParsedData()" style="float: right;">Clear</button>
            </div>`;

            for (const [year, data] of Object.entries(appState.parsedData)) {
                html += `
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <strong>${year}</strong>
                        <div style="font-size: 13px; color: var(--text-light); margin-top: 8px;">
                            ${Object.entries(data).map(([key, value]) => 
                                `${key}: $${(value / 1000000).toFixed(1)}M`
                            ).join('<br>')}
                        </div>
                    </div>
                `;
            }

            display.innerHTML = html;
            generateManualDataForm();
        }

        function clearParsedData() {
            appState.parsedData = {};
            document.getElementById('parsedDataDisplay').innerHTML = '';
        }

        // ============================================================================
        // MANUAL DATA ENTRY
        // ============================================================================
        function generateManualDataForm() {
            const form = document.getElementById('manualDataForm');
            const period = appState.analysisPeriod;
            const startYear = new Date().getFullYear();
            
            let html = '';
            for (let i = 0; i < period; i++) {
                const year = startYear - i;
                html += generateYearForm(year);
            }

            form.innerHTML = html;
        }

        function generateYearForm(year) {
            const fields = [
                { label: 'Revenue', id: 'revenue', placeholder: 'e.g., 100000000' },
                { label: 'Net Income', id: 'netIncome', placeholder: 'e.g., 20000000' },
                { label: 'Total Assets', id: 'totalAssets', placeholder: 'e.g., 500000000' },
                { label: 'Total Liabilities', id: 'totalLiabilities', placeholder: 'e.g., 200000000' },
                { label: 'Current Assets', id: 'currentAssets', placeholder: 'e.g., 100000000' },
                { label: 'Current Liabilities', id: 'currentLiabilities', placeholder: 'e.g., 50000000' },
                { label: 'Shareholders Equity', id: 'equity', placeholder: 'e.g., 300000000' },
                { label: 'Operating Cash Flow', id: 'operatingCashFlow', placeholder: 'e.g., 50000000' },
                { label: 'EBITDA', id: 'ebitda', placeholder: 'e.g., 40000000' },
                { label: 'Cost of Revenue', id: 'costOfRevenue', placeholder: 'e.g., 60000000' }
            ];

            let html = `
                <div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent);">
                    <h4 style="margin-bottom: 14px; color: var(--primary);">${year}</h4>
                    <div class="data-grid">
            `;

            fields.forEach(field => {
                const value = appState.parsedData[year]?.[field.id] || '';
                html += `
                    <div class="data-input">
                        <label style="font-size: 12px; color: var(--text-light);">${field.label}</label>
                        <input 
                            type="number" 
                            id="year-${year}-${field.id}"
                            value="${value}"
                            placeholder="${field.placeholder}"
                            onchange="updateManualData(${year}, '${field.id}', this.value)"
                        >
                    </div>
                `;
            });

            html += `</div></div>`;
            return html;
        }

        function updateManualData(year, field, value) {
            if (!appState.manualData[year]) {
                appState.manualData[year] = {};
            }
            appState.manualData[year][field] = value ? parseFloat(value) : null;
        }

        function addManualDataYear() {
            const years = Object.keys(appState.manualData).map(Number);
            const newYear = years.length > 0 ? Math.min(...years) - 1 : new Date().getFullYear() - appState.analysisPeriod;
            
            const form = document.getElementById('manualDataForm');
            form.innerHTML += generateYearForm(newYear);
        }

        // ============================================================================
        // ANALYSIS
        // ============================================================================
        function proceedToAnalysis() {
            // Merge parsed and manual data
            appState.financialData = { ...appState.parsedData };
            
            for (const [year, data] of Object.entries(appState.manualData)) {
                if (!appState.financialData[year]) {
                    appState.financialData[year] = {};
                }
                Object.assign(appState.financialData[year], data);
            }

            if (Object.keys(appState.financialData).length === 0) {
                alert('‚ùå Please enter financial data before proceeding');
                return;
            }

            // Calculate ratios and trends
            calculateAllRatios();
            calculateTrends();
            appState.selectedYears = Object.keys(appState.financialData).sort().slice(-Math.min(appState.analysisPeriod, 5));

            // Display analysis
            document.getElementById('analysisCard').style.display = 'block';
            displayYearSelection();
            displayRatios();
            displayTrendAnalysis();
            createCharts();

            // Scroll to results
            document.getElementById('analysisCard').scrollIntoView({ behavior: 'smooth' });
        }

        // ============================================================================
        // RATIO CALCULATIONS
        // ============================================================================
        function calculateAllRatios() {
            appState.ratios = {};

            for (const [year, data] of Object.entries(appState.financialData)) {
                appState.ratios[year] = {
                    // Liquidity Ratios
                    currentRatio: data.currentAssets && data.currentLiabilities ? 
                        (data.currentAssets / data.currentLiabilities).toFixed(2) : 'N/A',
                    quickRatio: data.currentAssets && data.currentLiabilities ? 
                        ((data.currentAssets - (data.totalAssets * 0.2)) / data.currentLiabilities).toFixed(2) : 'N/A',
                    
                    // Profitability Ratios
                    netProfitMargin: data.revenue && data.netIncome ? 
                        ((data.netIncome / data.revenue) * 100).toFixed(2) : 'N/A',
                    roe: data.equity && data.netIncome ? 
                        ((data.netIncome / data.equity) * 100).toFixed(2) : 'N/A',
                    roa: data.totalAssets && data.netIncome ? 
                        ((data.netIncome / data.totalAssets) * 100).toFixed(2) : 'N/A',
                    
                    // Solvency Ratios
                    debtToEquity: data.totalLiabilities && data.equity ? 
                        (data.totalLiabilities / data.equity).toFixed(2) : 'N/A',
                    debtRatio: data.totalLiabilities && data.totalAssets ? 
                        ((data.totalLiabilities / data.totalAssets) * 100).toFixed(2) : 'N/A',
                    
                    // Efficiency Ratios
                    assetTurnover: data.totalAssets && data.revenue ? 
                        (data.revenue / data.totalAssets).toFixed(2) : 'N/A',
                    
                    // Other
                    operatingMargin: data.revenue && data.ebitda ? 
                        ((data.ebitda / data.revenue) * 100).toFixed(2) : 'N/A',
                    grossMargin: data.revenue && data.costOfRevenue ? 
                        (((data.revenue - data.costOfRevenue) / data.revenue) * 100).toFixed(2) : 'N/A'
                };
            }
        }

        function calculateTrends() {
            appState.trends = {};
            const years = Object.keys(appState.financialData).sort();

            if (years.length < 2) {
                appState.trends = { note: 'Need at least 2 years for trend analysis' };
                return;
            }

            const latestYear = years[years.length - 1];
            const previousYear = years[years.length - 2];

            const latest = appState.ratios[latestYear];
            const previous = appState.ratios[previousYear];

            for (const ratio in latest) {
                if (typeof latest[ratio] === 'number' && typeof previous[ratio] === 'number') {
                    const change = ((latest[ratio] - previous[ratio]) / previous[ratio] * 100).toFixed(2);
                    appState.trends[ratio] = change;
                }
            }
        }

        // ============================================================================
        // DISPLAY RESULTS
        // ============================================================================
        function displayYearSelection() {
            const container = document.getElementById('yearSelection');
            const years = Object.keys(appState.financialData).sort();

            container.innerHTML = years.map(year => `
                <button 
                    class="period-btn ${appState.selectedYears.includes(year) ? 'active' : ''}" 
                    onclick="toggleYear('${year}')"
                >${year}</button>
            `).join('');
        }

        function toggleYear(year) {
            const index = appState.selectedYears.indexOf(year);
            if (index > -1) {
                appState.selectedYears.splice(index, 1);
            } else {
                appState.selectedYears.push(year);
            }
            appState.selectedYears.sort();

            document.querySelectorAll('#yearSelection .period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            createCharts();
        }

        function displayRatios() {
            const container = document.getElementById('ratiosDisplay');
            const years = Object.keys(appState.ratios).sort().reverse();

            let html = '';
            for (const year of years) {
                const ratios = appState.ratios[year];
                const trend = appState.trends[year] || {};

                html += `
                    <div style="margin-bottom: 30px;">
                        <h4 style="margin-bottom: 15px; color: var(--primary);">${year}</h4>
                        <div class="ratio-grid">
                            ${generateRatioCards(ratios, year)}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function generateRatioCards(ratios, year) {
            const categories = {
                'Liquidity': ['currentRatio', 'quickRatio'],
                'Profitability': ['netProfitMargin', 'roe', 'roa'],
                'Solvency': ['debtToEquity', 'debtRatio'],
                'Efficiency': ['assetTurnover']
            };

            let html = '';
            for (const [category, fields] of Object.entries(categories)) {
                for (const field of fields) {
                    const value = ratios[field];
                    if (value !== 'N/A') {
                        const trendValue = appState.trends[field];
                        let trendClass = 'trend-neutral';
                        let trendIcon = '‚Üí';
                        if (trendValue) {
                            if ((field.includes('Margin') || field.includes('roe') || field.includes('roa') || field === 'assetTurnover') && parseFloat(trendValue) > 0) {
                                trendClass = 'trend-up';
                                trendIcon = '‚Üë';
                            } else if ((field.includes('Debt') || field.includes('Ratio')) && parseFloat(trendValue) < 0) {
                                trendClass = 'trend-up';
                                trendIcon = '‚Üì';
                            } else if (parseFloat(trendValue) < 0) {
                                trendClass = 'trend-down';
                                trendIcon = '‚Üì';
                            } else if (parseFloat(trendValue) > 0) {
                                trendClass = 'trend-up';
                                trendIcon = '‚Üë';
                            }
                        }

                        html += `
                            <div class="ratio-card">
                                <div class="ratio-label">${formatLabel(field)}</div>
                                <div class="ratio-value">${value}</div>
                                <div class="ratio-trend ${trendClass}">
                                    ${trendValue ? `${trendIcon} ${trendValue}%` : 'No trend'}
                                </div>
                            </div>
                        `;
                    }
                }
            }

            return html;
        }

        function formatLabel(text) {
            return text
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        }

        function displayTrendAnalysis() {
            const container = document.getElementById('trendAnalysis');
            const years = Object.keys(appState.financialData).sort();

            if (years.length < 2) {
                container.innerHTML = '<p style="color: var(--text-light);">Need at least 2 years of data for trend analysis</p>';
                return;
            }

            let html = '<div class="table-responsive"><table>';
            html += '<tr><th>Metric</th><th>Trend</th><th>Analysis</th></tr>';

            for (const ratio in appState.trends) {
                const change = appState.trends[ratio];
                if (typeof change !== 'number') continue;

                let status = '‚Üí Stable';
                let statusColor = 'var(--text-light)';

                if (Math.abs(change) > 10) {
                    status = change > 0 ? '‚Üë Improving' : '‚Üì Declining';
                    statusColor = change > 0 ? 'var(--success)' : 'var(--danger)';
                }

                const analysis = getTrendAnalysis(ratio, change);

                html += `
                    <tr>
                        <td><strong>${formatLabel(ratio)}</strong></td>
                        <td style="color: ${statusColor}; font-weight: 600;">${change > 0 ? '+' : ''}${change}%</td>
                        <td>${analysis}</td>
                    </tr>
                `;
            }

            html += '</table></div>';
            container.innerHTML = html;
        }

        function getTrendAnalysis(ratio, change) {
            const positiveTrends = ['Margin', 'ROE', 'ROA', 'Turnover'];
            const isPositive = positiveTrends.some(t => ratio.includes(t));
            const isGoodTrend = isPositive ? change > 0 : change < 0;

            if (isGoodTrend) {
                return '‚úì Positive trend';
            } else {
                return '‚ö† Negative trend - investigate';
            }
        }

        // ============================================================================
        // CHARTS
        // ============================================================================
        function createCharts() {
            createRatioChart();
            createTrendChart();
            createProfitabilityChart();
        }

        function createRatioChart() {
            const ctx = document.getElementById('ratioChart');
            if (appState.charts.ratioChart) appState.charts.ratioChart.destroy();

            const selectedData = {};
            for (const year of appState.selectedYears) {
                selectedData[year] = appState.ratios[year];
            }

            const datasets = [
                {
                    label: 'Current Ratio',
                    data: appState.selectedYears.map(y => parseFloat(selectedData[y]?.currentRatio) || 0),
                    borderColor: '#3b82f6',
                    tension: 0.4
                },
                {
                    label: 'Quick Ratio',
                    data: appState.selectedYears.map(y => parseFloat(selectedData[y]?.quickRatio) || 0),
                    borderColor: '#60a5fa',
                    tension: 0.4
                },
                {
                    label: 'Debt-to-Equity',
                    data: appState.selectedYears.map(y => parseFloat(selectedData[y]?.debtToEquity) || 0),
                    borderColor: '#ef4444',
                    tension: 0.4
                }
            ];

            appState.charts.ratioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: appState.selectedYears,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (appState.charts.trendChart) appState.charts.trendChart.destroy();

            const datasets = [
                {
                    label: 'Net Profit Margin (%)',
                    data: appState.selectedYears.map(y => parseFloat(appState.ratios[y]?.netProfitMargin) || 0),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'ROE (%)',
                    data: appState.selectedYears.map(y => parseFloat(appState.ratios[y]?.roe) || 0),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ];

            appState.charts.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: appState.selectedYears,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createProfitabilityChart() {
            const ctx = document.getElementById('profitabilityChart');
            if (appState.charts.profitabilityChart) appState.charts.profitabilityChart.destroy();

            appState.charts.profitabilityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: appState.selectedYears,
                    datasets: [
                        {
                            label: 'ROA (%)',
                            data: appState.selectedYears.map(y => parseFloat(appState.ratios[y]?.roa) || 0),
                            backgroundColor: '#3b82f6'
                        },
                        {
                            label: 'Gross Margin (%)',
                            data: appState.selectedYears.map(y => parseFloat(appState.ratios[y]?.grossMargin) || 0),
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Operating Margin (%)',
                            data: appState.selectedYears.map(y => parseFloat(appState.ratios[y]?.operatingMargin) || 0),
                            backgroundColor: '#f59e0b'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // ============================================================================
        // AI INSIGHTS
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            const aiProvider = document.getElementById('aiProvider');
            const apiKeyInput = document.getElementById('apiKeyInput');
            
            if (aiProvider) {
                aiProvider.addEventListener('change', function() {
                    apiKeyInput.style.display = this.value === 'none' ? 'none' : 'block';
                });
            }
        });

        async function generateInsights() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('apiKey').value;
            const display = document.getElementById('insightsDisplay');
            const btn = document.getElementById('insightBtn');

            btn.disabled = true;
            display.innerHTML = '<div class="insights-loading"><div class="spinner"></div> Generating insights...</div>';

            try {
                let insights = '';

                if (provider === 'none') {
                    insights = generateBuiltInInsights();
                } else if (!apiKey) {
                    throw new Error('Please enter your API key');
                } else if (provider === 'openai') {
                    insights = await getOpenAIInsights(apiKey);
                } else if (provider === 'grok') {
                    insights = await getGrokInsights(apiKey);
                } else if (provider === 'claude') {
                    insights = await getClaudeInsights(apiKey);
                }

                displayInsights(insights);
            } catch (error) {
                console.error('[v0] Insights error:', error);
                display.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Error: ${error.message}
                        <br><small>Falling back to built-in analysis...</small>
                    </div>
                    <div class="insights-container">
                        <div class="insights-title">Built-in Analysis</div>
                        <div class="insights-text">${generateBuiltInInsights()}</div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
            }
        }

        function generateBuiltInInsights() {
            const latestYear = Object.keys(appState.ratios).sort().pop();
            const latest = appState.ratios[latestYear];
            const trends = appState.trends;

            let insights = '';

            // Profitability Analysis
            const npm = parseFloat(latest.netProfitMargin);
            const roe = parseFloat(latest.roe);
            const roa = parseFloat(latest.roa);

            if (npm > 15) {
                insights += 'üí∞ <strong>Strong Profitability:</strong> Net profit margin of ' + npm + '% indicates excellent cost control and pricing power.\n\n';
            } else if (npm > 5) {
                insights += 'üìä <strong>Moderate Profitability:</strong> Net profit margin of ' + npm + '% is healthy for most industries.\n\n';
            } else if (npm > 0) {
                insights += '‚ö†Ô∏è <strong>Low Profitability:</strong> Net profit margin of ' + npm + '% suggests tight margins. Review cost structure.\n\n';
            }

            if (roe > 15) {
                insights += 'üìà <strong>Strong ROE:</strong> ' + roe + '% ROE demonstrates efficient use of shareholder equity.\n\n';
            }

            // Liquidity Analysis
            const currentRatio = parseFloat(latest.currentRatio);
            if (currentRatio > 2) {
                insights += 'üíß <strong>Excellent Liquidity:</strong> Current ratio of ' + currentRatio + ' indicates strong short-term financial health.\n\n';
            } else if (currentRatio > 1.5) {
                insights += '‚úì <strong>Good Liquidity:</strong> Current ratio of ' + currentRatio + ' is healthy.\n\n';
            } else if (currentRatio > 1) {
                insights += '‚ö†Ô∏è <strong>Adequate Liquidity:</strong> Current ratio of ' + currentRatio + ' is acceptable but monitor closely.\n\n';
            } else {
                insights += 'üö® <strong>Liquidity Concern:</strong> Current ratio below 1 may indicate cash flow challenges.\n\n';
            }

            // Leverage Analysis
            const dte = parseFloat(latest.debtToEquity);
            if (dte < 0.5) {
                insights += 'üõ°Ô∏è <strong>Conservative Debt:</strong> Debt-to-equity of ' + dte + ' shows low financial risk.\n\n';
            } else if (dte < 1) {
                insights += '‚öñÔ∏è <strong>Balanced Leverage:</strong> Debt-to-equity of ' + dte + ' is reasonable.\n\n';
            } else if (dte < 2) {
                insights += '‚ö†Ô∏è <strong>High Leverage:</strong> Debt-to-equity of ' + dte + ' warrants caution. Consider debt reduction.\n\n';
            } else {
                insights += 'üö® <strong>Very High Leverage:</strong> Debt-to-equity of ' + dte + ' indicates significant financial risk.\n\n';
            }

            // Trend Analysis
            if (trends.netProfitMargin && parseFloat(trends.netProfitMargin) > 10) {
                insights += 'üìà <strong>Improving Profitability Trend:</strong> Net profit margin up ' + trends.netProfitMargin + '% - positive momentum.\n\n';
            } else if (trends.netProfitMargin && parseFloat(trends.netProfitMargin) < -10) {
                insights += 'üìâ <strong>Declining Profitability:</strong> Net profit margin down ' + trends.netProfitMargin + '% - investigate causes.\n\n';
            }

            // Recommendations
            insights += 'üí° <strong>Recommendations:</strong>\n';
            if (currentRatio < 1.5) {
                insights += '‚Ä¢ Improve liquidity by reducing short-term debt or increasing working capital\n';
            }
            if (dte > 1.5) {
                insights += '‚Ä¢ Develop debt reduction strategy; consider refinancing high-interest debt\n';
            }
            if (npm < 5) {
                insights += '‚Ä¢ Review pricing strategy and operational efficiency; identify cost-saving opportunities\n';
            }
            if (roa < 5) {
                insights += '‚Ä¢ Optimize asset utilization; assess if all assets are generating adequate returns\n';
            }

            return insights;
        }

        async function getOpenAIInsights(apiKey) {
            const prompt = buildAIPrompt();
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'system',
                            content: 'You are an expert financial analyst. Provide concise, actionable insights on the financial ratios and trends provided.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 1000
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'OpenAI API error');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function getGrokInsights(apiKey) {
            const prompt = buildAIPrompt();

            const response = await fetch('https://api.x.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'grok-2',
                    messages: [
                        {
                            role: 'system',
                            content: 'You are an expert financial analyst. Provide concise, actionable insights on the financial ratios and trends provided.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 1000
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Grok API error');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function getClaudeInsights(apiKey) {
            const prompt = buildAIPrompt();

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-3-5-sonnet-20241022',
                    max_tokens: 1000,
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Claude API error');
            }

            const data = await response.json();
            return data.content[0].text;
        }

        function buildAIPrompt() {
            const latestYear = Object.keys(appState.ratios).sort().pop();
            const ratios = appState.ratios[latestYear];
            
            return `Analyze these financial ratios for ${appState.companyName || 'a company'} (${latestYear}):
            
Current Ratio: ${ratios.currentRatio}
Quick Ratio: ${ratios.quickRatio}
Net Profit Margin: ${ratios.netProfitMargin}%
ROE: ${ratios.roe}%
ROA: ${ratios.roa}%
Debt-to-Equity: ${ratios.debtToEquity}
Asset Turnover: ${ratios.assetTurnover}
Gross Margin: ${ratios.grossMargin}%

Provide a brief professional analysis covering:
1. Financial health (liquidity, solvency, profitability)
2. Key strengths and weaknesses
3. Main risks and opportunities
4. 2-3 specific actionable recommendations

Keep it concise and practical.`;
        }

        function displayInsights(insights) {
            const display = document.getElementById('insightsDisplay');
            const text = insights.replace(/\n/g, '<br>').replace(/\*\*/g, '<strong>').replace(/\*\*/g, '</strong>');
            
            display.innerHTML = `
                <div class="insights-container">
                    <div class="insights-title">‚ú® AI Analysis & Recommendations</div>
                    <div class="insights-text">${text}</div>
                </div>
            `;
        }

        // ============================================================================
        // EXPORT
        // ============================================================================
        function exportJSON() {
            const data = {
                company: appState.companyName,
                exportDate: new Date().toISOString(),
                financialData: appState.financialData,
                ratios: appState.ratios,
                trends: appState.trends
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${appState.companyName}-analysis.json`;
            a.click();
        }

        function exportCSV() {
            let csv = `Company,${appState.companyName}\nExport Date,${new Date().toISOString()}\n\n`;
            csv += 'Year,Current Ratio,Quick Ratio,Net Profit Margin,ROE,ROA,Debt-to-Equity,Asset Turnover\n';

            for (const year of Object.keys(appState.ratios).sort()) {
                const r = appState.ratios[year];
                csv += `${year},${r.currentRatio},${r.quickRatio},${r.netProfitMargin},${r.roe},${r.roa},${r.debtToEquity},${r.assetTurnover}\n`;
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${appState.companyName}-ratios.csv`;
            a.click();
        }

        // ============================================================================
        // TAB SWITCHING
        // ============================================================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'manual-entry') {
                generateManualDataForm();
            }
        }
    </script>
</body>
</html>
