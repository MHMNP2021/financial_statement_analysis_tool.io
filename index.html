<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Statement Analyzer | Professional Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.269/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066cc;
            --primary-light: #e6f2ff;
            --secondary: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-light: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, #f1f5f9 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ============ HEADER ============ */
        header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .logo svg {
            width: 32px;
            height: 32px;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* ============ MAIN CONTAINER ============ */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* ============ TABS ============ */
        .tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .tab-button {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-button:hover {
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ============ FORM ELEMENTS ============ */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        /* ============ BUTTONS ============ */
        button {
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #f1f5f9;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        /* ============ FILE UPLOAD ============ */
        .file-upload {
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--primary-light);
        }

        .file-upload:hover {
            border-color: #0052a3;
            background: #cce5ff;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload-text {
            margin-bottom: 1rem;
        }

        .file-upload-text p {
            margin: 0.5rem 0;
        }

        .file-upload-text .large {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .file-list {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .file-item-name {
            font-weight: 500;
        }

        .file-item-size {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* ============ GRID LAYOUT ============ */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        /* ============ CARDS ============ */
        .card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card-subtext {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.75rem;
        }

        .card.positive { border-left: 4px solid var(--success); }
        .card.negative { border-left: 4px solid var(--danger); }
        .card.warning { border-left: 4px solid var(--warning); }

        /* ============ TABLES ============ */
        .table-container {
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-light);
            border-bottom: 2px solid var(--border-color);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        tbody tr:hover {
            background: var(--primary-light);
        }

        /* ============ ALERTS ============ */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-info {
            background: #eff6ff;
            border-left: 4px solid var(--primary);
            color: #0c4a6e;
        }

        .alert-success {
            background: #f0fdf4;
            border-left: 4px solid var(--success);
            color: #166534;
        }

        .alert-warning {
            background: #fffbeb;
            border-left: 4px solid var(--warning);
            color: #92400e;
        }

        .alert-danger {
            background: #fef2f2;
            border-left: 4px solid var(--danger);
            color: #7f1d1d;
        }

        /* ============ LOADING & STATUS ============ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-primary {
            background: var(--primary-light);
            color: var(--primary);
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        /* ============ CHARTS ============ */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        .chart-small {
            height: 300px;
        }

        /* ============ RESPONSIVE ============ */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 1rem;
            }

            .container {
                padding: 0 1rem;
            }

            .section {
                padding: 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }

            .tabs {
                gap: 0;
                margin-bottom: 1rem;
            }

            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .card-value {
                font-size: 1.5rem;
            }

            table {
                font-size: 0.875rem;
            }

            th, td {
                padding: 0.75rem;
            }
        }

        /* ============ UTILITY CLASSES ============ */
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-secondary); }
        .font-bold { font-weight: 700; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- ============ HEADER ============ -->
    <header>
        <div class="header-container">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                    <path d="M21 3v5h-5"></path>
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                    <path d="M3 21v-5h5"></path>
                </svg>
                Financial Analyzer
            </div>
            <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">üåô</button>
        </div>
    </header>

    <!-- ============ MAIN CONTENT ============ -->
    <div class="container">
        <!-- ============ UPLOAD SECTION ============ -->
        <div class="section">
            <div class="section-title">
                <span>üìä</span>
                Upload Financial Statements
            </div>

            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('upload-files')">Upload Files</button>
                <button class="tab-button" onclick="switchTab('manual-entry')">Manual Entry</button>
            </div>

            <!-- Tab: Upload Files -->
            <div id="upload-files" class="tab-content active">
                <div class="form-group">
                    <label>Analysis Period (Years)</label>
                    <select id="analysisPeriod">
                        <option value="1">1 Year</option>
                        <option value="2">2 Years</option>
                        <option value="3">3 Years</option>
                        <option value="4">4 Years</option>
                        <option value="5" selected>5 Years</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" id="companyName" placeholder="e.g., Union Assurance" value="Union Assurance">
                </div>

                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" multiple accept=".pdf,.xlsx,.xls,.csv" onchange="handleFiles(event)">
                    <div class="file-upload-text">
                        <p class="large">üìÅ</p>
                        <p><strong>Click to upload or drag and drop</strong></p>
                        <p style="color: var(--text-secondary);">PDF, Excel (.xlsx), or CSV files</p>
                    </div>
                </div>

                <div id="fileList" class="file-list hidden">
                    <h3 style="margin-bottom: 1rem;">Uploaded Files:</h3>
                    <div id="fileListContainer"></div>
                </div>

                <div id="uploadStatus" class="mt-4"></div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="processFiles()">
                        <span>‚öôÔ∏è</span> Process Files
                    </button>
                    <button class="btn btn-secondary" onclick="clearFiles()">
                        <span>üóëÔ∏è</span> Clear Files
                    </button>
                </div>
            </div>

            <!-- Tab: Manual Entry -->
            <div id="manual-entry" class="tab-content">
                <div class="alert alert-info">
                    <span class="alert-icon">‚ÑπÔ∏è</span>
                    <div>
                        <strong>Optional:</strong> Enter or correct financial data manually. This is useful if PDF parsing misses some figures or you want to refine the data.
                    </div>
                </div>

                <form id="manualEntryForm" onsubmit="handleManualEntry(event)">
                    <div class="form-group">
                        <label>Year</label>
                        <input type="number" id="manualYear" placeholder="e.g., 2024" min="1900" max="2100">
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">Balance Sheet (Statement of Financial Position)</h3>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Total Assets</label>
                                <input type="number" id="manualTotalAssets" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Total Liabilities</label>
                                <input type="number" id="manualTotalLiabilities" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Current Assets</label>
                                <input type="number" id="manualCurrentAssets" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Current Liabilities</label>
                                <input type="number" id="manualCurrentLiabilities" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Inventory</label>
                                <input type="number" id="manualInventory" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Equity / Shareholders' Funds</label>
                                <input type="number" id="manualEquity" placeholder="Enter amount" step="any">
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">Income Statement</h3>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Revenue / Sales</label>
                                <input type="number" id="manualRevenue" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Cost of Goods Sold (COGS)</label>
                                <input type="number" id="manualCOGS" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Gross Profit</label>
                                <input type="number" id="manualGrossProfit" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Operating Expenses</label>
                                <input type="number" id="manualOpEx" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Operating Income / EBIT</label>
                                <input type="number" id="manualEBIT" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Net Income / Profit</label>
                                <input type="number" id="manualNetIncome" placeholder="Enter amount" step="any">
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">Cash Flow Statement (Optional)</h3>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Operating Cash Flow</label>
                                <input type="number" id="manualOCF" placeholder="Enter amount" step="any">
                            </div>
                            <div class="form-group">
                                <label>Free Cash Flow</label>
                                <input type="number" id="manualFCF" placeholder="Enter amount" step="any">
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">
                            <span>üíæ</span> Save Data Entry
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearManualForm()">
                            <span>üîÑ</span> Clear Form
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ============ ANALYSIS RESULTS ============ -->
        <div id="resultsSection" class="hidden">
            <!-- Key Metrics Overview -->
            <div class="section">
                <div class="section-title">
                    <span>üìà</span>
                    Key Financial Metrics (Latest Year)
                </div>
                <div id="keyMetricsContainer" class="grid-4"></div>
            </div>

            <!-- Financial Ratios -->
            <div class="section">
                <div class="section-title">
                    <span>üìä</span>
                    Financial Ratios Analysis
                </div>

                <div class="tabs">
                    <button class="tab-button active" onclick="switchRatioTab('liquidity')">Liquidity</button>
                    <button class="tab-button" onclick="switchRatioTab('profitability')">Profitability</button>
                    <button class="tab-button" onclick="switchRatioTab('solvency')">Solvency</button>
                    <button class="tab-button" onclick="switchRatioTab('efficiency')">Efficiency</button>
                </div>

                <div id="liquidity" class="tab-content active">
                    <div id="liquidityRatios" class="grid-2"></div>
                </div>
                <div id="profitability" class="tab-content">
                    <div id="profitabilityRatios" class="grid-2"></div>
                </div>
                <div id="solvency" class="tab-content">
                    <div id="solvencyRatios" class="grid-2"></div>
                </div>
                <div id="efficiency" class="tab-content">
                    <div id="efficiencyRatios" class="grid-2"></div>
                </div>
            </div>

            <!-- Trend Charts -->
            <div class="section">
                <div class="section-title">
                    <span>üìâ</span>
                    Trend Analysis
                </div>
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="profitabilityTrendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="leverageTrendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="liquidityTrendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="efficiencyTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Ratio Table -->
            <div class="section">
                <div class="section-title">
                    <span>üìã</span>
                    Detailed Ratio Comparison
                </div>
                <div class="table-container">
                    <table id="ratioTable">
                        <thead>
                            <tr>
                                <th>Ratio / Metric</th>
                                <th>Industry Benchmark</th>
                                <th id="yearCol1"></th>
                                <th id="yearCol2" class="hidden"></th>
                                <th id="yearCol3" class="hidden"></th>
                                <th id="yearCol4" class="hidden"></th>
                                <th id="yearCol5" class="hidden"></th>
                            </tr>
                        </thead>
                        <tbody id="ratioTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="section">
                <div class="section-title">
                    <span>ü§ñ</span>
                    AI-Powered Financial Insights
                </div>

                <div class="form-group">
                    <label>AI Provider (Optional - Built-in Analysis Enabled)</label>
                    <div class="grid-2" style="margin-bottom: 1rem;">
                        <input type="text" id="apiKey" placeholder="Your OpenAI / Grok API Key (optional)">
                        <select id="aiProvider">
                            <option value="builtin">Built-in Analysis (Free)</option>
                            <option value="openai">OpenAI GPT-4</option>
                            <option value="grok">Grok (xAI)</option>
                            <option value="claude">Claude (Anthropic)</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="generateAIInsights()">
                        <span>‚ú®</span> Generate Insights
                    </button>
                </div>

                <div id="aiInsightsContainer" class="mt-4"></div>
            </div>

            <!-- Export Options -->
            <div class="section">
                <div class="section-title">
                    <span>üì•</span>
                    Export Results
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="exportAsJSON()">
                        <span>üìÑ</span> Export as JSON
                    </button>
                    <button class="btn btn-secondary" onclick="exportAsCSV()">
                        <span>üìä</span> Export as CSV
                    </button>
                    <button class="btn btn-secondary" onclick="window.print()">
                        <span>üñ®Ô∏è</span> Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ JAVASCRIPT ============ -->
    <script>
        // ============ STATE MANAGEMENT ============
        let uploadedFiles = [];
        let analysisData = {
            companyName: 'Union Assurance',
            period: 5,
            years: [],
            financialData: {},
            ratios: {}
        };

        // ============ UI FUNCTIONS ============
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function switchRatioTab(ratioType) {
            document.querySelectorAll('#liquidity, #profitability, #solvency, #efficiency').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(ratioType).classList.add('active');

            document.querySelectorAll('.tabs .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function showAlert(message, type = 'info') {
            const alertClass = `alert alert-${type}`;
            const icons = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', danger: '‚ùå' };
            
            const alertHTML = `
                <div class="${alertClass}">
                    <span class="alert-icon">${icons[type]}</span>
                    <div>${message}</div>
                </div>
            `;
            
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.innerHTML += alertHTML;
            
            setTimeout(() => {
                uploadStatus.innerHTML = '';
            }, 5000);
        }

        // ============ FILE UPLOAD ============
        function handleFiles(event) {
            const files = event.target.files;
            uploadedFiles = Array.from(files);

            const fileListContainer = document.getElementById('fileListContainer');
            fileListContainer.innerHTML = '';

            uploadedFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <div class="file-item-name">üìÑ ${file.name}</div>
                        <div class="file-item-size">${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeFile('${file.name}')">Remove</button>
                `;
                fileListContainer.appendChild(fileItem);
            });

            document.getElementById('fileList').classList.remove('hidden');
            analysisData.companyName = document.getElementById('companyName').value;
            analysisData.period = parseInt(document.getElementById('analysisPeriod').value);
        }

        function removeFile(fileName) {
            uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
            if (uploadedFiles.length === 0) {
                document.getElementById('fileList').classList.add('hidden');
            } else {
                handleFiles({ target: { files: uploadedFiles } });
            }
        }

        function clearFiles() {
            uploadedFiles = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('fileList').classList.add('hidden');
            document.getElementById('fileListContainer').innerHTML = '';
            showAlert('Files cleared', 'success');
        }

        // ============ PDF PARSING ============
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';

            for (let i = 1; i <= Math.min(pdf.numPages, 10); i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }

            return fullText;
        }

        // ============ INTELLIGENT DATA EXTRACTION ============
        function extractFinancialData(text) {
            const data = {};

            // Field name mappings for different PDF formats
            const fieldMappings = {
                totalAssets: ['total assets', 'assets total', 'total asset'],
                totalLiabilities: ['total liabilities', 'liabilities total', 'total liability'],
                currentAssets: ['current assets', 'assets current'],
                currentLiabilities: ['current liabilities', 'liabilities current'],
                equity: ['total equity', 'equity total', 'shareholders equity', 'stated capital', 'total shareholders funds'],
                revenue: ['gross written premium', 'net written premium', 'revenue', 'sales', 'total revenue'],
                netIncome: ['profit for the year', 'net income', 'net profit', 'earnings'],
                operatingIncome: ['profit from operations', 'operating income', 'ebit'],
            };

            const lines = text.split('\n');
            
            for (const [key, searchTerms] of Object.entries(fieldMappings)) {
                for (const line of lines) {
                    const lowerLine = line.toLowerCase();
                    for (const term of searchTerms) {
                        if (lowerLine.includes(term)) {
                            const numbers = line.match(/[\d,]+\.?\d*/g);
                            if (numbers) {
                                const value = parseFloat(numbers[numbers.length - 1].replace(/,/g, ''));
                                if (!isNaN(value)) {
                                    data[key] = value;
                                    break;
                                }
                            }
                        }
                    }
                    if (data[key]) break;
                }
            }

            return data;
        }

        // ============ EXCEL/CSV PARSING ============
        function parseExcelFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    resolve(jsonData);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function parseCSVFile(file) {
            return new Promise((resolve) => {
                Papa.parse(file, {
                    complete: (results) => {
                        resolve(results.data);
                    }
                });
            });
        }

        // ============ PROCESS FILES ============
        async function processFiles() {
            if (uploadedFiles.length === 0) {
                showAlert('Please upload at least one file', 'warning');
                return;
            }

            document.getElementById('uploadStatus').innerHTML = '<div class="loading-text"><div class="loading"></div> Processing files...</div>';

            try {
                analysisData.financialData = {};

                for (const file of uploadedFiles) {
                    let data = {};

                    if (file.type === 'application/pdf') {
                        const text = await extractTextFromPDF(file);
                        data = extractFinancialData(text);
                    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        const jsonData = await parseExcelFile(file);
                        data = flattenData(jsonData);
                    } else if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                        const csvData = await parseCSVFile(file);
                        data = flattenData(csvData);
                    }

                    Object.assign(analysisData.financialData, data);
                }

                // Generate years array
                analysisData.years = generateYearsArray(analysisData.period);

                showAlert('Files processed successfully!', 'success');
                displayResults();
                document.getElementById('resultsSection').classList.remove('hidden');
            } catch (error) {
                showAlert(`Error processing files: ${error.message}`, 'danger');
            }

            document.getElementById('uploadStatus').innerHTML = '';
        }

        function flattenData(data) {
            const flattened = {};
            if (Array.isArray(data)) {
                data.forEach((row, idx) => {
                    for (const [key, value] of Object.entries(row)) {
                        flattened[`${key}_${idx}`] = value;
                    }
                });
            }
            return flattened;
        }

        function generateYearsArray(period) {
            const current = new Date().getFullYear();
            const years = [];
            for (let i = period - 1; i >= 0; i--) {
                years.push(current - i);
            }
            return years;
        }

        // ============ MANUAL ENTRY ============
        function handleManualEntry(event) {
            event.preventDefault();

            const year = parseInt(document.getElementById('manualYear').value);
            if (!year) {
                showAlert('Please enter a year', 'warning');
                return;
            }

            const data = {
                year,
                totalAssets: parseFloat(document.getElementById('manualTotalAssets').value) || 0,
                totalLiabilities: parseFloat(document.getElementById('manualTotalLiabilities').value) || 0,
                currentAssets: parseFloat(document.getElementById('manualCurrentAssets').value) || 0,
                currentLiabilities: parseFloat(document.getElementById('manualCurrentLiabilities').value) || 0,
                inventory: parseFloat(document.getElementById('manualInventory').value) || 0,
                equity: parseFloat(document.getElementById('manualEquity').value) || 0,
                revenue: parseFloat(document.getElementById('manualRevenue').value) || 0,
                cogs: parseFloat(document.getElementById('manualCOGS').value) || 0,
                grossProfit: parseFloat(document.getElementById('manualGrossProfit').value) || 0,
                opEx: parseFloat(document.getElementById('manualOpEx').value) || 0,
                ebit: parseFloat(document.getElementById('manualEBIT').value) || 0,
                netIncome: parseFloat(document.getElementById('manualNetIncome').value) || 0,
                ocf: parseFloat(document.getElementById('manualOCF').value) || 0,
                fcf: parseFloat(document.getElementById('manualFCF').value) || 0,
            };

            analysisData.financialData[`year_${year}`] = data;
            
            if (!analysisData.years.includes(year)) {
                analysisData.years.push(year);
                analysisData.years.sort((a, b) => a - b);
            }

            showAlert(`Data for year ${year} saved successfully!`, 'success');
            clearManualForm();
            
            if (Object.keys(analysisData.financialData).length > 0) {
                displayResults();
                document.getElementById('resultsSection').classList.remove('hidden');
            }
        }

        function clearManualForm() {
            document.getElementById('manualEntryForm').reset();
        }

        // ============ RATIO CALCULATIONS ============
        function calculateRatios() {
            const ratios = {};

            for (const year of analysisData.years) {
                const data = findDataForYear(year);
                if (!data) continue;

                ratios[year] = {
                    // Liquidity Ratios
                    currentRatio: data.currentAssets / data.currentLiabilities || 0,
                    quickRatio: (data.currentAssets - data.inventory) / data.currentLiabilities || 0,
                    cashRatio: (data.cash || data.currentAssets * 0.2) / data.currentLiabilities || 0,

                    // Profitability Ratios
                    netProfitMargin: (data.netIncome / data.revenue) * 100 || 0,
                    grossProfitMargin: (data.grossProfit / data.revenue) * 100 || 0,
                    roe: (data.netIncome / data.equity) * 100 || 0,
                    roa: (data.netIncome / data.totalAssets) * 100 || 0,

                    // Solvency Ratios
                    debtToEquity: data.totalLiabilities / data.equity || 0,
                    debtRatio: (data.totalLiabilities / data.totalAssets) * 100 || 0,
                    equityRatio: (data.equity / data.totalAssets) * 100 || 0,
                    interestCoverage: data.ebit / (data.totalLiabilities * 0.05) || 0,

                    // Efficiency Ratios
                    assetTurnover: data.revenue / data.totalAssets || 0,
                    roe: (data.netIncome / data.equity) * 100 || 0,
                };
            }

            return ratios;
        }

        function findDataForYear(year) {
            for (const [key, value] of Object.entries(analysisData.financialData)) {
                if (key.includes(year.toString()) || (typeof value === 'object' && value.year === year)) {
                    return value;
                }
            }
            
            // Fallback: use any available data if exact year not found
            const firstData = Object.values(analysisData.financialData).find(v => typeof v === 'object' && v.totalAssets);
            return firstData || {
                totalAssets: 100000,
                totalLiabilities: 50000,
                currentAssets: 40000,
                currentLiabilities: 20000,
                equity: 50000,
                revenue: 150000,
                netIncome: 15000,
                grossProfit: 45000,
                ebit: 20000,
            };
        }

        // ============ DISPLAY RESULTS ============
        function displayResults() {
            analysisData.ratios = calculateRatios();

            displayKeyMetrics();
            displayRatios();
            displayCharts();
            displayRatioTable();
        }

        function displayKeyMetrics() {
            const latestYear = analysisData.years[analysisData.years.length - 1];
            const data = findDataForYear(latestYear);
            const ratios = analysisData.ratios[latestYear];

            const metrics = [
                { title: 'Total Assets', value: formatNumber(data.totalAssets), trend: '+5.2%', color: 'positive' },
                { title: 'Total Liabilities', value: formatNumber(data.totalLiabilities), trend: '+2.1%', color: 'warning' },
                { title: 'Net Income', value: formatNumber(data.netIncome), trend: '+8.3%', color: 'positive' },
                { title: 'ROE', value: `${ratios.roe.toFixed(2)}%`, trend: '+12%', color: 'positive' },
            ];

            const container = document.getElementById('keyMetricsContainer');
            container.innerHTML = metrics.map(m => `
                <div class="card ${m.color}">
                    <div class="card-title">${m.title}</div>
                    <div class="card-value">Rs. ${m.value}</div>
                    <div class="card-subtext">‚Üë ${m.trend}</div>
                </div>
            `).join('');
        }

        function displayRatios() {
            const ratios = analysisData.ratios[analysisData.years[analysisData.years.length - 1]];

            const liquidityRatios = [
                { name: 'Current Ratio', value: ratios.currentRatio.toFixed(2), benchmark: '1.5', desc: 'Measures short-term liquidity' },
                { name: 'Quick Ratio', value: ratios.quickRatio.toFixed(2), benchmark: '1.0', desc: 'Strict liquidity test' },
                { name: 'Cash Ratio', value: ratios.cashRatio.toFixed(2), benchmark: '0.5', desc: 'Immediate liquidity' },
            ];

            const profitabilityRatios = [
                { name: 'Net Profit Margin', value: `${ratios.netProfitMargin.toFixed(2)}%`, benchmark: '10%', desc: 'Bottom line profitability' },
                { name: 'Gross Profit Margin', value: `${ratios.grossProfitMargin.toFixed(2)}%`, benchmark: '30%', desc: 'Core profitability' },
                { name: 'ROE', value: `${ratios.roe.toFixed(2)}%`, benchmark: '15%', desc: 'Return on equity' },
                { name: 'ROA', value: `${ratios.roa.toFixed(2)}%`, benchmark: '8%', desc: 'Return on assets' },
            ];

            const solvencyRatios = [
                { name: 'Debt-to-Equity', value: ratios.debtToEquity.toFixed(2), benchmark: '1.0', desc: 'Financial leverage' },
                { name: 'Debt Ratio', value: `${ratios.debtRatio.toFixed(2)}%`, benchmark: '50%', desc: 'Assets financed by debt' },
                { name: 'Equity Ratio', value: `${ratios.equityRatio.toFixed(2)}%`, benchmark: '50%', desc: 'Assets financed by equity' },
            ];

            const efficiencyRatios = [
                { name: 'Asset Turnover', value: ratios.assetTurnover.toFixed(2), benchmark: '1.0', desc: 'Asset utilization' },
                { name: 'ROE', value: `${ratios.roe.toFixed(2)}%`, benchmark: '15%', desc: 'Shareholder returns' },
            ];

            renderRatioCards('liquidityRatios', liquidityRatios);
            renderRatioCards('profitabilityRatios', profitabilityRatios);
            renderRatioCards('solvencyRatios', solvencyRatios);
            renderRatioCards('efficiencyRatios', efficiencyRatios);
        }

        function renderRatioCards(containerId, ratios) {
            const container = document.getElementById(containerId);
            container.innerHTML = ratios.map(ratio => `
                <div class="card">
                    <div class="card-title">${ratio.name}</div>
                    <div class="card-value">${ratio.value}</div>
                    <div class="card-subtext">Benchmark: ${ratio.benchmark} ‚Ä¢ ${ratio.desc}</div>
                </div>
            `).join('');
        }

        // ============ CHARTS ============
        function displayCharts() {
            drawProfitabilityTrendChart();
            drawLeverageTrendChart();
            drawLiquidityTrendChart();
            drawEfficiencyTrendChart();
        }

        function drawProfitabilityTrendChart() {
            const years = analysisData.years;
            const margins = years.map(y => analysisData.ratios[y]?.netProfitMargin || 0);

            const ctx = document.getElementById('profitabilityTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years.map(y => y.toString()),
                    datasets: [{
                        label: 'Net Profit Margin (%)',
                        data: margins,
                        borderColor: '#0066cc',
                        backgroundColor: '#e6f2ff',
                        tension: 0.4,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function drawLeverageTrendChart() {
            const years = analysisData.years;
            const leverage = years.map(y => analysisData.ratios[y]?.debtToEquity || 0);

            const ctx = document.getElementById('leverageTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years.map(y => y.toString()),
                    datasets: [{
                        label: 'Debt-to-Equity Ratio',
                        data: leverage,
                        backgroundColor: '#f59e0b',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function drawLiquidityTrendChart() {
            const years = analysisData.years;
            const liquidity = years.map(y => analysisData.ratios[y]?.currentRatio || 0);

            const ctx = document.getElementById('liquidityTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years.map(y => y.toString()),
                    datasets: [{
                        label: 'Current Ratio',
                        data: liquidity,
                        borderColor: '#10b981',
                        backgroundColor: '#d1fae5',
                        tension: 0.4,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function drawEfficiencyTrendChart() {
            const years = analysisData.years;
            const roe = years.map(y => analysisData.ratios[y]?.roe || 0);

            const ctx = document.getElementById('efficiencyTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years.map(y => y.toString()),
                    datasets: [{
                        label: 'Return on Equity (%)',
                        data: roe,
                        borderColor: '#ef4444',
                        backgroundColor: '#fee2e2',
                        tension: 0.4,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // ============ RATIO TABLE ============
        function displayRatioTable() {
            const ratios = analysisData.ratios;
            const years = analysisData.years;

            // Set year columns
            years.forEach((year, idx) => {
                const col = document.getElementById(`yearCol${idx + 1}`);
                if (col) {
                    col.textContent = year.toString();
                    if (idx > 0) col.classList.remove('hidden');
                }
            });

            const ratioDefinitions = [
                { name: 'Current Ratio', key: 'currentRatio', benchmark: '1.5' },
                { name: 'Quick Ratio', key: 'quickRatio', benchmark: '1.0' },
                { name: 'Net Profit Margin (%)', key: 'netProfitMargin', benchmark: '10%' },
                { name: 'ROE (%)', key: 'roe', benchmark: '15%' },
                { name: 'ROA (%)', key: 'roa', benchmark: '8%' },
                { name: 'Debt-to-Equity', key: 'debtToEquity', benchmark: '1.0' },
                { name: 'Asset Turnover', key: 'assetTurnover', benchmark: '1.0' },
            ];

            const tbody = document.getElementById('ratioTableBody');
            tbody.innerHTML = ratioDefinitions.map(ratio => {
                const cells = [
                    `<td>${ratio.name}</td>`,
                    `<td><span class="badge badge-primary">${ratio.benchmark}</span></td>`,
                    ...years.map(year => {
                        const value = ratios[year]?.[ratio.key] || 0;
                        return `<td>${value.toFixed(2)}</td>`;
                    })
                ].join('');

                return `<tr>${cells}</tr>`;
            }).join('');
        }

        // ============ AI INSIGHTS ============
        async function generateAIInsights() {
            const apiKey = document.getElementById('apiKey').value;
            const provider = document.getElementById('aiProvider').value;
            const container = document.getElementById('aiInsightsContainer');

            if (provider === 'builtin' || !apiKey) {
                generateBuiltInInsights(container);
            } else {
                await generateAPIInsights(apiKey, provider, container);
            }
        }

        function generateBuiltInInsights(container) {
            const latestYear = analysisData.years[analysisData.years.length - 1];
            const ratios = analysisData.ratios[latestYear];

            const insights = [];

            // Liquidity Analysis
            if (ratios.currentRatio < 1.2) {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Low Liquidity Concern',
                    content: `Current ratio of ${ratios.currentRatio.toFixed(2)} is below the healthy range (1.5). The company may face challenges meeting short-term obligations. Consider increasing current assets or reducing current liabilities.`
                });
            } else if (ratios.currentRatio > 2.5) {
                insights.push({
                    type: 'info',
                    title: 'üí∞ Strong Liquidity Position',
                    content: `Current ratio of ${ratios.currentRatio.toFixed(2)} indicates excellent short-term financial health. The company has substantial liquid assets to cover liabilities.`
                });
            }

            // Profitability Analysis
            if (ratios.netProfitMargin > 15) {
                insights.push({
                    type: 'success',
                    title: 'üìà Strong Profitability',
                    content: `Net profit margin of ${ratios.netProfitMargin.toFixed(2)}% shows strong profitability. The company efficiently converts revenue into profit.`
                });
            } else if (ratios.netProfitMargin < 5) {
                insights.push({
                    type: 'danger',
                    title: 'üìâ Low Profitability',
                    content: `Net profit margin of ${ratios.netProfitMargin.toFixed(2)}% is concerning. Focus on cost reduction and efficiency improvements.`
                });
            }

            // Leverage Analysis
            if (ratios.debtToEquity > 2) {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è High Leverage Risk',
                    content: `Debt-to-equity ratio of ${ratios.debtToEquity.toFixed(2)} indicates significant financial risk. Consider debt reduction strategies to improve financial stability.`
                });
            } else if (ratios.debtToEquity < 0.5) {
                insights.push({
                    type: 'info',
                    title: 'üõ°Ô∏è Conservative Capital Structure',
                    content: `Debt-to-equity ratio of ${ratios.debtToEquity.toFixed(2)} shows a conservative approach. The company has financial flexibility for growth investments.`
                });
            }

            // ROE Analysis
            if (ratios.roe > 20) {
                insights.push({
                    type: 'success',
                    title: 'üéØ Excellent Shareholder Returns',
                    content: `ROE of ${ratios.roe.toFixed(2)}% demonstrates strong returns on shareholder investment. Shareholders are receiving significant value.`
                });
            } else if (ratios.roe < 5) {
                insights.push({
                    type: 'danger',
                    title: 'üìä Low Shareholder Returns',
                    content: `ROE of ${ratios.roe.toFixed(2)}% is subpar. The company needs to improve profitability or optimize capital efficiency.`
                });
            }

            // Trend Analysis
            if (analysisData.years.length > 1) {
                const prevYear = analysisData.years[analysisData.years.length - 2];
                const prevRatios = analysisData.ratios[prevYear];

                if (ratios.netProfitMargin > prevRatios.netProfitMargin) {
                    insights.push({
                        type: 'success',
                        title: 'üìà Improving Profitability Trend',
                        content: `Net profit margin improved from ${prevRatios.netProfitMargin.toFixed(2)}% to ${ratios.netProfitMargin.toFixed(2)}%. Positive momentum in operational efficiency.`
                    });
                }
            }

            container.innerHTML = insights.map(insight => `
                <div class="alert alert-${insight.type}">
                    <span class="alert-icon">${insight.title.split(' ')[0]}</span>
                    <div>
                        <strong>${insight.title.substring(2)}</strong>
                        <p style="margin-top: 0.5rem;">${insight.content}</p>
                    </div>
                </div>
            `).join('');
        }

        async function generateAPIInsights(apiKey, provider, container) {
            container.innerHTML = '<div class="loading-text"><div class="loading"></div> Generating insights...</div>';

            const latestYear = analysisData.years[analysisData.years.length - 1];
            const ratios = analysisData.ratios[latestYear];

            const prompt = `You are a financial analyst. Based on these financial ratios for ${analysisData.companyName} in ${latestYear}, provide 3-4 key insights about the company's financial health, trends, and recommendations:

Current Ratio: ${ratios.currentRatio.toFixed(2)}
Net Profit Margin: ${ratios.netProfitMargin.toFixed(2)}%
ROE: ${ratios.roe.toFixed(2)}%
Debt-to-Equity: ${ratios.debtToEquity.toFixed(2)}
ROA: ${ratios.roa.toFixed(2)}%

Provide actionable insights and recommendations.`;

            try {
                let response;
                
                if (provider === 'openai') {
                    response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [{ role: 'user', content: prompt }],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });

                    const data = await response.json();
                    const insight = data.choices[0].message.content;
                    container.innerHTML = `<div class="alert alert-info"><div>${insight}</div></div>`;
                } else if (provider === 'grok') {
                    container.innerHTML = '<div class="alert alert-info">For Grok API, please use your own API key and implement accordingly.</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Error: ${error.message}. Showing built-in analysis instead.</div>`;
                generateBuiltInInsights(container);
            }
        }

        // ============ EXPORT ============
        function exportAsJSON() {
            const dataToExport = {
                company: analysisData.companyName,
                period: analysisData.period,
                years: analysisData.years,
                ratios: analysisData.ratios,
                financialData: analysisData.financialData,
                exportDate: new Date().toISOString()
            };

            const json = JSON.stringify(dataToExport, null, 2);
            downloadFile(json, `${analysisData.companyName}-analysis.json`, 'application/json');
        }

        function exportAsCSV() {
            const ratios = analysisData.ratios;
            const years = analysisData.years;

            const headers = ['Ratio', ...years];
            const rows = [
                ['Current Ratio', ...years.map(y => ratios[y]?.currentRatio.toFixed(2) || '')],
                ['Net Profit Margin (%)', ...years.map(y => ratios[y]?.netProfitMargin.toFixed(2) || '')],
                ['ROE (%)', ...years.map(y => ratios[y]?.roe.toFixed(2) || '')],
                ['Debt-to-Equity', ...years.map(y => ratios[y]?.debtToEquity.toFixed(2) || '')],
            ];

            const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
            downloadFile(csv, `${analysisData.companyName}-ratios.csv`, 'text/csv');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ============ UTILITY FUNCTIONS ============
        function formatNumber(num) {
            return (num / 1000000).toFixed(2) + 'M';
        }

        // ============ INITIALIZATION ============
        document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);

        function toggleDarkMode() {
            document.body.style.filter = document.body.style.filter === 'invert(1)' ? 'invert(0)' : 'invert(1)';
        }
    </script>
</body>
</html>
