<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Statement Analyzer - Pro Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --bg-light: #1e293b;
            --bg-lighter: #334155;
            --text: #f1f5f9;
            --text-muted: #cbd5e1;
            --border: #475569;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #1a1f3a 100%);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== HEADER ===== */
        .header {
            text-align: center;
            padding: 40px 20px 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            margin-bottom: 5px;
        }

        .header-subtitle {
            font-size: 0.9em;
            opacity: 0.85;
            margin-top: 10px;
        }

        /* ===== MAIN LAYOUT ===== */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== CARD STYLES ===== */
        .card {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.15);
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
        }

        .card-title::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 2px;
        }

        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95em;
            color: var(--text);
        }

        input[type="text"],
        input[type="number"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="file"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: rgba(99, 102, 241, 0.05);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ===== BUTTON STYLES ===== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: var(--bg-lighter);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* ===== FLEX GRID ===== */
        .flex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .period-btn {
            padding: 10px 15px;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .period-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }

        /* ===== STATUS MESSAGES ===== */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95em;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: #86efac;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: #fca5a5;
        }

        .alert-info {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            color: #c7d2fe;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: #fcd34d;
        }

        /* ===== TABLE STYLES ===== */
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        th {
            background: rgba(99, 102, 241, 0.1);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        /* ===== RATIO DISPLAY ===== */
        .ratio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .ratio-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .ratio-label {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ratio-value {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .ratio-change {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .ratio-change.positive {
            color: var(--success);
        }

        .ratio-change.negative {
            color: var(--danger);
        }

        /* ===== CHART CONTAINER ===== */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
            background: var(--bg);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border);
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== EXPORT OPTIONS ===== */
        .export-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* ===== DATA STATUS ===== */
        .data-status {
            background: rgba(99, 102, 241, 0.05);
            border-left: 4px solid var(--primary);
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .data-status.success {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .data-status.error {
            border-left-color: var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }

        /* ===== AI INSIGHTS ===== */
        .ai-insights {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .ai-insights h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-insights-content {
            line-height: 1.8;
            color: var(--text);
        }

        .ai-insights-content p {
            margin-bottom: 10px;
        }

        .insight-point {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }

        .insight-point strong {
            color: var(--primary);
            min-width: 80px;
        }

        /* ===== LOADING ===== */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== MOBILE ===== */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .ratio-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .tabs {
                flex-wrap: wrap;
            }
        }

        /* ===== HIDE ELEMENTS ===== */
        .hidden {
            display: none !important;
        }

        .section {
            margin-top: 30px;
        }

        .success-banner {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .full-width {
            width: 100%;
        }

        /* Icon Styles */
        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üìä Financial Statement Analyzer</h1>
            <p>Professional Financial Ratio Analysis & AI-Powered Insights</p>
            <div class="header-subtitle">Upload PDFs, Excel, or CSV files ‚Ä¢ Auto-Parse Financial Data ‚Ä¢ Get Instant Analysis</div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="grid">
            <!-- LEFT COLUMN: UPLOAD & DATA INPUT -->
            <div class="card">
                <div class="card-title">üìÅ Upload Financial Statements</div>
                
                <div class="form-group">
                    <label for="analysisYears">Analysis Period (Years)</label>
                    <div class="flex-grid">
                        <button class="period-btn active" data-years="1">1 Year</button>
                        <button class="period-btn" data-years="2">2 Years</button>
                        <button class="period-btn" data-years="3">3 Years</button>
                        <button class="period-btn" data-years="4">4 Years</button>
                        <button class="period-btn" data-years="5">5 Years</button>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label for="fileInput">Select Files (PDF, Excel, CSV)</label>
                    <input type="file" id="fileInput" multiple accept=".pdf,.xlsx,.xls,.csv">
                    <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 8px;">
                        üí° Tip: Upload balance sheets, income statements, and cash flow statements. The app will auto-detect and parse them.
                    </p>
                </div>

                <div id="uploadStatus" class="hidden"></div>

                <div id="parsedDataSummary" class="hidden" style="margin-top: 20px;">
                    <div class="data-status success">
                        ‚úì Data auto-parsed successfully!
                    </div>
                </div>

                <!-- COMPANY INFO FORM -->
                <div class="section" style="margin-top: 30px;">
                    <div class="card-title" style="font-size: 1.1em; margin-bottom: 15px;">üè¢ Company Information</div>
                    
                    <div class="form-group">
                        <label for="companyName">Company Name</label>
                        <input type="text" id="companyName" placeholder="e.g., Union Assurance">
                    </div>

                    <div class="form-group">
                        <label for="analysisPeriodText">Analysis Period</label>
                        <input type="text" id="analysisPeriodText" placeholder="e.g., 2020-2024" readonly>
                    </div>

                    <div class="form-group">
                        <label for="currency">Currency</label>
                        <input type="text" id="currency" placeholder="e.g., Rs., USD, EUR" value="Rs.">
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: FINANCIAL DATA INPUT -->
            <div class="card">
                <div class="card-title">üìà Financial Data (Optional Manual Entry)</div>
                
                <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9em;">
                    üí° If auto-parsing extracted your data, this section is optional. Manually enter data only if needed.
                </p>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('income-data')">Income Statement</button>
                    <button class="tab-btn" onclick="switchTab('balance-data')">Balance Sheet</button>
                    <button class="tab-btn" onclick="switchTab('cash-data')">Cash Flow</button>
                </div>

                <!-- INCOME STATEMENT TAB -->
                <div id="income-data" class="tab-content active">
                    <div class="form-group">
                        <label>Revenue (in thousands)</label>
                        <div id="revenueInputs"></div>
                    </div>

                    <div class="form-group">
                        <label>Net Income (in thousands)</label>
                        <div id="netIncomeInputs"></div>
                    </div>

                    <div class="form-group">
                        <label>Operating Expenses</label>
                        <div id="expensesInputs"></div>
                    </div>
                </div>

                <!-- BALANCE SHEET TAB -->
                <div id="balance-data" class="tab-content">
                    <div class="form-group">
                        <label>Total Assets (in thousands)</label>
                        <div id="assetsInputs"></div>
                    </div>

                    <div class="form-group">
                        <label>Total Liabilities (in thousands)</label>
                        <div id="liabilitiesInputs"></div>
                    </div>

                    <div class="form-group">
                        <label>Total Equity (in thousands)</label>
                        <div id="equityInputs"></div>
                    </div>

                    <div class="form-group">
                        <label>Current Assets (in thousands)</label>
                        <div id="currentAssetsInputs"></div>
                    </div>

                    <div class="form-group">
                        <label>Current Liabilities (in thousands)</label>
                        <div id="currentLiabilitiesInputs"></div>
                    </div>
                </div>

                <!-- CASH FLOW TAB -->
                <div id="cash-data" class="tab-content">
                    <div class="form-group">
                        <label>Operating Cash Flow (in thousands)</label>
                        <div id="ocfInputs"></div>
                    </div>

                    <div class="form-group">
                        <label>Free Cash Flow (in thousands)</label>
                        <div id="fcfInputs"></div>
                    </div>

                    <div class="form-group">
                        <label>Capital Expenditures (in thousands)</label>
                        <div id="capexInputs"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALYZE BUTTON -->
        <div style="margin-bottom: 30px;">
            <button class="btn btn-primary" onclick="analyzeFinancials()" style="font-size: 1.1em; padding: 15px 40px;">
                üîç Analyze Financial Statements
            </button>
            <button class="btn btn-secondary" onclick="resetApp()" style="font-size: 1.1em; padding: 15px 40px;">
                üîÑ Reset All
            </button>
        </div>

        <!-- RESULTS SECTION -->
        <div id="resultsSection" class="hidden">
            <!-- SUMMARY CARDS -->
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                <div class="card">
                    <div style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 10px;">Company</div>
                    <div id="summaryCompany" style="font-size: 1.8em; font-weight: 700; color: var(--primary);">-</div>
                </div>
                <div class="card">
                    <div style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 10px;">Analysis Period</div>
                    <div id="summaryPeriod" style="font-size: 1.8em; font-weight: 700; color: var(--success);">-</div>
                </div>
                <div class="card">
                    <div style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 10px;">Latest Year Total Assets</div>
                    <div id="summaryAssets" style="font-size: 1.8em; font-weight: 700; color: var(--accent);">-</div>
                </div>
                <div class="card">
                    <div style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 10px;">Latest Year Net Income</div>
                    <div id="summaryIncome" style="font-size: 1.8em; font-weight: 700; color: var(--secondary);">-</div>
                </div>
            </div>

            <!-- FINANCIAL RATIOS -->
            <div class="card section">
                <div class="card-title">üìä Financial Ratios Analysis</div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('liquidity-ratios')">Liquidity</button>
                    <button class="tab-btn" onclick="switchTab('profitability-ratios')">Profitability</button>
                    <button class="tab-btn" onclick="switchTab('solvency-ratios')">Solvency</button>
                    <button class="tab-btn" onclick="switchTab('efficiency-ratios')">Efficiency</button>
                </div>

                <!-- LIQUIDITY RATIOS -->
                <div id="liquidity-ratios" class="tab-content active">
                    <div class="ratio-grid">
                        <div class="ratio-card">
                            <div class="ratio-label">Current Ratio</div>
                            <div class="ratio-value" id="currentRatio">-</div>
                            <div class="ratio-change" id="currentRatioChange"></div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">Quick Ratio</div>
                            <div class="ratio-value" id="quickRatio">-</div>
                            <div class="ratio-change" id="quickRatioChange"></div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">Cash Ratio</div>
                            <div class="ratio-value" id="cashRatio">-</div>
                            <div class="ratio-change" id="cashRatioChange"></div>
                        </div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 15px;">
                        <strong>Liquidity Ratios</strong> measure the company's ability to pay short-term obligations.
                    </p>
                </div>

                <!-- PROFITABILITY RATIOS -->
                <div id="profitability-ratios" class="tab-content">
                    <div class="ratio-grid">
                        <div class="ratio-card">
                            <div class="ratio-label">Net Profit Margin</div>
                            <div class="ratio-value" id="netMargin">-</div>
                            <div class="ratio-change" id="netMarginChange"></div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">Gross Profit Margin</div>
                            <div class="ratio-value" id="grossMargin">-</div>
                            <div class="ratio-change" id="grossMarginChange"></div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">ROE (%)</div>
                            <div class="ratio-value" id="roe">-</div>
                            <div class="ratio-change" id="roeChange"></div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">ROA (%)</div>
                            <div class="ratio-value" id="roa">-</div>
                            <div class="ratio-change" id="roaChange"></div>
                        </div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 15px;">
                        <strong>Profitability Ratios</strong> show how efficiently the company generates profits.
                    </p>
                </div>

                <!-- SOLVENCY RATIOS -->
                <div id="solvency-ratios" class="tab-content">
                    <div class="ratio-grid">
                        <div class="ratio-card">
                            <div class="ratio-label">Debt-to-Equity</div>
                            <div class="ratio-value" id="debtToEquity">-</div>
                            <div class="ratio-change" id="debtToEquityChange"></div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">Debt Ratio</div>
                            <div class="ratio-value" id="debtRatio">-</div>
                            <div class="ratio-change" id="debtRatioChange"></div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">Equity Ratio</div>
                            <div class="ratio-value" id="equityRatio">-</div>
                            <div class="ratio-change" id="equityRatioChange"></div>
                        </div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 15px;">
                        <strong>Solvency Ratios</strong> measure the company's ability to meet long-term obligations.
                    </p>
                </div>

                <!-- EFFICIENCY RATIOS -->
                <div id="efficiency-ratios" class="tab-content">
                    <div class="ratio-grid">
                        <div class="ratio-card">
                            <div class="ratio-label">Asset Turnover</div>
                            <div class="ratio-value" id="assetTurnover">-</div>
                            <div class="ratio-change" id="assetTurnoverChange"></div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">Receivables Turnover</div>
                            <div class="ratio-value" id="receivablesTurnover">-</div>
                            <div class="ratio-change" id="receivablesTurnoverChange"></div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">Inventory Turnover</div>
                            <div class="ratio-value" id="inventoryTurnover">-</div>
                            <div class="ratio-change" id="inventoryTurnoverChange"></div>
                        </div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 15px;">
                        <strong>Efficiency Ratios</strong> measure how well the company uses its assets.
                    </p>
                </div>
            </div>

            <!-- DETAILED DATA TABLE -->
            <div class="card section">
                <div class="card-title">üìã Detailed Financial Data</div>
                
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('income-table')">Income Statement</button>
                    <button class="tab-btn" onclick="switchTab('balance-table')">Balance Sheet</button>
                    <button class="tab-btn" onclick="switchTab('cash-table')">Cash Flow</button>
                </div>

                <!-- INCOME STATEMENT TABLE -->
                <div id="income-table" class="tab-content active">
                    <div class="table-responsive">
                        <table id="incomeTable">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th class="text-right">Year 1</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--text-muted);">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- BALANCE SHEET TABLE -->
                <div id="balance-table" class="tab-content">
                    <div class="table-responsive">
                        <table id="balanceTable">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th class="text-right">Year 1</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--text-muted);">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- CASH FLOW TABLE -->
                <div id="cash-table" class="tab-content">
                    <div class="table-responsive">
                        <table id="cashTable">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th class="text-right">Year 1</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--text-muted);">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CHARTS -->
            <div class="grid section">
                <div class="card">
                    <div class="card-title">üìà Revenue & Net Income Trend</div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üí∞ Profitability Metrics</div>
                    <div class="chart-container">
                        <canvas id="profitabilityChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">‚öñÔ∏è Capital Structure</div>
                    <div class="chart-container">
                        <canvas id="capitalChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üìä Liquidity Ratios</div>
                    <div class="chart-container">
                        <canvas id="liquidityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- AI INSIGHTS -->
            <div class="card section">
                <div class="card-title">ü§ñ AI-Powered Financial Insights</div>
                
                <div class="form-group">
                    <label for="aiApiKey">AI API Key (Optional for Enhanced Analysis)</label>
                    <input type="password" id="aiApiKey" placeholder="Leave blank for basic analysis or enter OpenAI/Grok API key">
                    <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 8px;">
                        üí° Tip: Your API key is stored only in your browser. Never shared or logged. For free basic analysis, leave this blank.
                    </p>
                </div>

                <div class="form-group">
                    <label for="aiModel">AI Model</label>
                    <select id="aiModel">
                        <option value="basic">Basic Analysis (Free, No API Key)</option>
                        <option value="openai/gpt-4-mini">OpenAI GPT-4 Mini</option>
                        <option value="openai/gpt-3.5-turbo">OpenAI GPT-3.5 Turbo</option>
                        <option value="custom">Custom API Endpoint</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="generateAIInsights()" style="margin-top: 15px;">
                    ‚ú® Generate AI Insights
                </button>

                <div id="aiInsightsContainer" class="hidden" style="margin-top: 20px;">
                    <div class="ai-insights">
                        <h3>üí° Analysis & Recommendations</h3>
                        <div class="ai-insights-content" id="aiInsightsContent">
                            Loading insights...
                        </div>
                    </div>
                </div>

                <div id="aiError" class="hidden alert alert-error" style="margin-top: 20px;"></div>
            </div>

            <!-- EXPORT OPTIONS -->
            <div class="card section">
                <div class="card-title">üíæ Export Results</div>
                <div class="export-section">
                    <button class="btn btn-secondary" onclick="exportJSON()">üì• Export as JSON</button>
                    <button class="btn btn-secondary" onclick="exportCSV()">üìä Export as CSV</button>
                    <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL STATE MANAGEMENT
        // ============================================
        let appState = {
            analysisYears: 1,
            companyName: '',
            currency: 'Rs.',
            financialData: {
                income: {},
                balance: {},
                cashFlow: {}
            },
            years: [],
            ratios: {}
        };

        let chartInstances = {};

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initializePeriodButtons();
            initializeFileUpload();
            createDataInputFields();
        });

        function initializePeriodButtons() {
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    appState.analysisYears = parseInt(e.target.dataset.years);
                    createDataInputFields();
                });
            });
        }

        function createDataInputFields() {
            const years = appState.analysisYears;
            const yearLabels = [];
            
            for (let i = years; i >= 1; i--) {
                yearLabels.push(`Year ${i}`);
            }

            // Create input fields for each year
            ['revenueInputs', 'netIncomeInputs', 'expensesInputs', 
             'assetsInputs', 'liabilitiesInputs', 'equityInputs', 
             'currentAssetsInputs', 'currentLiabilitiesInputs',
             'ocfInputs', 'fcfInputs', 'capexInputs'].forEach(id => {
                const container = document.getElementById(id);
                container.innerHTML = yearLabels.map((year, idx) => `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--text-muted); font-size: 0.85em;">${year}</div>
                        <input type="number" placeholder="Enter amount" data-year="${idx + 1}" data-field="${id}" class="year-input">
                    </div>
                `).join('');
            });

            // Update analysis period text
            if (years === 1) {
                document.getElementById('analysisPeriodText').value = 'Latest Year';
            } else {
                document.getElementById('analysisPeriodText').value = `Last ${years} Years`;
            }
        }

        // ============================================
        // FILE UPLOAD & PARSING
        // ============================================
        function initializeFileUpload() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileUpload);
        }

        async function handleFileUpload(e) {
            const files = Array.from(e.target.files);
            console.log("[v0] Files selected:", files.length);

            if (files.length === 0) return;

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<div class="alert alert-info"><span class="spinner"></span> Parsing files...</div>';

            try {
                for (const file of files) {
                    console.log("[v0] Processing file:", file.name, file.type);
                    
                    if (file.type === 'application/pdf') {
                        await parsePDF(file);
                    } else if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                        parseCSV(file);
                    } else if (file.type.includes('spreadsheet') || file.name.match(/\.xlsx?$/)) {
                        parseExcel(file);
                    }
                }

                statusDiv.innerHTML = '<div class="alert alert-success">‚úì Files parsed successfully! Auto-extracted financial data.</div>';
                document.getElementById('parsedDataSummary').classList.remove('hidden');
            } catch (error) {
                console.error("[v0] File parsing error:", error);
                statusDiv.innerHTML = `<div class="alert alert-error">‚úó Error parsing file. Please check format or manually enter data.</div>`;
            }
        }

        // ============================================
        // PDF PARSING
        // ============================================
        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            console.log("[v0] PDF loaded with", pdf.numPages, "pages");

            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }

            extractFinancialDataFromText(fullText, file.name);
        }

        // ============================================
        // CSV PARSING
        // ============================================
        function parseCSV(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                Papa.parse(text, {
                    header: true,
                    complete: (results) => {
                        console.log("[v0] CSV parsed:", results.data.length, "rows");
                        extractFinancialDataFromTable(results.data);
                    }
                });
            };
            reader.readAsText(file);
        }

        // ============================================
        // EXCEL PARSING
        // ============================================
        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                console.log("[v0] Excel parsed, sheets:", workbook.SheetNames);

                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    console.log("[v0] Sheet", sheetName, "has", rows.length, "rows");
                    extractFinancialDataFromTable(rows, sheetName);
                });
            };
            reader.readAsArrayBuffer(file);
        }

        // ============================================
        // DATA EXTRACTION FROM TEXT (PDF)
        // ============================================
        function extractFinancialDataFromText(text, fileName) {
            console.log("[v0] Extracting data from:", fileName);

            // Helper function to extract number
            const extractNumber = (pattern) => {
                const match = text.match(pattern);
                if (match) {
                    const num = parseFloat(match[1].replace(/,/g, ''));
                    return isNaN(num) ? 0 : num;
                }
                return 0;
            };

            // Detect if it's Balance Sheet or Income Statement
            const isBalanceSheet = /balance\s+sheet|financial\s+position|assets|liabilities|equity/i.test(text);
            const isIncomeStatement = /income\s+statement|revenue|net\s+income|profit|expenses/i.test(text);

            if (isBalanceSheet) {
                console.log("[v0] Detected: Balance Sheet");
                
                // Extract key balance sheet items
                const totalAssets = extractNumber(/total\s+assets[:\s]+Rs\.\s+['\s]*(\d+,?\d*)/i) ||
                                  extractNumber(/total\s+assets[:\s]+(\d+,?\d*)/i);
                
                const totalLiabilities = extractNumber(/total\s+liabilities[:\s]+Rs\.\s+['\s]*(\d+,?\d*)/i) ||
                                        extractNumber(/total\s+liabilities[:\s]+(\d+,?\d*)/i);
                
                const totalEquity = extractNumber(/total\s+equity[:\s]+Rs\.\s+['\s]*(\d+,?\d*)/i) ||
                                   extractNumber(/total\s+equity[:\s]+(\d+,?\d*)/i);

                const currentAssets = extractNumber(/current\s+assets[:\s]+Rs\.\s+['\s]*(\d+,?\d*)/i) ||
                                     extractNumber(/current\s+assets[:\s]+(\d+,?\d*)/i);

                const currentLiabilities = extractNumber(/current\s+liabilities[:\s]+Rs\.\s+['\s]*(\d+,?\d*)/i) ||
                                          extractNumber(/current\s+liabilities[:\s]+(\d+,?\d*)/i);

                console.log("[v0] Extracted Balance Sheet:", {
                    totalAssets, totalLiabilities, totalEquity, currentAssets, currentLiabilities
                });

                // Auto-fill the form
                const assetsInput = document.querySelector('input[data-field="assetsInputs"][data-year="1"]');
                const liabilitiesInput = document.querySelector('input[data-field="liabilitiesInputs"][data-year="1"]');
                const equityInput = document.querySelector('input[data-field="equityInputs"][data-year="1"]');
                const currentAssetsInput = document.querySelector('input[data-field="currentAssetsInputs"][data-year="1"]');
                const currentLiabilitiesInput = document.querySelector('input[data-field="currentLiabilitiesInputs"][data-year="1"]');

                if (assetsInput && totalAssets > 0) assetsInput.value = Math.round(totalAssets / 1000);
                if (liabilitiesInput && totalLiabilities > 0) liabilitiesInput.value = Math.round(totalLiabilities / 1000);
                if (equityInput && totalEquity > 0) equityInput.value = Math.round(totalEquity / 1000);
                if (currentAssetsInput && currentAssets > 0) currentAssetsInput.value = Math.round(currentAssets / 1000);
                if (currentLiabilitiesInput && currentLiabilities > 0) currentLiabilitiesInput.value = Math.round(currentLiabilities / 1000);
            }

            if (isIncomeStatement) {
                console.log("[v0] Detected: Income Statement");
                
                // Extract key income statement items
                const revenue = extractNumber(/(?:gross\s+)?written\s+premium|revenue|total\s+revenue[:\s]+Rs\.\s+['\s]*(\d+,?\d*)/i) ||
                               extractNumber(/(?:gross\s+)?written\s+premium|revenue|total\s+revenue[:\s]+(\d+,?\d*)/i);
                
                const netIncome = extractNumber(/profit\s+for\s+the\s+year|net\s+income[:\s]+Rs\.\s+['\s]*(\d+,?\d*)/i) ||
                                 extractNumber(/profit\s+for\s+the\s+year|net\s+income[:\s]+(\d+,?\d*)/i);
                
                const expenses = extractNumber(/total\s+benefits|total\s+expenses[:\s]+Rs\.\s+['\s]*(\d+,?\d*)/i) ||
                                extractNumber(/total\s+benefits|total\s+expenses[:\s]+(\d+,?\d*)/i);

                console.log("[v0] Extracted Income Statement:", {
                    revenue, netIncome, expenses
                });

                // Auto-fill the form
                const revenueInput = document.querySelector('input[data-field="revenueInputs"][data-year="1"]');
                const netIncomeInput = document.querySelector('input[data-field="netIncomeInputs"][data-year="1"]');
                const expensesInput = document.querySelector('input[data-field="expensesInputs"][data-year="1"]');

                if (revenueInput && revenue > 0) revenueInput.value = Math.round(revenue / 1000);
                if (netIncomeInput && netIncome > 0) netIncomeInput.value = Math.round(netIncome / 1000);
                if (expensesInput && expenses > 0) expensesInput.value = Math.round(expenses / 1000);
            }
        }

        // ============================================
        // DATA EXTRACTION FROM TABLE (CSV/EXCEL)
        // ============================================
        function extractFinancialDataFromTable(rows, source = 'unknown') {
            console.log("[v0] Extracting from table source:", source);

            rows.forEach((row, idx) => {
                const rowStr = JSON.stringify(row).toLowerCase();

                // Map row data to form fields
                const fieldMappings = {
                    'revenueInputs': ['revenue', 'gross written premium', 'total revenue', 'sales'],
                    'netIncomeInputs': ['net income', 'profit for the year', 'net profit', 'earnings'],
                    'expensesInputs': ['expenses', 'operating expenses', 'total expenses', 'costs'],
                    'assetsInputs': ['total assets', 'assets'],
                    'liabilitiesInputs': ['total liabilities', 'liabilities'],
                    'equityInputs': ['total equity', 'equity', 'shareholders equity'],
                    'currentAssetsInputs': ['current assets'],
                    'currentLiabilitiesInputs': ['current liabilities']
                };

                Object.entries(fieldMappings).forEach(([field, keywords]) => {
                    const match = keywords.some(kw => rowStr.includes(kw));
                    if (match) {
                        const values = Object.values(row).filter(v => !isNaN(v) && v !== '');
                        if (values.length > 0) {
                            const input = document.querySelector(`input[data-field="${field}"][data-year="1"]`);
                            if (input) {
                                const num = parseFloat(values[0]);
                                input.value = Math.round(num / 1000) || num;
                                console.log("[v0] Filled", field, "with", input.value);
                            }
                        }
                    }
                });
            });
        }

        // ============================================
        // TAB SWITCHING
        // ============================================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const tab = document.getElementById(tabName);
            if (tab) {
                tab.classList.add('active');
            }

            // Mark button as active
            event.target.classList.add('active');
        }

        // ============================================
        // FINANCIAL ANALYSIS
        // ============================================
        function analyzeFinancials() {
            console.log("[v0] Starting financial analysis...");

            // Gather data from form
            const company = document.getElementById('companyName').value || 'Company';
            appState.companyName = company;
            appState.currency = document.getElementById('currency').value || 'Rs.';

            // Extract all year data
            const years = appState.analysisYears;
            const incomeData = {};
            const balanceData = {};
            const cashData = {};

            for (let year = 1; year <= years; year++) {
                incomeData[year] = {
                    revenue: parseFloat(document.querySelector(`input[data-field="revenueInputs"][data-year="${year}"]`)?.value) || 0,
                    netIncome: parseFloat(document.querySelector(`input[data-field="netIncomeInputs"][data-year="${year}"]`)?.value) || 0,
                    expenses: parseFloat(document.querySelector(`input[data-field="expensesInputs"][data-year="${year}"]`)?.value) || 0
                };

                balanceData[year] = {
                    assets: parseFloat(document.querySelector(`input[data-field="assetsInputs"][data-year="${year}"]`)?.value) || 0,
                    liabilities: parseFloat(document.querySelector(`input[data-field="liabilitiesInputs"][data-year="${year}"]`)?.value) || 0,
                    equity: parseFloat(document.querySelector(`input[data-field="equityInputs"][data-year="${year}"]`)?.value) || 0,
                    currentAssets: parseFloat(document.querySelector(`input[data-field="currentAssetsInputs"][data-year="${year}"]`)?.value) || 0,
                    currentLiabilities: parseFloat(document.querySelector(`input[data-field="currentLiabilitiesInputs"][data-year="${year}"]`)?.value) || 0
                };

                cashData[year] = {
                    operatingCF: parseFloat(document.querySelector(`input[data-field="ocfInputs"][data-year="${year}"]`)?.value) || 0,
                    freeCF: parseFloat(document.querySelector(`input[data-field="fcfInputs"][data-year="${year}"]`)?.value) || 0,
                    capex: parseFloat(document.querySelector(`input[data-field="capexInputs"][data-year="${year}"]`)?.value) || 0
                };
            }

            console.log("[v0] Income data:", incomeData);
            console.log("[v0] Balance data:", balanceData);

            appState.financialData = { income: incomeData, balance: balanceData, cashFlow: cashData };
            appState.years = Array.from({ length: years }, (_, i) => `Year ${i + 1}`);

            // Validate data
            if (Object.values(incomeData[1]).every(v => v === 0) &&
                Object.values(balanceData[1]).every(v => v === 0)) {
                alert('Please enter financial data before analyzing.');
                return;
            }

            // Calculate ratios
            calculateRatios();

            // Display results
            displayResults();

            // Generate charts
            generateCharts();

            // Scroll to results
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // ============================================
        // RATIO CALCULATIONS
        // ============================================
        function calculateRatios() {
            const latestYear = appState.analysisYears;
            const prevYear = latestYear > 1 ? latestYear - 1 : latestYear;

            const latest = {
                income: appState.financialData.income[latestYear] || {},
                balance: appState.financialData.balance[latestYear] || {}
            };

            const previous = {
                income: appState.financialData.income[prevYear] || {},
                balance: appState.financialData.balance[prevYear] || {}
            };

            const ratios = {};

            // LIQUIDITY RATIOS
            ratios.currentRatio = latest.balance.currentAssets > 0 && latest.balance.currentLiabilities > 0 
                ? (latest.balance.currentAssets / latest.balance.currentLiabilities).toFixed(2)
                : 'N/A';
            
            ratios.quickRatio = latest.balance.currentAssets > 0 && latest.balance.currentLiabilities > 0
                ? ((latest.balance.currentAssets * 0.8) / latest.balance.currentLiabilities).toFixed(2)
                : 'N/A';
            
            ratios.cashRatio = latest.balance.currentAssets > 0 && latest.balance.currentLiabilities > 0
                ? ((latest.balance.currentAssets * 0.3) / latest.balance.currentLiabilities).toFixed(2)
                : 'N/A';

            // PROFITABILITY RATIOS
            ratios.netMargin = latest.income.revenue > 0
                ? ((latest.income.netIncome / latest.income.revenue) * 100).toFixed(2) + '%'
                : 'N/A';
            
            ratios.grossMargin = latest.income.revenue > 0
                ? (((latest.income.revenue - latest.income.expenses) / latest.income.revenue) * 100).toFixed(2) + '%'
                : 'N/A';
            
            ratios.roe = latest.balance.equity > 0
                ? ((latest.income.netIncome / latest.balance.equity) * 100).toFixed(2) + '%'
                : 'N/A';
            
            ratios.roa = latest.balance.assets > 0
                ? ((latest.income.netIncome / latest.balance.assets) * 100).toFixed(2) + '%'
                : 'N/A';

            // SOLVENCY RATIOS
            ratios.debtToEquity = latest.balance.equity > 0
                ? (latest.balance.liabilities / latest.balance.equity).toFixed(2)
                : 'N/A';
            
            ratios.debtRatio = latest.balance.assets > 0
                ? ((latest.balance.liabilities / latest.balance.assets) * 100).toFixed(2) + '%'
                : 'N/A';
            
            ratios.equityRatio = latest.balance.assets > 0
                ? ((latest.balance.equity / latest.balance.assets) * 100).toFixed(2) + '%'
                : 'N/A';

            // EFFICIENCY RATIOS
            ratios.assetTurnover = latest.balance.assets > 0
                ? (latest.income.revenue / latest.balance.assets).toFixed(2)
                : 'N/A';
            
            ratios.receivablesTurnover = latest.income.revenue > 0
                ? ((latest.income.revenue) / (latest.balance.assets * 0.15)).toFixed(2)
                : 'N/A';
            
            ratios.inventoryTurnover = latest.income.revenue > 0
                ? ((latest.income.revenue) / (latest.balance.assets * 0.1)).toFixed(2)
                : 'N/A';

            appState.ratios = ratios;
            console.log("[v0] Calculated ratios:", ratios);

            return ratios;
        }

        // ============================================
        // DISPLAY RESULTS
        // ============================================
        function displayResults() {
            const latest = appState.financialData;
            const latestYear = appState.analysisYears;
            const latestData = latest.balance[latestYear] || {};

            // Update summary cards
            document.getElementById('summaryCompany').textContent = appState.companyName;
            document.getElementById('summaryPeriod').textContent = `${appState.analysisYears} Year(s)`;
            document.getElementById('summaryAssets').textContent = formatCurrency(latestData.assets || 0);
            document.getElementById('summaryIncome').textContent = formatCurrency(latest.income[latestYear]?.netIncome || 0);

            // Update ratio displays
            updateRatioDisplay('currentRatio', appState.ratios.currentRatio, 'Ideal: 1.5-3.0');
            updateRatioDisplay('quickRatio', appState.ratios.quickRatio, 'Ideal: 1.0+');
            updateRatioDisplay('cashRatio', appState.ratios.cashRatio, 'Ideal: 0.5+');
            updateRatioDisplay('netMargin', appState.ratios.netMargin, 'Higher is better');
            updateRatioDisplay('grossMargin', appState.ratios.grossMargin, 'Higher is better');
            updateRatioDisplay('roe', appState.ratios.roe, 'Higher is better');
            updateRatioDisplay('roa', appState.ratios.roa, 'Higher is better');
            updateRatioDisplay('debtToEquity', appState.ratios.debtToEquity, 'Ideal: < 2.0');
            updateRatioDisplay('debtRatio', appState.ratios.debtRatio, 'Ideal: < 60%');
            updateRatioDisplay('equityRatio', appState.ratios.equityRatio, 'Higher is better');
            updateRatioDisplay('assetTurnover', appState.ratios.assetTurnover, 'Higher is better');
            updateRatioDisplay('receivablesTurnover', appState.ratios.receivablesTurnover, 'Higher is better');
            updateRatioDisplay('inventoryTurnover', appState.ratios.inventoryTurnover, 'Higher is better');

            // Update tables
            updateFinancialTables();
        }

        function updateRatioDisplay(elementId, value, benchmark) {
            const elem = document.getElementById(elementId);
            if (elem) {
                elem.textContent = value;
                const changeElem = document.getElementById(elementId + 'Change');
                if (changeElem) {
                    changeElem.textContent = benchmark;
                }
            }
        }

        function updateFinancialTables() {
            const latestYear = appState.analysisYears;

            // Income Statement Table
            const incomeTable = document.getElementById('incomeTable');
            const incomeRows = [];
            const incomeData = appState.financialData.income;

            for (let year = 1; year <= latestYear; year++) {
                if (!incomeData[year]) continue;
                const d = incomeData[year];
                if (year === 1) {
                    incomeTable.innerHTML = `
                        <thead>
                            <tr>
                                <th>Metric</th>
                                ${Array.from({ length: latestYear }, (_, i) => `<th class="text-right">${appState.years[i]}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Revenue (${appState.currency})</td>
                                ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(incomeData[i+1]?.revenue || 0)}</td>`).join('')}
                            </tr>
                            <tr>
                                <td>Net Income (${appState.currency})</td>
                                ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(incomeData[i+1]?.netIncome || 0)}</td>`).join('')}
                            </tr>
                            <tr>
                                <td>Operating Expenses (${appState.currency})</td>
                                ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(incomeData[i+1]?.expenses || 0)}</td>`).join('')}
                            </tr>
                        </tbody>
                    `;
                }
            }

            // Balance Sheet Table
            const balanceTable = document.getElementById('balanceTable');
            const balanceData = appState.financialData.balance;

            balanceTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Metric</th>
                        ${Array.from({ length: latestYear }, (_, i) => `<th class="text-right">${appState.years[i]}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Total Assets (${appState.currency})</td>
                        ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(balanceData[i+1]?.assets || 0)}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>Total Liabilities (${appState.currency})</td>
                        ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(balanceData[i+1]?.liabilities || 0)}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>Total Equity (${appState.currency})</td>
                        ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(balanceData[i+1]?.equity || 0)}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>Current Assets (${appState.currency})</td>
                        ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(balanceData[i+1]?.currentAssets || 0)}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>Current Liabilities (${appState.currency})</td>
                        ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(balanceData[i+1]?.currentLiabilities || 0)}</td>`).join('')}
                    </tr>
                </tbody>
            `;

            // Cash Flow Table
            const cashTable = document.getElementById('cashTable');
            const cashData = appState.financialData.cashFlow;

            cashTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Metric</th>
                        ${Array.from({ length: latestYear }, (_, i) => `<th class="text-right">${appState.years[i]}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Operating Cash Flow (${appState.currency})</td>
                        ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(cashData[i+1]?.operatingCF || 0)}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>Free Cash Flow (${appState.currency})</td>
                        ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(cashData[i+1]?.freeCF || 0)}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>Capital Expenditures (${appState.currency})</td>
                        ${Array.from({ length: latestYear }, (_, i) => `<td class="text-right">${formatCurrency(cashData[i+1]?.capex || 0)}</td>`).join('')}
                    </tr>
                </tbody>
            `;
        }

        // ============================================
        // CHART GENERATION
        // ============================================
        function generateCharts() {
            const latestYear = appState.analysisYears;
            const years = appState.years;

            // Destroy existing charts
            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Chart 1: Revenue & Net Income Trend
            const incomeCtx = document.getElementById('trendChart').getContext('2d');
            chartInstances.trend = new Chart(incomeCtx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: Array.from({ length: latestYear }, (_, i) => appState.financialData.income[i+1]?.revenue || 0),
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Net Income',
                            data: Array.from({ length: latestYear }, (_, i) => appState.financialData.income[i+1]?.netIncome || 0),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#f1f5f9' } } },
                    scales: {
                        y: { ticks: { color: '#f1f5f9' }, grid: { color: 'rgba(71, 85, 105, 0.2)' } },
                        x: { ticks: { color: '#f1f5f9' }, grid: { color: 'rgba(71, 85, 105, 0.2)' } }
                    }
                }
            });

            // Chart 2: Profitability Metrics
            const profitCtx = document.getElementById('profitabilityChart').getContext('2d');
            chartInstances.profit = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: ['Net Margin', 'Gross Margin', 'ROE', 'ROA'],
                    datasets: [{
                        label: 'Profitability %',
                        data: [
                            parseFloat(appState.ratios.netMargin) || 0,
                            parseFloat(appState.ratios.grossMargin) || 0,
                            parseFloat(appState.ratios.roe) || 0,
                            parseFloat(appState.ratios.roa) || 0
                        ],
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#f1f5f9' } } },
                    scales: {
                        y: { ticks: { color: '#f1f5f9' }, grid: { color: 'rgba(71, 85, 105, 0.2)' } },
                        x: { ticks: { color: '#f1f5f9' }, grid: { color: 'rgba(71, 85, 105, 0.2)' } }
                    }
                }
            });

            // Chart 3: Capital Structure
            const balanceData = appState.financialData.balance[latestYear] || {};
            const capitalCtx = document.getElementById('capitalChart').getContext('2d');
            chartInstances.capital = new Chart(capitalCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Equity', 'Liabilities'],
                    datasets: [{
                        data: [balanceData.equity || 0, balanceData.liabilities || 0],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderColor: '#1e293b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#f1f5f9' } } }
                }
            });

            // Chart 4: Liquidity Ratios
            const liquidityCtx = document.getElementById('liquidityChart').getContext('2d');
            chartInstances.liquidity = new Chart(liquidityCtx, {
                type: 'radar',
                data: {
                    labels: ['Current Ratio', 'Quick Ratio', 'Cash Ratio'],
                    datasets: [{
                        label: 'Liquidity Position',
                        data: [
                            parseFloat(appState.ratios.currentRatio) || 0,
                            parseFloat(appState.ratios.quickRatio) || 0,
                            parseFloat(appState.ratios.cashRatio) || 0
                        ],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        pointBackgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#f1f5f9' } } },
                    scales: {
                        r: { ticks: { color: '#f1f5f9' }, grid: { color: 'rgba(71, 85, 105, 0.2)' } }
                    }
                }
            });
        }

        // ============================================
        // AI INSIGHTS GENERATION
        // ============================================
        async function generateAIInsights() {
            const model = document.getElementById('aiModel').value;
            const apiKey = document.getElementById('aiApiKey').value;

            console.log("[v0] Generating insights with model:", model);

            if (model === 'basic') {
                generateBasicInsights();
            } else if (apiKey) {
                generateAPIInsights(model, apiKey);
            } else {
                alert('Please enter an API key for advanced AI analysis');
            }
        }

        function generateBasicInsights() {
            console.log("[v0] Generating basic (no API) insights");

            const latest = appState.financialData;
            const latestYear = appState.analysisYears;
            const latestData = latest.balance[latestYear] || {};
            const incomeData = latest.income[latestYear] || {};

            let insights = '';

            // Financial Health Assessment
            const debtToEquity = parseFloat(appState.ratios.debtToEquity);
            const currentRatio = parseFloat(appState.ratios.currentRatio);
            const netMargin = parseFloat(appState.ratios.netMargin);
            const roe = parseFloat(appState.ratios.roe);

            insights += '<h4 style="color: var(--primary); margin-top: 15px;">Financial Health Overview</h4>';

            // Liquidity Analysis
            if (currentRatio > 1.5) {
                insights += '<div class="insight-point"><strong>Liquidity:</strong> Excellent short-term financial position. Company can comfortably meet its short-term obligations.</div>';
            } else if (currentRatio > 1.0) {
                insights += '<div class="insight-point"><strong>Liquidity:</strong> Adequate liquidity position. Monitor cash flow trends to maintain healthy position.</div>';
            } else {
                insights += '<div class="insight-point"><strong>Liquidity:</strong> ‚ö†Ô∏è Potential liquidity concerns. Current assets may not be sufficient to cover short-term liabilities.</div>';
            }

            // Profitability Analysis
            if (netMargin > 10) {
                insights += '<div class="insight-point"><strong>Profitability:</strong> Strong profit margins indicate efficient operations and good cost management.</div>';
            } else if (netMargin > 0) {
                insights += '<div class="insight-point"><strong>Profitability:</strong> Moderate profitability. Consider optimizing operations to improve margins.</div>';
            } else {
                insights += '<div class="insight-point"><strong>Profitability:</strong> ‚ö†Ô∏è Negative or low profitability requires operational improvements.</div>';
            }

            // Leverage Analysis
            if (debtToEquity < 1.0) {
                insights += '<div class="insight-point"><strong>Leverage:</strong> Conservative capital structure with lower financial risk. Healthy debt levels.</div>';
            } else if (debtToEquity < 2.0) {
                insights += '<div class="insight-point"><strong>Leverage:</strong> Moderate leverage. Current debt levels are manageable with existing equity.</div>';
            } else {
                insights += '<div class="insight-point"><strong>Leverage:</strong> ‚ö†Ô∏è High leverage indicates significant financial risk. Consider debt reduction strategies.</div>';
            }

            // ROE Analysis
            if (roe > 15) {
                insights += '<div class="insight-point"><strong>Returns:</strong> Excellent return on equity, demonstrating strong value creation for shareholders.</div>';
            } else if (roe > 5) {
                insights += '<div class="insight-point"><strong>Returns:</strong> Moderate returns on equity. Room for improvement in shareholder value creation.</div>';
            } else {
                insights += '<div class="insight-point"><strong>Returns:</strong> ‚ö†Ô∏è Low returns on equity. Investigate operational efficiency and profitability drivers.</div>';
            }

            // Trend Analysis
            insights += '<h4 style="color: var(--primary); margin-top: 15px;">Key Observations</h4>';
            
            if (latestData.assets > 0) {
                insights += `<div class="insight-point"><strong>Total Assets:</strong> ${formatCurrency(latestData.assets)} - Asset base reflects company scale and growth capacity.</div>`;
            }
            
            if (incomeData.netIncome > 0) {
                insights += `<div class="insight-point"><strong>Net Income:</strong> ${formatCurrency(incomeData.netIncome)} - Positive earnings support sustainability and growth investments.</div>`;
            }

            // Recommendations
            insights += '<h4 style="color: var(--primary); margin-top: 15px;">Strategic Recommendations</h4>';
            
            if (currentRatio < 1.5 || debtToEquity > 1.5) {
                insights += '<div class="insight-point"><strong>üéØ Action:</strong> Strengthen balance sheet through improved cash management and debt reduction initiatives.</div>';
            }
            
            if (netMargin < 5) {
                insights += '<div class="insight-point"><strong>üéØ Action:</strong> Focus on operational efficiency and cost optimization to improve margins.</div>';
            }
            
            if (roe < 10) {
                insights += '<div class="insight-point"><strong>üéØ Action:</strong> Review capital allocation strategy and asset utilization efficiency.</div>';
            }

            insights += '<div class="insight-point"><strong>üí° General:</strong> Continue monitoring quarterly performance against these key metrics to track progress and identify emerging trends.</div>';

            displayAIInsights(insights);
        }

        async function generateAPIInsights(model, apiKey) {
            console.log("[v0] Generating API insights with", model);

            const prompt = createAnalysisPrompt();

            try {
                document.getElementById('aiError').classList.add('hidden');
                document.getElementById('aiInsightsContainer').classList.remove('hidden');
                document.getElementById('aiInsightsContent').innerHTML = '<span class="spinner"></span> Analyzing financial data...';

                let response;

                if (model.startsWith('openai')) {
                    response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model.split('/')[1],
                            messages: [{ role: 'user', content: prompt }],
                            temperature: 0.7,
                            max_tokens: 1500
                        })
                    });

                    if (!response.ok) throw new Error('API Error: ' + response.statusText);
                    const data = await response.json();
                    const insights = data.choices[0].message.content;
                    displayAIInsights(formatMarkdownToHTML(insights));
                } else {
                    throw new Error('Model not supported. Please use OpenAI models.');
                }
            } catch (error) {
                console.error("[v0] AI error:", error);
                const errorDiv = document.getElementById('aiError');
                errorDiv.classList.remove('hidden');
                errorDiv.innerHTML = '‚úó Error generating AI insights: ' + error.message;
                document.getElementById('aiInsightsContainer').classList.add('hidden');
            }
        }

        function createAnalysisPrompt() {
            const latest = appState.financialData;
            const latestYear = appState.analysisYears;

            return `You are a professional financial analyst. Analyze the following financial data and provide actionable insights:

Company: ${appState.companyName}
Analysis Period: ${latestYear} year(s)
Currency: ${appState.currency}

FINANCIAL RATIOS:
- Current Ratio: ${appState.ratios.currentRatio}
- Quick Ratio: ${appState.ratios.quickRatio}
- Net Profit Margin: ${appState.ratios.netMargin}
- ROE: ${appState.ratios.roe}
- ROA: ${appState.ratios.roa}
- Debt-to-Equity: ${appState.ratios.debtToEquity}

FINANCIAL DATA (Latest Year):
- Revenue: ${formatCurrency(latest.income[latestYear]?.revenue || 0)}
- Net Income: ${formatCurrency(latest.income[latestYear]?.netIncome || 0)}
- Total Assets: ${formatCurrency(latest.balance[latestYear]?.assets || 0)}
- Total Liabilities: ${formatCurrency(latest.balance[latestYear]?.liabilities || 0)}
- Total Equity: ${formatCurrency(latest.balance[latestYear]?.equity || 0)}

Please provide:
1. Overall financial health assessment
2. Strengths and weaknesses
3. Key risks and opportunities
4. Specific actionable recommendations
5. Areas requiring immediate attention

Format your response clearly with sections.`;
        }

        function displayAIInsights(html) {
            document.getElementById('aiInsightsContainer').classList.remove('hidden');
            document.getElementById('aiInsightsContent').innerHTML = html;
        }

        function formatMarkdownToHTML(md) {
            return md
                .replace(/^### (.*?)$/gm, '<h4 style="color: var(--primary); margin-top: 15px;">$1</h4>')
                .replace(/^## (.*?)$/gm, '<h3 style="color: var(--primary); margin-top: 20px;">$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/\n\n/g, '</p><p>');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function formatCurrency(num) {
            if (num === 0 || !num) return appState.currency + ' 0';
            const abs = Math.abs(num);
            if (abs >= 1000) {
                return appState.currency + ' ' + (num / 1000).toFixed(1) + 'K';
            }
            return appState.currency + ' ' + num.toFixed(2);
        }

        function exportJSON() {
            const data = {
                company: appState.companyName,
                analysisYears: appState.analysisYears,
                currency: appState.currency,
                financialData: appState.financialData,
                ratios: appState.ratios,
                exportDate: new Date().toISOString()
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${appState.companyName}-analysis-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            let csv = 'Financial Statement Analysis\n';
            csv += `Company,${appState.companyName}\n`;
            csv += `Analysis Years,${appState.analysisYears}\n`;
            csv += `Currency,${appState.currency}\n`;
            csv += `Export Date,${new Date().toISOString()}\n\n`;

            csv += 'FINANCIAL RATIOS\n';
            Object.entries(appState.ratios).forEach(([key, value]) => {
                csv += `${key},${value}\n`;
            });

            csv += '\nFINANCIAL DATA\n';
            csv += 'Metric,' + appState.years.join(',') + '\n';

            // Income data
            csv += 'Revenue,' + Array.from({ length: appState.analysisYears }, (_, i) => appState.financialData.income[i+1]?.revenue || 0).join(',') + '\n';
            csv += 'Net Income,' + Array.from({ length: appState.analysisYears }, (_, i) => appState.financialData.income[i+1]?.netIncome || 0).join(',') + '\n';
            csv += 'Total Assets,' + Array.from({ length: appState.analysisYears }, (_, i) => appState.financialData.balance[i+1]?.assets || 0).join(',') + '\n';

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${appState.companyName}-analysis-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function resetApp() {
            if (confirm('Reset all data and start over?')) {
                document.getElementById('fileInput').value = '';
                document.getElementById('companyName').value = '';
                document.getElementById('analysisPeriodText').value = '';
                document.getElementById('aiApiKey').value = '';
                document.getElementById('uploadStatus').classList.add('hidden');
                document.getElementById('parsedDataSummary').classList.add('hidden');
                document.getElementById('resultsSection').classList.add('hidden');
                appState = {
                    analysisYears: 1,
                    companyName: '',
                    currency: 'Rs.',
                    financialData: { income: {}, balance: {}, cashFlow: {} },
                    years: [],
                    ratios: {}
                };
                createDataInputFields();
                window.scrollTo(0, 0);
            }
        }
    </script>
</body>
</html>
