<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Statement Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0f172a;
            --secondary: #1e293b;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: #334155;
            --bg-elevated: #0f172a;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, #1a1f35 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px 0 40px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 40px;
        }

        .header-content h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-content p {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--secondary);
            padding: 8px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 40px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.1);
        }

        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px 16px;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Grid for form inputs */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-grid.full {
            grid-template-columns: 1fr;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #2563eb 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-hover) 0%, #1d4ed8 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
            border-color: var(--accent);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Year Selection */
        .year-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .year-badge {
            padding: 8px 16px;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .year-badge:hover {
            border-color: var(--accent);
        }

        .year-badge.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Analysis Section */
        .analysis-section {
            display: none;
        }

        .analysis-section.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .metric-change {
            font-size: 12px;
            margin-top: 8px;
            color: var(--success);
        }

        .metric-change.negative {
            color: var(--danger);
        }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: var(--primary);
            border-bottom: 2px solid var(--border);
        }

        th {
            padding: 12px;
            text-align: left;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 24px;
        }

        /* AI Insights */
        .insights-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }

        .insights-box h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--accent);
        }

        .insights-box p {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .insights-box ul {
            margin-left: 20px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .insights-box li {
            margin-bottom: 8px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Footer */
        footer {
            border-top: 1px solid var(--border);
            padding: 30px 0;
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-good {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-alert {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Loader */
        .spinner {
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert */
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 4px solid;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: var(--accent);
            color: var(--accent);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: var(--success);
            color: var(--success);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: var(--warning);
            color: var(--warning);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: var(--danger);
            color: var(--danger);
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            .card {
                background: white;
                color: black;
                page-break-inside: avoid;
            }
            .header-actions, .form-actions, .tabs {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <h1>Financial Analysis Studio</h1>
                <p>Comprehensive financial statement analysis and ratio calculations</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary btn-sm" onclick="exportToJSON()">Export JSON</button>
                <button class="btn btn-secondary btn-sm" onclick="exportToCSV()">Export CSV</button>
                <button class="btn btn-secondary btn-sm" onclick="window.print()">Print</button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('input')">Enter Data</button>
            <button class="tab-btn" onclick="switchTab('analysis')">Analysis & Ratios</button>
            <button class="tab-btn" onclick="switchTab('insights')">AI Insights</button>
        </div>

        <!-- INPUT TAB -->
        <div id="input-tab" class="analysis-section active">
            <div class="card">
                <h2><span class="card-icon">‚öôÔ∏è</span> Configuration</h2>
                
                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" id="companyName" placeholder="Enter company name" value="ABC Insurance Ltd">
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Analysis Period</label>
                        <select id="analysisPeriod" onchange="updateYearBadges()">
                            <option value="1">1 Year</option>
                            <option value="2">2 Years</option>
                            <option value="3">3 Years</option>
                            <option value="4">4 Years</option>
                            <option value="5" selected>5 Years</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Base Year</label>
                        <input type="number" id="baseYear" placeholder="2024" value="2024">
                    </div>
                </div>

                <div id="years-container"></div>
            </div>

            <!-- Income Statement -->
            <div class="card" style="margin-top: 24px;">
                <h2><span class="card-icon">üìä</span> Income Statement</h2>
                <div id="income-statement-inputs"></div>
            </div>

            <!-- Balance Sheet -->
            <div class="card" style="margin-top: 24px;">
                <h2><span class="card-icon">üìã</span> Balance Sheet (Statement of Financial Position)</h2>
                <div id="balance-sheet-inputs"></div>
            </div>

            <!-- Cash Flow Statement -->
            <div class="card" style="margin-top: 24px;">
                <h2><span class="card-icon">üí∞</span> Cash Flow Statement</h2>
                <div id="cash-flow-inputs"></div>
            </div>

            <div style="margin-top: 24px;">
                <button class="btn btn-primary" onclick="analyzeData()">
                    <span>üìà</span> Analyze Financial Data
                </button>
                <button class="btn btn-secondary" onclick="resetForm()" style="margin-left: 12px;">Reset</button>
            </div>
        </div>

        <!-- ANALYSIS TAB -->
        <div id="analysis-tab" class="analysis-section">
            <div class="card">
                <h2><span class="card-icon">üìä</span> Financial Ratios Analysis</h2>
                <p style="color: var(--text-secondary); margin-bottom: 24px; font-size: 13px;">
                    Select a year to view detailed ratio analysis, trends, and performance metrics.
                </p>
                <div class="year-selector" id="year-selector"></div>
                <div id="ratio-content"></div>
            </div>
        </div>

        <!-- INSIGHTS TAB -->
        <div id="insights-tab" class="analysis-section">
            <div class="card">
                <h2><span class="card-icon">ü§ñ</span> AI-Powered Financial Insights</h2>
                <div id="insights-content"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>Financial Statement Analyzer | 100% Client-Side Analysis | No Data Stored</p>
        </footer>
    </div>

    <script>
        // ============================================
        // DATA STORAGE & MANAGEMENT
        // ============================================
        let financialData = {
            company: 'ABC Insurance Ltd',
            period: 5,
            baseYear: 2024,
            years: [],
            incomeStatement: {},
            balanceSheet: {},
            cashFlow: {}
        };

        // ============================================
        // FIELD DEFINITIONS
        // ============================================
        const incomeStatementFields = [
            { id: 'revenue', label: 'Revenue / Premium Income', placeholder: '1000000' },
            { id: 'operatingExpenses', label: 'Operating Expenses', placeholder: '300000' },
            { id: 'depreciation', label: 'Depreciation & Amortization', placeholder: '50000' },
            { id: 'operatingIncome', label: 'Operating Income (EBIT)', placeholder: '650000' },
            { id: 'interestExpense', label: 'Interest Expense', placeholder: '20000' },
            { id: 'taxExpense', label: 'Tax Expense', placeholder: '130000' },
            { id: 'netIncome', label: 'Net Income', placeholder: '500000' }
        ];

        const balanceSheetFields = [
            { id: 'cash', label: 'Cash & Equivalents', placeholder: '250000' },
            { id: 'accountsReceivable', label: 'Accounts Receivable', placeholder: '150000' },
            { id: 'inventory', label: 'Inventory', placeholder: '100000' },
            { id: 'currentAssets', label: 'Total Current Assets', placeholder: '500000' },
            { id: 'ppE', label: 'Property, Plant & Equipment', placeholder: '800000' },
            { id: 'totalAssets', label: 'Total Assets', placeholder: '1500000' },
            { id: 'accountsPayable', label: 'Accounts Payable', placeholder: '80000' },
            { id: 'currentLiabilities', label: 'Total Current Liabilities', placeholder: '200000' },
            { id: 'longTermDebt', label: 'Long-Term Debt', placeholder: '300000' },
            { id: 'totalLiabilities', label: 'Total Liabilities', placeholder: '500000' },
            { id: 'equity', label: 'Shareholders\' Equity', placeholder: '1000000' }
        ];

        const cashFlowFields = [
            { id: 'operatingCashFlow', label: 'Operating Cash Flow', placeholder: '600000' },
            { id: 'investingCashFlow', label: 'Investing Cash Flow', placeholder: '-200000' },
            { id: 'financingCashFlow', label: 'Financing Cash Flow', placeholder: '-100000' },
            { id: 'netCashFlow', label: 'Net Cash Flow', placeholder: '300000' },
            { id: 'freeCashFlow', label: 'Free Cash Flow', placeholder: '400000' }
        ];

        // ============================================
        // UI INITIALIZATION
        // ============================================
        function updateYearBadges() {
            const period = parseInt(document.getElementById('analysisPeriod').value);
            const baseYear = parseInt(document.getElementById('baseYear').value);
            financialData.period = period;
            financialData.baseYear = baseYear;

            // Update years array
            financialData.years = [];
            for (let i = period - 1; i >= 0; i--) {
                financialData.years.push(baseYear - i);
            }

            // Create year selector
            const yearsContainer = document.getElementById('years-container');
            yearsContainer.innerHTML = '<label style="margin-bottom: 12px;">Years</label><div class="year-selector">' + 
                financialData.years.map(year => 
                    `<span class="year-badge active">${year}</span>`
                ).join('') + '</div>';

            // Generate input fields
            generateInputFields();
        }

        function generateInputFields() {
            // Income Statement
            let incomeHTML = '<div class="form-grid full">';
            incomeStatementFields.forEach(field => {
                incomeHTML += `
                    <div class="form-group">
                        <label>${field.label}</label>
                        <div style="display: grid; grid-template-columns: repeat(${financialData.period}, 1fr); gap: 8px;">
                            ${financialData.years.map(year => 
                                `<input type="number" placeholder="${field.label}" 
                                    data-field="income" data-item="${field.id}" data-year="${year}" 
                                    class="financial-input">`
                            ).join('')}
                        </div>
                    </div>
                `;
            });
            incomeHTML += '</div>';
            document.getElementById('income-statement-inputs').innerHTML = incomeHTML;

            // Balance Sheet
            let balanceHTML = '<div class="form-grid full">';
            balanceSheetFields.forEach(field => {
                balanceHTML += `
                    <div class="form-group">
                        <label>${field.label}</label>
                        <div style="display: grid; grid-template-columns: repeat(${financialData.period}, 1fr); gap: 8px;">
                            ${financialData.years.map(year => 
                                `<input type="number" placeholder="${field.label}" 
                                    data-field="balance" data-item="${field.id}" data-year="${year}" 
                                    class="financial-input">`
                            ).join('')}
                        </div>
                    </div>
                `;
            });
            balanceHTML += '</div>';
            document.getElementById('balance-sheet-inputs').innerHTML = balanceHTML;

            // Cash Flow
            let cashFlowHTML = '<div class="form-grid full">';
            cashFlowFields.forEach(field => {
                cashFlowHTML += `
                    <div class="form-group">
                        <label>${field.label}</label>
                        <div style="display: grid; grid-template-columns: repeat(${financialData.period}, 1fr); gap: 8px;">
                            ${financialData.years.map(year => 
                                `<input type="number" placeholder="${field.label}" 
                                    data-field="cashflow" data-item="${field.id}" data-year="${year}" 
                                    class="financial-input">`
                            ).join('')}
                        </div>
                    </div>
                `;
            });
            cashFlowHTML += '</div>';
            document.getElementById('cash-flow-inputs').innerHTML = cashFlowHTML;
        }

        // ============================================
        // DATA COLLECTION & ANALYSIS
        // ============================================
        function analyzeData() {
            // Collect data from inputs
            financialData.company = document.getElementById('companyName').value || 'Company';
            const inputs = document.querySelectorAll('.financial-input');
            
            financialData.incomeStatement = {};
            financialData.balanceSheet = {};
            financialData.cashFlow = {};

            inputs.forEach(input => {
                const year = input.dataset.year;
                const field = input.dataset.field;
                const item = input.dataset.item;
                const value = parseFloat(input.value) || 0;

                if (field === 'income') {
                    if (!financialData.incomeStatement[year]) financialData.incomeStatement[year] = {};
                    financialData.incomeStatement[year][item] = value;
                } else if (field === 'balance') {
                    if (!financialData.balanceSheet[year]) financialData.balanceSheet[year] = {};
                    financialData.balanceSheet[year][item] = value;
                } else if (field === 'cashflow') {
                    if (!financialData.cashFlow[year]) financialData.cashFlow[year] = {};
                    financialData.cashFlow[year][item] = value;
                }
            });

            // Validate data
            if (Object.keys(financialData.incomeStatement).length === 0) {
                alert('Please enter at least one year of financial data');
                return;
            }

            // Switch to analysis tab
            switchTab('analysis');
            renderAnalysis();
        }

        // ============================================
        // RATIO CALCULATIONS
        // ============================================
        function calculateRatios(year) {
            const income = financialData.incomeStatement[year] || {};
            const balance = financialData.balanceSheet[year] || {};
            const cashFlow = financialData.cashFlow[year] || {};

            const ratios = {};

            // Liquidity Ratios
            ratios.currentRatio = balance.currentAssets / balance.currentLiabilities || 0;
            ratios.quickRatio = (balance.currentAssets - balance.inventory) / balance.currentLiabilities || 0;
            ratios.cashRatio = balance.cash / balance.currentLiabilities || 0;

            // Profitability Ratios
            ratios.netProfitMargin = (income.netIncome / income.revenue) * 100 || 0;
            ratios.roa = (income.netIncome / balance.totalAssets) * 100 || 0;
            ratios.roe = (income.netIncome / balance.equity) * 100 || 0;
            ratios.operatingMargin = (income.operatingIncome / income.revenue) * 100 || 0;

            // Solvency Ratios
            ratios.debtToEquity = balance.totalLiabilities / balance.equity || 0;
            ratios.debtToAssets = balance.totalLiabilities / balance.totalAssets || 0;
            ratios.equityRatio = balance.equity / balance.totalAssets || 0;
            ratios.interestCoverage = income.operatingIncome / income.interestExpense || 0;

            // Efficiency Ratios
            ratios.assetTurnover = income.revenue / balance.totalAssets || 0;
            ratios.receivablesTurnover = income.revenue / balance.accountsReceivable || 0;
            ratios.inventoryTurnover = income.revenue / balance.inventory || 0;

            // Cash Flow Ratios
            ratios.operatingCashFlowRatio = cashFlow.operatingCashFlow / balance.currentLiabilities || 0;
            ratios.freeCashFlow = cashFlow.freeCashFlow || 0;
            ratios.cashFlowMargin = (cashFlow.operatingCashFlow / income.revenue) * 100 || 0;

            return ratios;
        }

        // ============================================
        // TREND ANALYSIS
        // ============================================
        function calculateTrend(metric) {
            const years = financialData.years;
            const values = years.map(year => {
                const ratios = calculateRatios(year);
                return ratios[metric] || 0;
            });

            if (values.length < 2) return 0;
            const recent = values[values.length - 1];
            const previous = values[values.length - 2];
            const change = ((recent - previous) / Math.abs(previous)) * 100;
            return isFinite(change) ? change : 0;
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderAnalysis() {
            const yearSelector = document.getElementById('year-selector');
            yearSelector.innerHTML = financialData.years.map((year, index) => 
                `<span class="year-badge ${index === financialData.years.length - 1 ? 'active' : ''}" 
                    onclick="selectYear(${year})">${year}</span>`
            ).join('');

            selectYear(financialData.years[financialData.years.length - 1]);
        }

        function selectYear(year) {
            // Update active badge
            document.querySelectorAll('#year-selector .year-badge').forEach(badge => {
                badge.classList.remove('active');
            });
            event.target?.classList.add('active');

            const ratios = calculateRatios(year);
            const income = financialData.incomeStatement[year] || {};
            const balance = financialData.balanceSheet[year] || {};

            let html = '<div class="metrics-grid">';

            // Display key metrics
            const metrics = [
                { label: 'Current Ratio', value: ratios.currentRatio?.toFixed(2), unit: 'x' },
                { label: 'Net Profit Margin', value: ratios.netProfitMargin?.toFixed(2), unit: '%' },
                { label: 'ROA', value: ratios.roa?.toFixed(2), unit: '%' },
                { label: 'ROE', value: ratios.roe?.toFixed(2), unit: '%' },
                { label: 'Debt-to-Equity', value: ratios.debtToEquity?.toFixed(2), unit: 'x' },
                { label: 'Asset Turnover', value: ratios.assetTurnover?.toFixed(2), unit: 'x' }
            ];

            metrics.forEach(metric => {
                const trend = calculateTrend(Object.keys(ratios).find(k => ratios[k] === parseFloat(metric.value)));
                html += `
                    <div class="metric-card">
                        <div class="metric-label">${metric.label}</div>
                        <div class="metric-value">${metric.value} ${metric.unit}</div>
                        <div class="metric-change ${trend > 0 ? '' : 'negative'}">
                            ${trend > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(trend).toFixed(1)}%
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Ratio tables
            html += `
                <h3 style="margin-top: 30px; margin-bottom: 16px; font-size: 16px; font-weight: 600;">Detailed Ratios</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Ratio</th>
                                <th>Value</th>
                                <th>Interpretation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td rowspan="3"><strong>Liquidity</strong></td>
                                <td>Current Ratio</td>
                                <td>${ratios.currentRatio.toFixed(2)}</td>
                                <td>${getInterpretation('currentRatio', ratios.currentRatio)}</td>
                            </tr>
                            <tr>
                                <td>Quick Ratio</td>
                                <td>${ratios.quickRatio.toFixed(2)}</td>
                                <td>${getInterpretation('quickRatio', ratios.quickRatio)}</td>
                            </tr>
                            <tr>
                                <td>Cash Ratio</td>
                                <td>${ratios.cashRatio.toFixed(2)}</td>
                                <td>Immediate liquidity position</td>
                            </tr>
                            <tr>
                                <td rowspan="4"><strong>Profitability</strong></td>
                                <td>Net Profit Margin</td>
                                <td>${ratios.netProfitMargin.toFixed(2)}%</td>
                                <td>${getInterpretation('netProfitMargin', ratios.netProfitMargin)}</td>
                            </tr>
                            <tr>
                                <td>ROA</td>
                                <td>${ratios.roa.toFixed(2)}%</td>
                                <td>Asset efficiency in generating profit</td>
                            </tr>
                            <tr>
                                <td>ROE</td>
                                <td>${ratios.roe.toFixed(2)}%</td>
                                <td>${getInterpretation('roe', ratios.roe)}</td>
                            </tr>
                            <tr>
                                <td>Operating Margin</td>
                                <td>${ratios.operatingMargin.toFixed(2)}%</td>
                                <td>Operational efficiency</td>
                            </tr>
                            <tr>
                                <td rowspan="3"><strong>Solvency</strong></td>
                                <td>Debt-to-Equity</td>
                                <td>${ratios.debtToEquity.toFixed(2)}</td>
                                <td>${getInterpretation('debtToEquity', ratios.debtToEquity)}</td>
                            </tr>
                            <tr>
                                <td>Debt-to-Assets</td>
                                <td>${ratios.debtToAssets.toFixed(2)}</td>
                                <td>Financial leverage position</td>
                            </tr>
                            <tr>
                                <td>Interest Coverage</td>
                                <td>${ratios.interestCoverage.toFixed(2)}x</td>
                                <td>Ability to cover interest obligations</td>
                            </tr>
                            <tr>
                                <td rowspan="3"><strong>Efficiency</strong></td>
                                <td>Asset Turnover</td>
                                <td>${ratios.assetTurnover.toFixed(2)}</td>
                                <td>How effectively assets generate revenue</td>
                            </tr>
                            <tr>
                                <td>Receivables Turnover</td>
                                <td>${ratios.receivablesTurnover.toFixed(2)}</td>
                                <td>Speed of collecting receivables</td>
                            </tr>
                            <tr>
                                <td>Inventory Turnover</td>
                                <td>${ratios.inventoryTurnover.toFixed(2)}</td>
                                <td>Inventory management efficiency</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Charts
            html += '<h3 style="margin-top: 30px; margin-bottom: 16px; font-size: 16px; font-weight: 600;">Trend Analysis</h3>';
            html += '<div class="main-grid"><div class="card"><div class="chart-container"><canvas id="trendChart"></canvas></div></div>';
            html += '<div class="card"><div class="chart-container"><canvas id="profitChart"></canvas></div></div></div>';

            document.getElementById('ratio-content').innerHTML = html;

            // Draw charts
            drawTrendChart();
            drawProfitChart();
        }

        function drawTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;

            const years = financialData.years;
            const currentRatios = years.map(y => calculateRatios(y).currentRatio);
            const debtToEquity = years.map(y => calculateRatios(y).debtToEquity);
            const roe = years.map(y => calculateRatios(y).roe);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Current Ratio',
                            data: currentRatios,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Debt-to-Equity',
                            data: debtToEquity,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'ROE (%)',
                            data: roe,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1', font: { size: 12 } }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#cbd5e1' },
                            grid: { color: 'rgba(59, 130, 246, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#cbd5e1' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function drawProfitChart() {
            const ctx = document.getElementById('profitChart');
            if (!ctx) return;

            const years = financialData.years;
            const netMargin = years.map(y => calculateRatios(y).netProfitMargin);
            const roa = years.map(y => calculateRatios(y).roa);
            const roe = years.map(y => calculateRatios(y).roe);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Net Profit Margin (%)',
                            data: netMargin,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)'
                        },
                        {
                            label: 'ROA (%)',
                            data: roa,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)'
                        },
                        {
                            label: 'ROE (%)',
                            data: roe,
                            backgroundColor: 'rgba(245, 158, 11, 0.8)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1', font: { size: 12 } }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#cbd5e1' },
                            grid: { color: 'rgba(59, 130, 246, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#cbd5e1' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function getInterpretation(ratio, value) {
            const interpretations = {
                currentRatio: value >= 1.5 ? '‚úì Strong liquidity' : value >= 1 ? '~ Adequate liquidity' : '‚úó Low liquidity',
                quickRatio: value >= 1 ? '‚úì Good immediate liquidity' : '~ Moderate liquidity position',
                netProfitMargin: value >= 15 ? '‚úì Excellent profitability' : value >= 5 ? '~ Good profitability' : '~ Standard profitability',
                roe: value >= 15 ? '‚úì Strong returns' : value >= 10 ? '~ Good returns' : '~ Acceptable returns',
                debtToEquity: value < 1 ? '‚úì Conservative leverage' : value < 2 ? '~ Moderate leverage' : '‚úó High leverage'
            };
            return interpretations[ratio] || 'Monitor performance';
        }

        // ============================================
        // AI INSIGHTS (NO API KEY NEEDED)
        // ============================================
        function renderInsights() {
            const latestYear = financialData.years[financialData.years.length - 1];
            const prevYear = financialData.years.length > 1 ? financialData.years[financialData.years.length - 2] : null;
            
            const latestRatios = calculateRatios(latestYear);
            const prevRatios = prevYear ? calculateRatios(prevYear) : null;

            let insights = generateAIInsights(latestRatios, prevRatios, latestYear);
            document.getElementById('insights-content').innerHTML = insights;
        }

        function generateAIInsights(current, previous, year) {
            let html = '<div class="insights-box">';
            html += '<h3>üí° Financial Health Summary</h3>';
            html += '<p><strong>Analysis Period:</strong> ' + financialData.years.join(', ') + '</p>';
            html += '<p><strong>Latest Year:</strong> ' + year + '</p>';

            // Liquidity Analysis
            html += '<h4 style="margin-top: 16px; margin-bottom: 8px; color: var(--accent);">Liquidity Position</h4>';
            if (current.currentRatio >= 2) {
                html += '<p>‚úì <strong>Strong Liquidity:</strong> The company maintains excellent short-term financial health with a current ratio of ' + current.currentRatio.toFixed(2) + '. The organization can comfortably meet its short-term obligations.</p>';
            } else if (current.currentRatio >= 1.5) {
                html += '<p>~ <strong>Adequate Liquidity:</strong> The company has a current ratio of ' + current.currentRatio.toFixed(2) + ', indicating solid ability to cover short-term liabilities with current assets.</p>';
            } else if (current.currentRatio >= 1) {
                html += '<p>~ <strong>Moderate Liquidity:</strong> With a current ratio of ' + current.currentRatio.toFixed(2) + ', the company can meet obligations but may face challenges during economic downturns.</p>';
            } else {
                html += '<p>‚úó <strong>Liquidity Concern:</strong> Current ratio of ' + current.currentRatio.toFixed(2) + ' suggests potential difficulties in meeting short-term obligations. Immediate action recommended.</p>';
            }

            // Profitability Analysis
            html += '<h4 style="margin-top: 16px; margin-bottom: 8px; color: var(--accent);">Profitability Assessment</h4>';
            if (current.netProfitMargin >= 20) {
                html += '<p>‚úì <strong>Excellent Profitability:</strong> Net profit margin of ' + current.netProfitMargin.toFixed(2) + '% demonstrates strong cost management and pricing power.</p>';
            } else if (current.netProfitMargin >= 10) {
                html += '<p>~ <strong>Good Profitability:</strong> Net profit margin of ' + current.netProfitMargin.toFixed(2) + '% is healthy for most industries, indicating efficient operations.</p>';
            } else if (current.netProfitMargin >= 5) {
                html += '<p>~ <strong>Standard Profitability:</strong> Net profit margin of ' + current.netProfitMargin.toFixed(2) + '% is reasonable but may indicate opportunity for operational efficiency improvements.</p>';
            } else {
                html += '<p>‚úó <strong>Low Profitability:</strong> Net profit margin of ' + current.netProfitMargin.toFixed(2) + '% suggests cost structure challenges or pricing pressures.</p>';
            }

            // Leverage Analysis
            html += '<h4 style="margin-top: 16px; margin-bottom: 8px; color: var(--accent);">Leverage & Solvency</h4>';
            if (current.debtToEquity < 0.5) {
                html += '<p>‚úì <strong>Conservative Financing:</strong> Debt-to-equity ratio of ' + current.debtToEquity.toFixed(2) + ' indicates low financial risk with significant equity cushion.</p>';
            } else if (current.debtToEquity < 1) {
                html += '<p>~ <strong>Balanced Capital Structure:</strong> Debt-to-equity of ' + current.debtToEquity.toFixed(2) + ' shows prudent use of leverage without excessive financial risk.</p>';
            } else if (current.debtToEquity < 2) {
                html += '<p>~ <strong>Moderate Leverage:</strong> Debt-to-equity ratio of ' + current.debtToEquity.toFixed(2) + ' suggests reliance on debt financing; monitor interest coverage carefully.</p>';
            } else {
                html += '<p>‚úó <strong>High Leverage Risk:</strong> Debt-to-equity of ' + current.debtToEquity.toFixed(2) + ' indicates significant financial risk. Consider debt reduction strategies.</p>';
            }

            // ROE Analysis
            html += '<h4 style="margin-top: 16px; margin-bottom: 8px; color: var(--accent);">Return on Equity (ROE)</h4>';
            if (current.roe >= 20) {
                html += '<p>‚úì <strong>Excellent Shareholder Returns:</strong> ROE of ' + current.roe.toFixed(2) + '% demonstrates superior capital efficiency and strong value creation for shareholders.</p>';
            } else if (current.roe >= 15) {
                html += '<p>~ <strong>Strong Shareholder Returns:</strong> ROE of ' + current.roe.toFixed(2) + '% is above average, indicating effective use of shareholder capital.</p>';
            } else if (current.roe >= 10) {
                html += '<p>~ <strong>Acceptable Shareholder Returns:</strong> ROE of ' + current.roe.toFixed(2) + '% is reasonable, though potential for improvement exists.</p>';
            } else {
                html += '<p>‚úó <strong>Low Shareholder Returns:</strong> ROE of ' + current.roe.toFixed(2) + '% suggests inefficient capital deployment.</p>';
            }

            // Trend Analysis
            if (previous) {
                html += '<h4 style="margin-top: 16px; margin-bottom: 8px; color: var(--accent);">Year-over-Year Trends</h4>';
                const profitTrend = ((current.netProfitMargin - previous.netProfitMargin) / Math.abs(previous.netProfitMargin)) * 100;
                const leverageTrend = ((current.debtToEquity - previous.debtToEquity) / Math.abs(previous.debtToEquity)) * 100;
                
                if (profitTrend > 0) {
                    html += '<p>‚úì <strong>Improving Profitability:</strong> Net profit margin improved by ' + profitTrend.toFixed(1) + '% year-over-year, suggesting better operational efficiency.</p>';
                } else if (profitTrend < -5) {
                    html += '<p>‚úó <strong>Declining Profitability:</strong> Net profit margin declined by ' + Math.abs(profitTrend).toFixed(1) + '%. Investigate cost increases or revenue pressures.</p>';
                }

                if (leverageTrend < -10) {
                    html += '<p>‚úì <strong>Improving Leverage Position:</strong> Debt-to-equity improved by ' + Math.abs(leverageTrend).toFixed(1) + '%, indicating reduced financial risk.</p>';
                } else if (leverageTrend > 10) {
                    html += '<p>‚úó <strong>Increasing Leverage:</strong> Debt-to-equity increased by ' + leverageTrend.toFixed(1) + '%. Monitor debt management closely.</p>';
                }
            }

            // Recommendations
            html += '<h4 style="margin-top: 16px; margin-bottom: 8px; color: var(--accent);">Strategic Recommendations</h4>';
            html += '<ul>';
            
            if (current.currentRatio < 1.5) {
                html += '<li>Improve liquidity by accelerating receivable collections or reducing current liabilities</li>';
            }
            if (current.netProfitMargin < 10) {
                html += '<li>Focus on operational efficiency and cost reduction initiatives</li>';
            }
            if (current.debtToEquity > 1.5) {
                html += '<li>Implement debt reduction strategy or increase equity through retained earnings</li>';
            }
            if (current.roe < 12) {
                html += '<li>Review asset utilization and capital allocation efficiency</li>';
            }
            html += '<li>Maintain regular monitoring of financial ratios against industry benchmarks</li>';
            html += '<li>Consider working capital optimization to improve cash conversion cycle</li>';
            
            html += '</ul></div>';
            return html;
        }

        // ============================================
        // TAB SWITCHING & UTILITY
        // ============================================
        function switchTab(tab) {
            document.querySelectorAll('.analysis-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tab + '-tab').classList.add('active');
            event.target?.classList.add('active');

            if (tab === 'insights') {
                renderInsights();
            }
        }

        function selectYear(year) {
            document.querySelectorAll('#year-selector .year-badge').forEach(badge => {
                badge.classList.remove('active');
                if (badge.textContent == year) badge.classList.add('active');
            });

            const ratios = calculateRatios(year);
            const income = financialData.incomeStatement[year] || {};
            const balance = financialData.balanceSheet[year] || {};

            let html = '<div class="metrics-grid">';

            const metrics = [
                { label: 'Current Ratio', value: ratios.currentRatio?.toFixed(2), unit: 'x' },
                { label: 'Net Profit Margin', value: ratios.netProfitMargin?.toFixed(2), unit: '%' },
                { label: 'ROA', value: ratios.roa?.toFixed(2), unit: '%' },
                { label: 'ROE', value: ratios.roe?.toFixed(2), unit: '%' },
                { label: 'Debt-to-Equity', value: ratios.debtToEquity?.toFixed(2), unit: 'x' },
                { label: 'Asset Turnover', value: ratios.assetTurnover?.toFixed(2), unit: 'x' }
            ];

            metrics.forEach(metric => {
                const trend = calculateTrend(Object.keys(ratios).find(k => ratios[k] === parseFloat(metric.value)));
                html += `
                    <div class="metric-card">
                        <div class="metric-label">${metric.label}</div>
                        <div class="metric-value">${metric.value} ${metric.unit}</div>
                        <div class="metric-change ${trend > 0 ? '' : 'negative'}">
                            ${trend > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(trend).toFixed(1)}%
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            html += `
                <h3 style="margin-top: 30px; margin-bottom: 16px; font-size: 16px; font-weight: 600;">Detailed Ratios</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Ratio</th>
                                <th>Value</th>
                                <th>Interpretation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td rowspan="3"><strong>Liquidity</strong></td>
                                <td>Current Ratio</td>
                                <td>${ratios.currentRatio.toFixed(2)}</td>
                                <td>${getInterpretation('currentRatio', ratios.currentRatio)}</td>
                            </tr>
                            <tr>
                                <td>Quick Ratio</td>
                                <td>${ratios.quickRatio.toFixed(2)}</td>
                                <td>${getInterpretation('quickRatio', ratios.quickRatio)}</td>
                            </tr>
                            <tr>
                                <td>Cash Ratio</td>
                                <td>${ratios.cashRatio.toFixed(2)}</td>
                                <td>Immediate liquidity position</td>
                            </tr>
                            <tr>
                                <td rowspan="4"><strong>Profitability</strong></td>
                                <td>Net Profit Margin</td>
                                <td>${ratios.netProfitMargin.toFixed(2)}%</td>
                                <td>${getInterpretation('netProfitMargin', ratios.netProfitMargin)}</td>
                            </tr>
                            <tr>
                                <td>ROA</td>
                                <td>${ratios.roa.toFixed(2)}%</td>
                                <td>Asset efficiency in generating profit</td>
                            </tr>
                            <tr>
                                <td>ROE</td>
                                <td>${ratios.roe.toFixed(2)}%</td>
                                <td>${getInterpretation('roe', ratios.roe)}</td>
                            </tr>
                            <tr>
                                <td>Operating Margin</td>
                                <td>${ratios.operatingMargin.toFixed(2)}%</td>
                                <td>Operational efficiency</td>
                            </tr>
                            <tr>
                                <td rowspan="3"><strong>Solvency</strong></td>
                                <td>Debt-to-Equity</td>
                                <td>${ratios.debtToEquity.toFixed(2)}</td>
                                <td>${getInterpretation('debtToEquity', ratios.debtToEquity)}</td>
                            </tr>
                            <tr>
                                <td>Debt-to-Assets</td>
                                <td>${ratios.debtToAssets.toFixed(2)}</td>
                                <td>Financial leverage position</td>
                            </tr>
                            <tr>
                                <td>Interest Coverage</td>
                                <td>${ratios.interestCoverage.toFixed(2)}x</td>
                                <td>Ability to cover interest obligations</td>
                            </tr>
                            <tr>
                                <td rowspan="3"><strong>Efficiency</strong></td>
                                <td>Asset Turnover</td>
                                <td>${ratios.assetTurnover.toFixed(2)}</td>
                                <td>How effectively assets generate revenue</td>
                            </tr>
                            <tr>
                                <td>Receivables Turnover</td>
                                <td>${ratios.receivablesTurnover.toFixed(2)}</td>
                                <td>Speed of collecting receivables</td>
                            </tr>
                            <tr>
                                <td>Inventory Turnover</td>
                                <td>${ratios.inventoryTurnover.toFixed(2)}</td>
                                <td>Inventory management efficiency</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            html += '<h3 style="margin-top: 30px; margin-bottom: 16px; font-size: 16px; font-weight: 600;">Trend Analysis</h3>';
            html += '<div class="main-grid"><div class="card"><div class="chart-container"><canvas id="trendChart"></canvas></div></div>';
            html += '<div class="card"><div class="chart-container"><canvas id="profitChart"></canvas></div></div></div>';

            document.getElementById('ratio-content').innerHTML = html;

            setTimeout(() => {
                drawTrendChart();
                drawProfitChart();
            }, 100);
        }

        function resetForm() {
            if (confirm('Reset all data? This cannot be undone.')) {
                document.querySelectorAll('.financial-input').forEach(input => input.value = '');
                document.getElementById('companyName').value = 'ABC Insurance Ltd';
            }
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        function exportToJSON() {
            const exportData = {
                company: financialData.company,
                analysisDate: new Date().toISOString(),
                period: financialData.period,
                years: financialData.years,
                incomeStatement: financialData.incomeStatement,
                balanceSheet: financialData.balanceSheet,
                cashFlow: financialData.cashFlow,
                ratios: financialData.years.reduce((acc, year) => {
                    acc[year] = calculateRatios(year);
                    return acc;
                }, {})
            };

            const json = JSON.stringify(exportData, null, 2);
            downloadFile(json, 'financial-analysis.json', 'application/json');
        }

        function exportToCSV() {
            let csv = 'Company,Year,Metric,Value\n';
            
            financialData.years.forEach(year => {
                const ratios = calculateRatios(year);
                Object.keys(ratios).forEach(key => {
                    csv += `"${financialData.company}",${year},"${key}",${ratios[key].toFixed(4)}\n`;
                });
            });

            downloadFile(csv, 'financial-analysis.csv', 'text/csv');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            updateYearBadges();
        });
    </script>
</body>
</html>
