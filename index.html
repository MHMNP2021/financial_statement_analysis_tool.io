<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Financial Statement Analyzer - AI-powered financial ratio analysis and insights">
    <title>FinAnalyze Pro - Financial Statement Analyzer</title>
    
    <!-- CDN Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@5.4.149/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.0.0/index.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3a8a;
            --primary-dark: #1e293b;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
            --neutral-light: #f9fafb;
            --neutral-gray: #e5e7eb;
            --neutral-dark: #374151;
            --neutral-text: #1f2937;
            --border: #d1d5db;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, var(--neutral-light) 0%, #f3f4f6 100%);
            color: var(--neutral-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(30, 58, 138, 0.15);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card h2::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 24px;
            background: var(--accent);
            border-radius: 2px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--neutral-dark);
        }

        input[type="file"],
        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input[type="file"]:focus,
        input[type="text"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--accent);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(59, 130, 246, 0.02);
        }

        .upload-area:hover {
            background: rgba(59, 130, 246, 0.05);
            border-color: var(--accent-light);
        }

        .upload-area.active {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-light);
        }

        /* Buttons */
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--accent-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--neutral-gray);
            color: var(--neutral-text);
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--neutral-dark);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .tab-button.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th {
            background: var(--neutral-light);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--neutral-dark);
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: rgba(59, 130, 246, 0.02);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Ratio Badge */
        .ratio-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .ratio-badge.good {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
        }

        .ratio-badge.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent-orange);
        }

        .ratio-badge.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
        }

        /* AI Insights */
        .insights-container {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-left: 4px solid var(--accent);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .insights-container h3 {
            color: var(--accent);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insights-text {
            color: var(--neutral-dark);
            line-height: 1.8;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alert/Info Boxes */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert.info {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--accent);
            color: var(--accent);
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--accent-green);
            color: var(--accent-green);
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--accent-red);
            color: var(--accent-red);
        }

        .alert-icon {
            flex-shrink: 0;
            font-size: 1.25rem;
        }

        /* Chart Container */
        .chart-wrapper {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        /* Grid for ratio cards */
        .ratio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .ratio-card {
            background: var(--neutral-light);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .ratio-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin: 0.5rem 0;
        }

        .ratio-card-label {
            font-size: 0.9rem;
            color: var(--neutral-dark);
            font-weight: 600;
        }

        .ratio-card-unit {
            font-size: 0.85rem;
            color: var(--neutral-dark);
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        /* Full width sections */
        .full-width {
            grid-column: 1 / -1;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.75rem;
            }

            .container {
                padding: 1rem;
            }
        }

        @media (max-width: 640px) {
            .tabs {
                gap: 0.5rem;
            }

            .tab-button {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 0.75rem 0.5rem;
            }

            .ratio-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .mt {
            margin-top: 1.5rem;
        }

        .mb {
            margin-bottom: 1.5rem;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--neutral-dark);
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>üìä FinAnalyze Pro</h1>
            <p>AI-Powered Financial Statement Analysis & Ratio Insights</p>
        </header>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- Left Column: Upload & API Key -->
            <div class="card">
                <h2>Upload Financial Statements</h2>

                <div class="form-group">
                    <label>üìÅ Company Name</label>
                    <input type="text" id="companyName" placeholder="e.g., Apple Inc.">
                </div>

                <div class="form-group">
                    <label>üìÖ Analysis Period</label>
                    <select id="analysisPeriod">
                        <option value="3">3 Years</option>
                        <option value="5">5 Years</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üì§ Income Statement PDFs</label>
                    <div class="upload-area" id="incomeUploadArea">
                        <p style="margin-bottom: 0.5rem;">üéØ Drag & drop or click to upload</p>
                        <p class="text-muted" style="font-size: 0.9rem;">Upload income statements (one per year)</p>
                        <input type="file" id="incomeFiles" multiple accept=".pdf" style="display: none;">
                    </div>
                    <div id="incomeFileList" style="margin-top: 0.5rem;"></div>
                </div>

                <div class="form-group">
                    <label>üì§ Balance Sheet PDFs</label>
                    <div class="upload-area" id="balanceUploadArea">
                        <p style="margin-bottom: 0.5rem;">üéØ Drag & drop or click to upload</p>
                        <p class="text-muted" style="font-size: 0.9rem;">Upload balance sheets (one per year)</p>
                        <input type="file" id="balanceFiles" multiple accept=".pdf" style="display: none;">
                    </div>
                    <div id="balanceFileList" style="margin-top: 0.5rem;"></div>
                </div>

                <div class="form-group">
                    <label>üì§ Cash Flow Statement PDFs</label>
                    <div class="upload-area" id="cashflowUploadArea">
                        <p style="margin-bottom: 0.5rem;">üéØ Drag & drop or click to upload</p>
                        <p class="text-muted" style="font-size: 0.9rem;">Upload cash flow statements (one per year)</p>
                        <input type="file" id="cashflowFiles" multiple accept=".pdf" style="display: none;">
                    </div>
                    <div id="cashflowFileList" style="margin-top: 0.5rem;"></div>
                </div>

                <div class="alert info">
                    <span class="alert-icon">‚ÑπÔ∏è</span>
                    <div>
                        <strong>Pro Tip:</strong> Name your PDFs consistently (e.g., "2024_income.pdf", "2023_income.pdf") for better parsing. If PDF parsing fails, you can manually enter data.
                    </div>
                </div>
            </div>

            <!-- Right Column: AI Configuration -->
            <div class="card">
                <h2>AI Configuration</h2>

                <div class="alert info">
                    <span class="alert-icon">üîí</span>
                    <div>
                        <strong>Privacy & Security:</strong> Your API key is stored only in your browser's local storage and never sent to any server except the AI provider you choose. Never share your API key with others.
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1.5rem;">
                    <label>ü§ñ AI Provider</label>
                    <select id="aiProvider">
                        <option value="openai">OpenAI (GPT-4o mini)</option>
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="grok">xAI (Grok)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üîë API Key</label>
                    <input type="password" id="apiKey" placeholder="Your API key (stored locally, never shared)">
                    <small style="color: var(--neutral-dark); opacity: 0.7; margin-top: 0.5rem; display: block;">
                        Don't have an API key? Visit your provider's website to sign up.
                    </small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="rememberKey" style="width: auto; margin-right: 0.5rem;">
                        Remember API key (saved locally)
                    </label>
                </div>

                <button class="btn-primary" id="analyzeBtn">üöÄ Analyze Financial Statements</button>

                <div id="errorMessage" class="alert error hidden" style="margin-top: 1rem;">
                    <span class="alert-icon">‚ùå</span>
                    <div id="errorText"></div>
                </div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="resultsSection" class="hidden">
            <!-- Tabs Navigation -->
            <div class="tabs">
                <button class="tab-button active" data-tab="overview">üìà Overview</button>
                <button class="tab-button" data-tab="liquidity">üíß Liquidity Ratios</button>
                <button class="tab-button" data-tab="profitability">üí∞ Profitability Ratios</button>
                <button class="tab-button" data-tab="solvency">üè¢ Solvency Ratios</button>
                <button class="tab-button" data-tab="efficiency">‚ö° Efficiency Ratios</button>
                <button class="tab-button" data-tab="trends">üìä Trends</button>
                <button class="tab-button" data-tab="insights">üß† AI Insights</button>
            </div>

            <!-- Tab Content -->
            <div id="overviewTab" class="tab-content card">
                <h2>Financial Overview</h2>
                <div id="overviewContent"></div>
            </div>

            <div id="liquidityTab" class="tab-content card hidden">
                <h2>Liquidity Ratios</h2>
                <p class="text-muted" style="margin-bottom: 1rem;">Measure the company's ability to meet short-term obligations</p>
                <div id="liquidityContent"></div>
            </div>

            <div id="profitabilityTab" class="tab-content card hidden">
                <h2>Profitability Ratios</h2>
                <p class="text-muted" style="margin-bottom: 1rem;">Measure the company's ability to generate earnings</p>
                <div id="profitabilityContent"></div>
            </div>

            <div id="solvencyTab" class="tab-content card hidden">
                <h2>Solvency Ratios</h2>
                <p class="text-muted" style="margin-bottom: 1rem;">Measure the company's long-term financial stability</p>
                <div id="solvencyContent"></div>
            </div>

            <div id="efficiencyTab" class="tab-content card hidden">
                <h2>Efficiency Ratios</h2>
                <p class="text-muted" style="margin-bottom: 1rem;">Measure how effectively the company uses its assets</p>
                <div id="efficiencyContent"></div>
            </div>

            <div id="trendsTab" class="tab-content card hidden">
                <h2>Trend Analysis</h2>
                <p class="text-muted" style="margin-bottom: 1rem;">Track ratio changes over time to identify patterns and trends</p>
                <div id="trendsContent"></div>
            </div>

            <div id="insightsTab" class="tab-content card hidden">
                <h2>AI Financial Insights</h2>
                <div id="insightsContent"></div>
            </div>
        </div>

        <!-- Manual Data Entry Fallback -->
        <div id="manualEntrySection" class="card hidden mb">
            <h2>Manual Data Entry (PDF Parsing Fallback)</h2>
            <p class="text-muted" style="margin-bottom: 1rem;">If PDF parsing fails, you can enter financial data manually below.</p>
            
            <div class="form-group">
                <label>Select Year</label>
                <select id="manualYear">
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                </select>
            </div>

            <div class="form-group">
                <label>Income Statement Data (JSON)</label>
                <textarea id="manualIncomeData" placeholder='{"revenue": 100000, "cost_of_revenue": 50000, "net_income": 20000}' rows="4"></textarea>
            </div>

            <div class="form-group">
                <label>Balance Sheet Data (JSON)</label>
                <textarea id="manualBalanceData" placeholder='{"current_assets": 50000, "total_assets": 200000, "current_liabilities": 30000, "total_liabilities": 100000}' rows="4"></textarea>
            </div>

            <button class="btn-secondary" id="addManualDataBtn">Add Year Data</button>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION & STATE MANAGEMENT
        // ==========================================
        
        const APP_STATE = {
            companyName: '',
            analysisPeriod: 3,
            financialData: {},
            ratios: {},
            aiProvider: 'openai',
            apiKey: '',
        };

        const RATIO_BENCHMARKS = {
            current_ratio: { good: 1.5, warning: 1.0 },
            quick_ratio: { good: 1.0, warning: 0.5 },
            debt_to_equity: { good: 2.0, warning: 3.0 },
            roe: { good: 15, warning: 5 },
            roa: { good: 5, warning: 1 },
            npm: { good: 10, warning: 2 },
            asset_turnover: { good: 1.5, warning: 0.5 },
        };

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            console.error('[v0 FinAnalyzer]', message);
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            console.log('[v0 FinAnalyzer Success]', message);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(value);
        }

        function formatPercent(value) {
            return (value * 100).toFixed(2) + '%';
        }

        function getRatioBadgeClass(ratio, value) {
            const bench = RATIO_BENCHMARKS[ratio];
            if (!bench) return 'neutral';
            if (value >= bench.good) return 'good';
            if (value >= bench.warning) return 'warning';
            return 'danger';
        }

        function saveToLocalStorage() {
            localStorage.setItem('finanalyzer_state', JSON.stringify(APP_STATE));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('finanalyzer_state');
            if (saved) {
                Object.assign(APP_STATE, JSON.parse(saved));
            }
            if (localStorage.getItem('finanalyzer_apikey')) {
                document.getElementById('apiKey').value = localStorage.getItem('finanalyzer_apikey');
                document.getElementById('rememberKey').checked = true;
            }
        }

        // ==========================================
        // FILE UPLOAD HANDLING
        // ==========================================

        function setupUploadArea(uploadAreaId, fileInputId, fileListId) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(fileInputId);
            const fileList = document.getElementById(fileListId);

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('active');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('active');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('active');
                fileInput.files = e.dataTransfer.files;
                displayFiles();
            });

            fileInput.addEventListener('change', displayFiles);

            function displayFiles() {
                fileList.innerHTML = '';
                Array.from(fileInput.files).forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'alert success';
                    item.innerHTML = `<span class="alert-icon">‚úÖ</span><div>${file.name} (${(file.size / 1024).toFixed(1)} KB)</div>`;
                    fileList.appendChild(item);
                });
            }
        }

        // ==========================================
        // PDF PARSING
        // ==========================================

        async function parsePDF(file) {
            try {
                console.log('[v0] Parsing PDF:', file.name);
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let text = '';

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(' ') + '\n';
                }

                console.log('[v0] Extracted text length:', text.length);
                return extractFinancialData(text, file.name);
            } catch (error) {
                console.error('[v0] PDF parsing failed:', error);
                showError(`Failed to parse ${file.name}. Try manual entry instead.`);
                return null;
            }
        }

        function extractFinancialData(text, filename) {
            // Extract year from filename (e.g., "2024_income.pdf" -> 2024)
            const yearMatch = filename.match(/(\d{4})/);
            const year = yearMatch ? yearMatch[1] : new Date().getFullYear().toString();

            // Define patterns for common financial statement line items
            const patterns = {
                revenue: [/revenue|sales|total operating revenue/i],
                cost_of_revenue: [/cost of revenue|cost of goods sold|cogs/i],
                operating_income: [/operating income|ebit|earnings before/i],
                net_income: [/net income|net profit|bottom line/i],
                current_assets: [/current assets|total current assets/i],
                total_assets: [/total assets|total current and non-current/i],
                current_liabilities: [/current liabilities|total current liabilities/i],
                total_liabilities: [/total liabilities|total debt/i],
                stockholders_equity: [/stockholders equity|shareholders equity|total equity/i],
                accounts_receivable: [/accounts receivable|trade receivable/i],
                inventory: [/inventory|total inventory/i],
                operating_cash_flow: [/operating cash flow|cash from operations/i],
                capex: [/capital expenditure|capex|purchase of property/i],
            };

            const data = { year };
            const lines = text.split('\n');

            // Try to find values using pattern matching
            for (const [key, patternList] of Object.entries(patterns)) {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    for (const pattern of patternList) {
                        if (pattern.test(line)) {
                            // Try to extract number from this line or next line
                            const numMatch = line.match(/[\d,]+\.?\d*/) || 
                                           (lines[i + 1] ? lines[i + 1].match(/[\d,]+\.?\d*/) : null);
                            if (numMatch) {
                                const value = parseFloat(numMatch[0].replace(/,/g, ''));
                                data[key] = value * 1000000; // Assume in millions, convert to actual
                                console.log(`[v0] Found ${key}: ${value}M`);
                            }
                        }
                    }
                }
            }

            return data;
        }

        // ==========================================
        // RATIO CALCULATIONS
        // ==========================================

        function calculateRatios(financialData) {
            const ratios = {};

            // Group data by year
            const byYear = {};
            Object.values(financialData).forEach(yearData => {
                if (yearData.year) {
                    byYear[yearData.year] = yearData;
                }
            });

            // Calculate ratios for each year
            for (const [year, data] of Object.entries(byYear)) {
                const yearRatios = {};

                // LIQUIDITY RATIOS
                if (data.current_assets && data.current_liabilities) {
                    yearRatios.current_ratio = data.current_assets / data.current_liabilities;
                }
                if (data.current_assets && data.inventory && data.current_liabilities) {
                    yearRatios.quick_ratio = (data.current_assets - data.inventory) / data.current_liabilities;
                }

                // PROFITABILITY RATIOS
                if (data.net_income && data.revenue) {
                    yearRatios.npm = (data.net_income / data.revenue) * 100; // Net Profit Margin %
                }
                if (data.net_income && data.total_assets) {
                    yearRatios.roa = (data.net_income / data.total_assets) * 100; // Return on Assets %
                }
                if (data.net_income && data.stockholders_equity) {
                    yearRatios.roe = (data.net_income / data.stockholders_equity) * 100; // Return on Equity %
                }
                if (data.operating_income && data.revenue) {
                    yearRatios.operating_margin = (data.operating_income / data.revenue) * 100;
                }

                // SOLVENCY RATIOS
                if (data.total_liabilities && data.stockholders_equity) {
                    yearRatios.debt_to_equity = data.total_liabilities / data.stockholders_equity;
                }
                if (data.total_liabilities && data.total_assets) {
                    yearRatios.debt_to_assets = data.total_liabilities / data.total_assets;
                }

                // EFFICIENCY RATIOS
                if (data.revenue && data.total_assets) {
                    yearRatios.asset_turnover = data.revenue / data.total_assets;
                }
                if (data.revenue && data.accounts_receivable) {
                    yearRatios.receivables_turnover = data.revenue / data.accounts_receivable;
                }
                if (data.cost_of_revenue && data.inventory) {
                    yearRatios.inventory_turnover = data.cost_of_revenue / data.inventory;
                }

                ratios[year] = yearRatios;
            }

            return ratios;
        }

        // ==========================================
        // RENDERING FUNCTIONS
        // ==========================================

        function renderOverview() {
            const container = document.getElementById('overviewContent');
            const years = Object.keys(APP_STATE.ratios).sort();
            
            let html = '<table><thead><tr><th>Metric</th>';
            years.forEach(year => html += `<th>${year}</th>`);
            html += '</tr></thead><tbody>';

            const allMetrics = new Set();
            Object.values(APP_STATE.ratios).forEach(yearRatios => {
                Object.keys(yearRatios).forEach(metric => allMetrics.add(metric));
            });

            Array.from(allMetrics).forEach(metric => {
                html += `<tr><td><strong>${metric.replace(/_/g, ' ').toUpperCase()}</strong></td>`;
                years.forEach(year => {
                    const value = APP_STATE.ratios[year][metric];
                    let display = value ? value.toFixed(2) : 'N/A';
                    html += `<td>${display}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderLiquidityRatios() {
            const container = document.getElementById('liquidityContent');
            const metrics = ['current_ratio', 'quick_ratio'];
            renderRatioTab(container, metrics);
        }

        function renderProfitabilityRatios() {
            const container = document.getElementById('profitabilityContent');
            const metrics = ['npm', 'roa', 'roe', 'operating_margin'];
            renderRatioTab(container, metrics);
        }

        function renderSolvencyRatios() {
            const container = document.getElementById('solvencyContent');
            const metrics = ['debt_to_equity', 'debt_to_assets'];
            renderRatioTab(container, metrics);
        }

        function renderEfficiencyRatios() {
            const container = document.getElementById('efficiencyContent');
            const metrics = ['asset_turnover', 'receivables_turnover', 'inventory_turnover'];
            renderRatioTab(container, metrics);
        }

        function renderRatioTab(container, metrics) {
            const years = Object.keys(APP_STATE.ratios).sort();
            let html = '<table><thead><tr><th>Metric</th>';
            years.forEach(year => html += `<th>${year}</th>`);
            html += '<th>Status</th></tr></thead><tbody>';

            metrics.forEach(metric => {
                const latestYear = years[years.length - 1];
                const latestValue = APP_STATE.ratios[latestYear][metric];
                const badgeClass = getRatioBadgeClass(metric, latestValue);

                html += `<tr><td><strong>${metric.replace(/_/g, ' ').toUpperCase()}</strong></td>`;
                years.forEach(year => {
                    const value = APP_STATE.ratios[year][metric];
                    let display = value ? value.toFixed(2) : 'N/A';
                    html += `<td>${display}</td>`;
                });
                html += `<td><span class="ratio-badge ${badgeClass}">${badgeClass.toUpperCase()}</span></td></tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderTrendAnalysis() {
            const container = document.getElementById('trendsContent');
            const years = Object.keys(APP_STATE.ratios).sort();
            const metrics = ['current_ratio', 'npm', 'roe', 'debt_to_equity'];

            let html = '<div class="ratio-grid">';

            metrics.forEach(metric => {
                const values = years.map(y => APP_STATE.ratios[y][metric]).filter(v => v);
                if (values.length > 0) {
                    const avgChange = (values[values.length - 1] - values[0]) / values[0] * 100;
                    const trend = avgChange > 0 ? 'üìà Up' : 'üìâ Down';
                    const color = avgChange > 0 ? 'var(--accent-green)' : 'var(--accent-red)';

                    html += `
                        <div class="ratio-card">
                            <div class="ratio-card-label">${metric.replace(/_/g, ' ').toUpperCase()}</div>
                            <div class="ratio-card-value" style="color: ${color};">${trend}</div>
                            <div class="ratio-card-unit">Change: ${avgChange.toFixed(1)}%</div>
                        </div>
                    `;
                }
            });

            html += '</div>';
            
            // Add simple trend chart using ASCII for accessibility
            html += '<div style="margin-top: 2rem;"><h3>Year-over-Year Changes</h3>';
            metrics.forEach(metric => {
                const values = years.map(y => APP_STATE.ratios[y][metric]).filter(v => v);
                if (values.length > 1) {
                    html += `<p><strong>${metric}:</strong> `;
                    for (let i = 1; i < values.length; i++) {
                        const change = ((values[i] - values[i-1]) / values[i-1] * 100);
                        const direction = change > 0 ? 'üìà' : 'üìâ';
                        html += `${years[i]} ${direction} ${change.toFixed(1)}% | `;
                    }
                    html += '</p>';
                }
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // ==========================================
        // AI INSIGHTS
        // ==========================================

        async function getAIInsights() {
            if (!APP_STATE.apiKey) {
                showError('Please enter an API key to get AI insights');
                return;
            }

            const insightsDiv = document.getElementById('insightsContent');
            insightsDiv.innerHTML = '<div class="loading" style="margin: 2rem auto;"></div><p style="text-align: center;">Analyzing financial health with AI...</p>';

            try {
                const prompt = generateAnalysisPrompt();
                console.log('[v0] Sending prompt to AI:', prompt.substring(0, 200) + '...');

                let response;
                if (APP_STATE.aiProvider === 'openai') {
                    response = await callOpenAI(prompt);
                } else if (APP_STATE.aiProvider === 'anthropic') {
                    response = await callAnthropic(prompt);
                } else if (APP_STATE.aiProvider === 'grok') {
                    response = await callGrok(prompt);
                }

                displayInsights(response);
            } catch (error) {
                console.error('[v0] AI API Error:', error);
                showError(`AI API Error: ${error.message}`);
                insightsDiv.innerHTML = '<div class="alert error"><span class="alert-icon">‚ùå</span><div>Failed to get AI insights. Check your API key and try again.</div></div>';
            }
        }

        function generateAnalysisPrompt() {
            const years = Object.keys(APP_STATE.ratios).sort();
            const latestYear = years[years.length - 1];
            const previousYear = years.length > 1 ? years[years.length - 2] : null;

            const latestRatios = APP_STATE.ratios[latestYear];
            const previousRatios = previousYear ? APP_STATE.ratios[previousYear] : {};

            const prompt = `
You are an expert financial analyst. Analyze the following financial ratios for ${APP_STATE.companyName} and provide:
1. Current Financial Health Assessment
2. Key Strengths
3. Areas of Concern
4. Trends Over Time
5. Actionable Recommendations

Financial Ratios:

Latest Year (${latestYear}):
- Current Ratio: ${latestRatios.current_ratio?.toFixed(2) || 'N/A'} (ideal: >1.5)
- Quick Ratio: ${latestRatios.quick_ratio?.toFixed(2) || 'N/A'} (ideal: >1.0)
- Net Profit Margin: ${latestRatios.npm?.toFixed(2) || 'N/A'}%
- Return on Assets: ${latestRatios.roa?.toFixed(2) || 'N/A'}%
- Return on Equity: ${latestRatios.roe?.toFixed(2) || 'N/A'}%
- Debt to Equity: ${latestRatios.debt_to_equity?.toFixed(2) || 'N/A'} (ideal: <2.0)
- Asset Turnover: ${latestRatios.asset_turnover?.toFixed(2) || 'N/A'} (ideal: >1.5)
- Inventory Turnover: ${latestRatios.inventory_turnover?.toFixed(2) || 'N/A'}
- Receivables Turnover: ${latestRatios.receivables_turnover?.toFixed(2) || 'N/A'}

${previousYear ? `
Previous Year (${previousYear}):
- Current Ratio: ${previousRatios.current_ratio?.toFixed(2) || 'N/A'}
- Net Profit Margin: ${previousRatios.npm?.toFixed(2) || 'N/A'}%
- Return on Equity: ${previousRatios.roe?.toFixed(2) || 'N/A'}%
- Debt to Equity: ${previousRatios.debt_to_equity?.toFixed(2) || 'N/A'}
` : ''}

Provide a professional, actionable analysis with specific insights and recommendations.
`;
            return prompt;
        }

        async function callOpenAI(prompt) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${APP_STATE.apiKey}`,
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.7,
                    max_tokens: 1500,
                }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'OpenAI API Error');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callAnthropic(prompt) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': APP_STATE.apiKey,
                    'anthropic-version': '2023-06-01',
                },
                body: JSON.stringify({
                    model: 'claude-3-5-sonnet-20241022',
                    max_tokens: 1500,
                    messages: [{ role: 'user', content: prompt }],
                }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Anthropic API Error');
            }

            const data = await response.json();
            return data.content[0].text;
        }

        async function callGrok(prompt) {
            const response = await fetch('https://api.x.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${APP_STATE.apiKey}`,
                },
                body: JSON.stringify({
                    model: 'grok-beta',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.7,
                    max_tokens: 1500,
                }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Grok API Error');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function displayInsights(insights) {
            const container = document.getElementById('insightsContent');
            container.innerHTML = `
                <div class="insights-container">
                    <h3>üß† AI-Generated Analysis</h3>
                    <div class="insights-text">${insights.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        }

        // ==========================================
        // MAIN ANALYSIS FLOW
        // ==========================================

        async function analyzeFinancials() {
            console.log('[v0] Starting financial analysis...');
            const companyName = document.getElementById('companyName').value;
            const analysisPeriod = document.getElementById('analysisPeriod').value;
            const apiKey = document.getElementById('apiKey').value;
            const aiProvider = document.getElementById('aiProvider').value;

            if (!companyName) {
                showError('Please enter a company name');
                return;
            }

            APP_STATE.companyName = companyName;
            APP_STATE.analysisPeriod = analysisPeriod;
            APP_STATE.apiKey = apiKey;
            APP_STATE.aiProvider = aiProvider;

            if (document.getElementById('rememberKey').checked) {
                localStorage.setItem('finanalyzer_apikey', apiKey);
            }

            // Collect all PDF files
            const incomeFiles = Array.from(document.getElementById('incomeFiles').files);
            const balanceFiles = Array.from(document.getElementById('balanceFiles').files);
            const cashflowFiles = Array.from(document.getElementById('cashflowFiles').files);

            if (incomeFiles.length === 0 || balanceFiles.length === 0 || cashflowFiles.length === 0) {
                showError('Please upload all three types of financial statements (Income, Balance, Cash Flow)');
                return;
            }

            // Parse PDFs
            console.log('[v0] Parsing PDFs...');
            const allFiles = [...incomeFiles, ...balanceFiles, ...cashflowFiles];
            const parsedData = {};

            for (const file of allFiles) {
                const data = await parsePDF(file);
                if (data && data.year) {
                    if (!parsedData[data.year]) parsedData[data.year] = {};
                    Object.assign(parsedData[data.year], data);
                }
            }

            if (Object.keys(parsedData).length === 0) {
                showError('Failed to parse PDFs. Please use manual data entry instead.');
                document.getElementById('manualEntrySection').classList.remove('hidden');
                return;
            }

            APP_STATE.financialData = parsedData;

            // Calculate ratios
            console.log('[v0] Calculating ratios...');
            APP_STATE.ratios = calculateRatios(parsedData);

            // Show results
            document.getElementById('resultsSection').classList.remove('hidden');
            renderAllTabs();

            // Get AI insights
            if (apiKey) {
                const insightsTab = document.querySelector('[data-tab="insights"]');
                insightsTab.addEventListener('click', getAIInsights);
            }

            showSuccess('Analysis complete!');
            window.scrollTo({ top: document.getElementById('resultsSection').offsetTop - 100, behavior: 'smooth' });
        }

        function renderAllTabs() {
            renderOverview();
            renderLiquidityRatios();
            renderProfitabilityRatios();
            renderSolvencyRatios();
            renderEfficiencyRatios();
            renderTrendAnalysis();
        }

        // ==========================================
        // TAB NAVIGATION
        // ==========================================

        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();

            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');

                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                    const tabId = `${tabName}Tab`;
                    const tab = document.getElementById(tabId);
                    if (tab) {
                        tab.classList.remove('hidden');
                        
                        // Load AI insights on demand
                        if (tabName === 'insights' && document.getElementById('insightsContent').innerHTML === '') {
                            getAIInsights();
                        }
                    }
                });
            });

            // Upload areas
            setupUploadArea('incomeUploadArea', 'incomeFiles', 'incomeFileList');
            setupUploadArea('balanceUploadArea', 'balanceFiles', 'balanceFileList');
            setupUploadArea('cashflowUploadArea', 'cashflowFiles', 'cashflowFileList');

            // Analyze button
            document.getElementById('analyzeBtn').addEventListener('click', analyzeFinancials);

            // Manual data entry
            document.getElementById('addManualDataBtn').addEventListener('click', () => {
                const year = document.getElementById('manualYear').value;
                try {
                    const incomeData = JSON.parse(document.getElementById('manualIncomeData').value);
                    const balanceData = JSON.parse(document.getElementById('manualBalanceData').value);
                    
                    APP_STATE.financialData[year] = {
                        year,
                        ...incomeData,
                        ...balanceData,
                    };

                    APP_STATE.ratios = calculateRatios(APP_STATE.financialData);
                    renderAllTabs();
                    document.getElementById('resultsSection').classList.remove('hidden');
                    showSuccess(`Added data for ${year}`);
                } catch (error) {
                    showError('Invalid JSON format. Please check your data.');
                }
            });

            // Provider selection
            document.getElementById('aiProvider').addEventListener('change', (e) => {
                APP_STATE.aiProvider = e.target.value;
            });
        });
    </script>
</body>
</html>
