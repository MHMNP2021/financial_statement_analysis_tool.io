<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Statement Analyzer | Professional Financial Analysis</title>
    
    <!-- CDN Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066cc;
            --primary-dark: #004499;
            --secondary: #00d4aa;
            --accent: #ff6b35;
            --neutral-50: #f8f9fa;
            --neutral-100: #f0f2f5;
            --neutral-200: #e1e5eb;
            --neutral-600: #4a5568;
            --neutral-700: #2d3748;
            --neutral-900: #1a202c;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, var(--neutral-900) 0%, #0f1419 100%);
            color: var(--neutral-700);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--neutral-200);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--neutral-600);
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            margin-bottom: 4rem;
            animation: fadeInUp 0.6s ease;
        }

        .hero h1 {
            font-size: 3rem;
            color: white;
            margin-bottom: 1rem;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .hero p {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 3rem;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .upload-grid {
                grid-template-columns: 1fr;
            }
        }

        .upload-box {
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--neutral-50);
        }

        .upload-box:hover {
            border-color: var(--secondary);
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.05) 0%, rgba(0, 212, 170, 0.05) 100%);
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .upload-box h3 {
            color: var(--neutral-900);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .upload-box p {
            color: var(--neutral-600);
            font-size: 0.9rem;
        }

        /* Control Panel */
        .control-panel {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .control-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .control-group label {
            color: var(--neutral-700);
            font-weight: 600;
            font-size: 0.95rem;
        }

        select, input[type="number"], input[type="text"] {
            padding: 0.75rem 1rem;
            border: 1px solid var(--neutral-200);
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            color: var(--neutral-900);
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        /* Buttons */
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 102, 204, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--neutral-100);
            color: var(--primary);
            border: 1px solid var(--neutral-200);
        }

        .btn-secondary:hover {
            background: var(--neutral-200);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
        }

        /* Files List */
        .files-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .file-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .file-info h4 {
            color: var(--neutral-900);
            margin-bottom: 0.25rem;
        }

        .file-info p {
            color: var(--neutral-600);
            font-size: 0.85rem;
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--neutral-100);
            color: var(--neutral-600);
            border-radius: 6px;
            font-size: 1.1rem;
        }

        .btn-icon:hover {
            background: var(--neutral-200);
            color: var(--primary);
        }

        /* Analysis Section */
        .analysis-section {
            display: none;
        }

        .analysis-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .section-title {
            font-size: 1.8rem;
            color: var(--neutral-900);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary);
        }

        /* Data Entry Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: var(--neutral-700);
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-group input {
            padding: 0.75rem 1rem;
            border: 1px solid var(--neutral-200);
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
        }

        /* Years Grid */
        .years-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--neutral-50);
            border-radius: 10px;
        }

        .year-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }

        .year-card h4 {
            color: var(--primary);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .year-inputs {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .year-inputs input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--neutral-200);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        /* Ratios Display */
        .ratios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .ratio-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border-top: 3px solid var(--primary);
        }

        .ratio-card.profitability {
            border-top-color: var(--success);
        }

        .ratio-card.liquidity {
            border-top-color: var(--secondary);
        }

        .ratio-card.solvency {
            border-top-color: var(--warning);
        }

        .ratio-card.efficiency {
            border-top-color: var(--accent);
        }

        .ratio-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .ratio-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(0, 102, 204, 0.1);
        }

        .ratio-card.profitability .ratio-icon {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .ratio-card.liquidity .ratio-icon {
            background: rgba(0, 212, 170, 0.1);
            color: var(--secondary);
        }

        .ratio-card.solvency .ratio-icon {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .ratio-card.efficiency .ratio-icon {
            background: rgba(255, 107, 53, 0.1);
            color: var(--accent);
        }

        .ratio-name {
            flex: 1;
        }

        .ratio-name h4 {
            color: var(--neutral-900);
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .ratio-name p {
            color: var(--neutral-600);
            font-size: 0.8rem;
        }

        .ratio-values {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .ratio-value {
            flex: 1;
            min-width: 100px;
        }

        .ratio-value-label {
            font-size: 0.75rem;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .ratio-value-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .ratio-card.profitability .ratio-value-number {
            color: var(--success);
        }

        .ratio-card.liquidity .ratio-value-number {
            color: var(--secondary);
        }

        .ratio-card.solvency .ratio-value-number {
            color: var(--warning);
        }

        .ratio-card.efficiency .ratio-value-number {
            color: var(--accent);
        }

        .ratio-trend {
            font-size: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            display: inline-block;
            font-weight: 600;
        }

        .trend-positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .trend-negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .trend-neutral {
            background: rgba(107, 114, 128, 0.1);
            color: var(--neutral-600);
        }

        /* Charts */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .chart-container h3 {
            color: var(--neutral-900);
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* AI Insights */
        .insights-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-top: 2rem;
        }

        .insights-section h3 {
            color: var(--neutral-900);
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .insights-section h3::before {
            content: "ü§ñ";
            font-size: 1.5rem;
        }

        .ai-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .insight-card {
            background: var(--neutral-50);
            border-left: 4px solid var(--primary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        .insight-card strong {
            color: var(--primary);
        }

        .insight-loading {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--neutral-600);
            font-style: italic;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--neutral-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: var(--primary);
            color: white;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--neutral-200);
            color: var(--neutral-700);
        }

        tbody tr:hover {
            background: var(--neutral-50);
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        /* Alerts & Messages */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: gap;
            gap: 1rem;
        }

        .alert-info {
            background: rgba(0, 102, 204, 0.1);
            color: var(--primary);
            border-left: 4px solid var(--primary);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Footer */
        footer {
            background: rgba(0, 0, 0, 0.3);
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            padding: 3rem 2rem;
            margin-top: 4rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }

            .hero p {
                font-size: 1rem;
            }

            .nav-links {
                gap: 1rem;
                font-size: 0.85rem;
            }

            .upload-grid {
                grid-template-columns: 1fr;
            }

            .control-panel {
                flex-direction: column;
                align-items: stretch;
            }

            .ratios-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 0.75rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .years-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading State */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            background: var(--neutral-50);
            border-radius: 10px;
            color: var(--neutral-600);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: var(--neutral-900);
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">üìä FSA</div>
            <nav class="nav-links">
                <a href="#upload">Upload</a>
                <a href="#analysis">Analysis</a>
                <a href="#insights">Insights</a>
                <a href="#help" onclick="showHelp()">Help</a>
            </nav>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Hero Section -->
        <section class="hero" id="upload">
            <h1>Financial Statement Analyzer</h1>
            <p>Upload PDFs, Excel, or CSV files to analyze your company's financial health with AI-powered insights</p>
        </section>

        <!-- Upload Section -->
        <section class="upload-section card">
            <h2 class="section-title">Step 1: Upload Your Financial Files</h2>
            
            <div class="upload-grid">
                <div class="upload-box" onclick="document.getElementById('pdfInput').click()">
                    <div class="upload-icon">üìÑ</div>
                    <h3>Upload PDF</h3>
                    <p>Income Statement, Balance Sheet, Cash Flow</p>
                    <input type="file" id="pdfInput" accept=".pdf" multiple onchange="handlePDFUpload(event)">
                </div>
                <div class="upload-box" onclick="document.getElementById('excelInput').click()">
                    <div class="upload-icon">üìà</div>
                    <h3>Upload Excel/CSV</h3>
                    <p>.xlsx, .xls, .csv files supported</p>
                    <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" multiple onchange="handleExcelUpload(event)">
                </div>
            </div>

            <!-- Uploaded Files List -->
            <div id="filesList" class="files-list" style="display: none;"></div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-group">
                    <label for="analysisYears">Analysis Period:</label>
                    <select id="analysisYears" onchange="updateYearInputs()">
                        <option value="3">3 Years</option>
                        <option value="5" selected>5 Years</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="proceedToAnalysis()" id="proceedBtn" style="display: none;">
                    Proceed to Analysis ‚Üí
                </button>
            </div>
        </section>

        <!-- Data Entry Section -->
        <section class="card" id="dataEntry" style="display: none; margin-top: 2rem;">
            <h2 class="section-title">Step 2: Enter Financial Data</h2>
            <p style="color: var(--neutral-600); margin-bottom: 1.5rem;">
                Or manually enter your financial statements if PDF parsing didn't extract data
            </p>

            <!-- Company Info -->
            <div class="form-grid">
                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" id="companyName" placeholder="e.g., Acme Corp">
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <select id="currency">
                        <option>USD ($)</option>
                        <option>EUR (‚Ç¨)</option>
                        <option>GBP (¬£)</option>
                        <option>JPY (¬•)</option>
                    </select>
                </div>
            </div>

            <!-- Years Data -->
            <div class="years-grid" id="yearsGrid"></div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn-primary" onclick="analyzeData()">Analyze Financial Data ‚Üí</button>
                <button class="btn-secondary" onclick="useManualEntry()">Use Example Data</button>
            </div>
        </section>

        <!-- Analysis Section -->
        <section class="analysis-section" id="analysis">
            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="card" style="text-align: center;">
                    <p style="color: var(--neutral-600); font-size: 0.9rem; margin-bottom: 0.5rem;">Company</p>
                    <h3 id="summaryCompany" style="color: var(--primary); font-size: 1.5rem;">-</h3>
                </div>
                <div class="card" style="text-align: center;">
                    <p style="color: var(--neutral-600); font-size: 0.9rem; margin-bottom: 0.5rem;">Period</p>
                    <h3 id="summaryPeriod" style="color: var(--primary); font-size: 1.5rem;">-</h3>
                </div>
                <div class="card" style="text-align: center;">
                    <p style="color: var(--neutral-600); font-size: 0.9rem; margin-bottom: 0.5rem;">Latest Revenue</p>
                    <h3 id="summaryRevenue" style="color: var(--primary); font-size: 1.5rem;">-</h3>
                </div>
                <div class="card" style="text-align: center;">
                    <p style="color: var(--neutral-600); font-size: 0.9rem; margin-bottom: 0.5rem;">Health Score</p>
                    <h3 id="summaryHealth" style="color: var(--success); font-size: 1.5rem;">-</h3>
                </div>
            </div>

            <!-- Ratios Display -->
            <h2 class="section-title">Financial Ratios Analysis</h2>
            <div class="ratios-grid" id="ratiosContainer"></div>

            <!-- Trend Analysis -->
            <h2 class="section-title">Trend Analysis</h2>
            <div class="table-responsive">
                <table id="trendTable">
                    <thead>
                        <tr id="trendHeader"></tr>
                    </thead>
                    <tbody id="trendBody"></tbody>
                </table>
            </div>

            <!-- Charts -->
            <h2 class="section-title">Visual Analysis</h2>
            <div class="charts-section">
                <div class="chart-container">
                    <h3>Revenue & Net Income Trend</h3>
                    <div class="chart-wrapper">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Profitability Ratios</h3>
                    <div class="chart-wrapper">
                        <canvas id="profitabilityChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Liquidity Ratios</h3>
                    <div class="chart-wrapper">
                        <canvas id="liquidityChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Solvency Ratios</h3>
                    <div class="chart-wrapper">
                        <canvas id="solvencyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- AI Insights -->
            <section class="insights-section" id="insights">
                <h3>AI-Powered Financial Insights</h3>
                
                <div class="ai-controls">
                    <div class="control-group">
                        <label for="apiKey">API Key:</label>
                        <input type="password" id="apiKey" placeholder="Your API key (stored locally)" style="min-width: 250px;">
                    </div>
                    <div class="control-group">
                        <label for="aiProvider">Provider:</label>
                        <select id="aiProvider">
                            <option value="openai">OpenAI (GPT-4)</option>
                            <option value="grok">xAI Grok</option>
                            <option value="claude">Anthropic Claude</option>
                        </select>
                    </div>
                    <button class="btn-success" onclick="generateAIInsights()">Generate Insights ü§ñ</button>
                </div>

                <div id="insightsContainer"></div>
            </section>

            <!-- Export Section -->
            <div style="display: flex; gap: 1rem; margin-top: 3rem; flex-wrap: wrap;">
                <button class="btn-primary" onclick="exportToJSON()">üì• Export Data (JSON)</button>
                <button class="btn-primary" onclick="exportToCSV()">üì• Export Ratios (CSV)</button>
                <button class="btn-primary" onclick="printReport()">üñ®Ô∏è Print Report</button>
                <button class="btn-secondary" onclick="resetApp()">‚Üª Start Over</button>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-links">
                <a href="#help" onclick="showHelp()">Documentation</a>
                <a href="#privacy">Privacy</a>
                <a href="#terms">Terms</a>
            </div>
            <p>&copy; 2025 Financial Statement Analyzer. All data is processed client-side only. No data is sent to external servers.</p>
        </div>
    </footer>

    <script>
        // ========================================
        // APP STATE
        // ========================================
        let appState = {
            companyName: '',
            financialData: {},
            years: [],
            ratios: {},
            charts: {}
        };

        // ========================================
        // FILE HANDLING
        // ========================================
        async function handlePDFUpload(event) {
            const files = Array.from(event.target.files);
            console.log('[v0] PDF files selected:', files.length);

            for (const file of files) {
                try {
                    const text = await extractPDFText(file);
                    console.log('[v0] Extracted text length:', text.length);
                    parseFinancialData(text, file.name);
                    addFileToList(file, 'PDF');
                } catch (error) {
                    console.error('[v0] PDF extraction error:', error);
                    showAlert(`Failed to parse ${file.name}. You can manually enter data instead.`, 'error');
                    addFileToList(file, 'PDF', true);
                }
            }
        }

        async function extractPDFText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const pdf = await pdfjsLib.getDocument(e.target.result).promise;
                        let text = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(' ') + '\n';
                        }
                        resolve(text);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function handleExcelUpload(event) {
            const files = Array.from(event.target.files);
            console.log('[v0] Excel files selected:', files.length);

            for (const file of files) {
                try {
                    const data = await readExcelFile(file);
                    parseFinancialDataFromExcel(data, file.name);
                    addFileToList(file, 'Excel');
                } catch (error) {
                    console.error('[v0] Excel parsing error:', error);
                    showAlert(`Failed to parse ${file.name}. You can manually enter data instead.`, 'error');
                    addFileToList(file, file.name, true);
                }
            }
        }

        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        const data = {};
                        workbook.SheetNames.forEach(sheetName => {
                            data[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                        });
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function addFileToList(file, type, error = false) {
            const filesList = document.getElementById('filesList');
            filesList.style.display = 'grid';

            const fileCard = document.createElement('div');
            fileCard.className = 'file-card';
            fileCard.innerHTML = `
                <div class="file-info">
                    <h4>${file.name}</h4>
                    <p>${type} ‚Ä¢ ${(file.size / 1024).toFixed(2)} KB ${error ? '‚ùå Parse failed' : '‚úÖ Uploaded'}</p>
                </div>
                <div class="file-actions">
                    <button class="btn-icon" onclick="this.parentElement.parentElement.remove()" title="Remove">‚úï</button>
                </div>
            `;
            filesList.appendChild(fileCard);

            if (filesList.children.length > 0) {
                document.getElementById('proceedBtn').style.display = 'flex';
            }
        }

        // ========================================
        // DATA PARSING
        // ========================================
        function parseFinancialData(text, filename) {
            // Simple regex-based extraction
            const revenue = extractNumber(text, /(?:revenue|sales|total\s+revenue)[\s\:\=]*([\d\,\.]+)/gi);
            const netIncome = extractNumber(text, /(?:net\s+income|net\s+profit)[\s\:\=]*([\d\,\.]+)/gi);
            const assets = extractNumber(text, /(?:total\s+assets)[\s\:\=]*([\d\,\.]+)/gi);
            const liabilities = extractNumber(text, /(?:total\s+liabilities)[\s\:\=]*([\d\,\.]+)/gi);

            console.log('[v0] Parsed data:', { revenue, netIncome, assets, liabilities });
        }

        function parseFinancialDataFromExcel(data, filename) {
            console.log('[v0] Excel data parsed:', Object.keys(data));
            // Process Excel data based on structure
        }

        function extractNumber(text, regex) {
            const match = text.match(regex);
            if (match && match[1]) {
                return parseFloat(match[1].replace(/,/g, ''));
            }
            return null;
        }

        // ========================================
        // UI FLOW
        // ========================================
        function updateYearInputs() {
            const years = parseInt(document.getElementById('analysisYears').value);
            const yearsGrid = document.getElementById('yearsGrid');
            yearsGrid.innerHTML = '';

            appState.years = [];

            const currentYear = new Date().getFullYear();
            for (let i = 0; i < years; i++) {
                const year = currentYear - (years - 1 - i);
                appState.years.push(year);

                const yearCard = document.createElement('div');
                yearCard.className = 'year-card';
                yearCard.innerHTML = `
                    <h4>Year ${year}</h4>
                    <div class="year-inputs">
                        <input type="number" placeholder="Revenue" data-year="${year}" data-field="revenue">
                        <input type="number" placeholder="Net Income" data-year="${year}" data-field="netIncome">
                        <input type="number" placeholder="Total Assets" data-year="${year}" data-field="assets">
                        <input type="number" placeholder="Current Assets" data-year="${year}" data-field="currentAssets">
                        <input type="number" placeholder="Current Liab." data-year="${year}" data-field="currentLiabilities">
                        <input type="number" placeholder="Total Debt" data-year="${year}" data-field="debt">
                        <input type="number" placeholder="Equity" data-year="${year}" data-field="equity">
                        <input type="number" placeholder="COGS" data-year="${year}" data-field="cogs">
                    </div>
                `;
                yearsGrid.appendChild(yearCard);
            }
        }

        function proceedToAnalysis() {
            document.getElementById('dataEntry').style.display = 'block';
            updateYearInputs();
            window.scrollTo({ top: document.getElementById('dataEntry').offsetTop - 100, behavior: 'smooth' });
        }

        function useManualEntry() {
            // Load example data
            const years = parseInt(document.getElementById('analysisYears').value);
            appState.companyName = 'Example Corp';

            appState.financialData = {};
            const currentYear = new Date().getFullYear();

            for (let i = 0; i < years; i++) {
                const year = currentYear - (years - 1 - i);
                appState.financialData[year] = {
                    revenue: 1000000 + (i * 100000),
                    netIncome: 200000 + (i * 20000),
                    assets: 5000000 + (i * 200000),
                    currentAssets: 1500000 + (i * 50000),
                    currentLiabilities: 800000 + (i * 30000),
                    debt: 2000000,
                    equity: 3000000 + (i * 100000),
                    cogs: 600000 + (i * 60000)
                };
            }

            document.getElementById('companyName').value = appState.companyName;
            analyzeData();
        }

        function analyzeData() {
            appState.companyName = document.getElementById('companyName').value || 'Your Company';

            // Collect form data
            appState.years.forEach(year => {
                appState.financialData[year] = {};
                document.querySelectorAll(`input[data-year="${year}"]`).forEach(input => {
                    const field = input.getAttribute('data-field');
                    appState.financialData[year][field] = parseFloat(input.value) || 0;
                });
            });

            console.log('[v0] Analysis data:', appState.financialData);

            calculateRatios();
            displayAnalysis();
            document.getElementById('analysis').classList.add('active');
            window.scrollTo({ top: document.getElementById('analysis').offsetTop - 100, behavior: 'smooth' });
        }

        // ========================================
        // FINANCIAL RATIO CALCULATIONS
        // ========================================
        function calculateRatios() {
            appState.ratios = {
                liquidity: {},
                profitability: {},
                solvency: {},
                efficiency: {}
            };

            appState.years.forEach(year => {
                const data = appState.financialData[year];

                // LIQUIDITY RATIOS
                appState.ratios.liquidity[year] = {
                    currentRatio: data.currentAssets / (data.currentLiabilities || 1),
                    quickRatio: (data.currentAssets - (data.currentAssets * 0.3)) / (data.currentLiabilities || 1),
                    workingCapital: data.currentAssets - data.currentLiabilities
                };

                // PROFITABILITY RATIOS
                appState.ratios.profitability[year] = {
                    netProfitMargin: (data.netIncome / (data.revenue || 1)) * 100,
                    roe: (data.netIncome / (data.equity || 1)) * 100,
                    roa: (data.netIncome / (data.assets || 1)) * 100,
                    grossProfitMargin: ((data.revenue - (data.cogs || 0)) / (data.revenue || 1)) * 100
                };

                // SOLVENCY RATIOS
                appState.ratios.solvency[year] = {
                    debtToEquity: data.debt / (data.equity || 1),
                    debtToAssets: data.debt / (data.assets || 1),
                    equityRatio: data.equity / (data.assets || 1),
                    interestCoverage: data.netIncome / (data.debt * 0.05 || 1) // Assuming 5% interest rate
                };

                // EFFICIENCY RATIOS
                appState.ratios.efficiency[year] = {
                    assetTurnover: data.revenue / (data.assets || 1),
                    receivablesTurnover: data.revenue / (data.assets * 0.2 || 1),
                    inventoryTurnover: data.cogs / (data.assets * 0.3 || 1)
                };
            });

            console.log('[v0] Ratios calculated:', appState.ratios);
        }

        function displayAnalysis() {
            // Summary
            document.getElementById('summaryCompany').textContent = appState.companyName;
            document.getElementById('summaryPeriod').textContent = `${Math.min(...appState.years)}-${Math.max(...appState.years)}`;
            const latestRevenue = appState.financialData[appState.years[appState.years.length - 1]]?.revenue || 0;
            document.getElementById('summaryRevenue').textContent = formatCurrency(latestRevenue);

            const healthScore = calculateHealthScore();
            document.getElementById('summaryHealth').textContent = healthScore.toFixed(1) + '/100';

            // Ratios Display
            displayRatios();

            // Trend Table
            displayTrendAnalysis();

            // Charts
            drawCharts();
        }

        function displayRatios() {
            const container = document.getElementById('ratiosContainer');
            container.innerHTML = '';

            const latestYear = appState.years[appState.years.length - 1];
            const previousYear = appState.years[appState.years.length - 2];

            // LIQUIDITY
            const liqRatios = appState.ratios.liquidity[latestYear];
            const liqRatiosPrev = previousYear ? appState.ratios.liquidity[previousYear] : liqRatios;

            container.innerHTML += createRatioCard(
                'liquidity',
                'Current Ratio',
                'Measures short-term solvency',
                liqRatios.currentRatio,
                liqRatiosPrev.currentRatio,
                'üíß'
            );

            container.innerHTML += createRatioCard(
                'liquidity',
                'Quick Ratio',
                'Immediate liquidity position',
                liqRatios.quickRatio,
                liqRatiosPrev.quickRatio,
                '‚ö°'
            );

            // PROFITABILITY
            const profRatios = appState.ratios.profitability[latestYear];
            const profRatiosPrev = previousYear ? appState.ratios.profitability[previousYear] : profRatios;

            container.innerHTML += createRatioCard(
                'profitability',
                'Net Profit Margin',
                'Percentage of revenue retained',
                profRatios.netProfitMargin,
                profRatiosPrev.netProfitMargin,
                'üìà',
                '%'
            );

            container.innerHTML += createRatioCard(
                'profitability',
                'Return on Equity (ROE)',
                'Efficiency of using shareholder capital',
                profRatios.roe,
                profRatiosPrev.roe,
                'üí∞',
                '%'
            );

            container.innerHTML += createRatioCard(
                'profitability',
                'Return on Assets (ROA)',
                'Efficiency of using total assets',
                profRatios.roa,
                profRatiosPrev.roa,
                'üéØ',
                '%'
            );

            // SOLVENCY
            const solvRatios = appState.ratios.solvency[latestYear];
            const solvRatiosPrev = previousYear ? appState.ratios.solvency[previousYear] : solvRatios;

            container.innerHTML += createRatioCard(
                'solvency',
                'Debt-to-Equity',
                'Financial leverage ratio',
                solvRatios.debtToEquity,
                solvRatiosPrev.debtToEquity,
                '‚öñÔ∏è'
            );

            container.innerHTML += createRatioCard(
                'solvency',
                'Equity Ratio',
                'Percentage of assets financed by equity',
                solvRatios.equityRatio * 100,
                solvRatiosPrev.equityRatio * 100,
                'üè¢',
                '%'
            );

            // EFFICIENCY
            const effRatios = appState.ratios.efficiency[latestYear];
            const effRatiosPrev = previousYear ? appState.ratios.efficiency[previousYear] : effRatios;

            container.innerHTML += createRatioCard(
                'efficiency',
                'Asset Turnover',
                'Revenue generated per dollar of assets',
                effRatios.assetTurnover,
                effRatiosPrev.assetTurnover,
                'üîÑ'
            );
        }

        function createRatioCard(category, name, description, value, prevValue, icon, suffix = '') {
            const trend = calculateTrend(value, prevValue);
            const trendClass = trend > 0 ? 'trend-positive' : trend < 0 ? 'trend-negative' : 'trend-neutral';
            const trendText = trend > 0 ? '‚Üë Improving' : trend < 0 ? '‚Üì Declining' : '‚Üí Stable';

            return `
                <div class="ratio-card ${category}">
                    <div class="ratio-header">
                        <div class="ratio-icon">${icon}</div>
                        <div class="ratio-name">
                            <h4>${name}</h4>
                            <p>${description}</p>
                        </div>
                    </div>
                    <div class="ratio-values">
                        <div class="ratio-value">
                            <div class="ratio-value-label">Latest</div>
                            <div class="ratio-value-number">${formatNumber(value, 2)}${suffix}</div>
                        </div>
                        <div class="ratio-value">
                            <div class="ratio-value-label">Previous</div>
                            <div class="ratio-value-number">${formatNumber(prevValue, 2)}${suffix}</div>
                        </div>
                    </div>
                    <span class="ratio-trend ${trendClass}">${trendText} ${Math.abs(trend).toFixed(1)}%</span>
                </div>
            `;
        }

        function displayTrendAnalysis() {
            const headerRow = document.getElementById('trendHeader');
            const bodyRows = document.getElementById('trendBody');
            headerRow.innerHTML = '<th>Metric</th>';
            bodyRows.innerHTML = '';

            appState.years.forEach(year => {
                const th = document.createElement('th');
                th.textContent = year;
                th.className = 'text-right';
                headerRow.appendChild(th);
            });

            const metrics = [
                { label: 'Revenue', key: 'revenue', format: formatCurrency },
                { label: 'Net Income', key: 'netIncome', format: formatCurrency },
                { label: 'Current Ratio', key: 'currentRatio', format: (v) => v.toFixed(2) },
                { label: 'Net Profit Margin %', key: 'netProfitMargin', format: (v) => v.toFixed(1) },
                { label: 'ROE %', key: 'roe', format: (v) => v.toFixed(1) },
                { label: 'Debt-to-Equity', key: 'debtToEquity', format: (v) => v.toFixed(2) }
            ];

            metrics.forEach(metric => {
                const row = document.createElement('tr');
                row.innerHTML = `<td><strong>${metric.label}</strong></td>`;

                appState.years.forEach(year => {
                    const cell = document.createElement('td');
                    cell.className = 'text-right';

                    if (metric.key === 'revenue' || metric.key === 'netIncome') {
                        const value = appState.financialData[year][metric.key] || 0;
                        cell.textContent = metric.format(value);
                    } else if (metric.key === 'currentRatio') {
                        const value = appState.ratios.liquidity[year].currentRatio;
                        cell.textContent = metric.format(value);
                    } else if (metric.key === 'netProfitMargin') {
                        const value = appState.ratios.profitability[year].netProfitMargin;
                        cell.textContent = metric.format(value);
                    } else if (metric.key === 'roe') {
                        const value = appState.ratios.profitability[year].roe;
                        cell.textContent = metric.format(value);
                    } else if (metric.key === 'debtToEquity') {
                        const value = appState.ratios.solvency[year].debtToEquity;
                        cell.textContent = metric.format(value);
                    }

                    row.appendChild(cell);
                });

                bodyRows.appendChild(row);
            });
        }

        // ========================================
        // CHARTS
        // ========================================
        function drawCharts() {
            drawRevenueChart();
            drawProfitabilityChart();
            drawLiquidityChart();
            drawSolvencyChart();
        }

        function drawRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const revenues = appState.years.map(y => appState.financialData[y].revenue);
            const netIncomes = appState.years.map(y => appState.financialData[y].netIncome);

            if (appState.charts.revenue) appState.charts.revenue.destroy();

            appState.charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: appState.years,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenues,
                            borderColor: '#0066cc',
                            backgroundColor: 'rgba(0, 102, 204, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: '#0066cc'
                        },
                        {
                            label: 'Net Income',
                            data: netIncomes,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { font: { size: 12 } } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v, 0) } }
                    }
                }
            });
        }

        function drawProfitabilityChart() {
            const ctx = document.getElementById('profitabilityChart').getContext('2d');
            const npm = appState.years.map(y => appState.ratios.profitability[y].netProfitMargin);
            const roe = appState.years.map(y => appState.ratios.profitability[y].roe);
            const roa = appState.years.map(y => appState.ratios.profitability[y].roa);

            if (appState.charts.profitability) appState.charts.profitability.destroy();

            appState.charts.profitability = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: appState.years,
                    datasets: [
                        {
                            label: 'Net Profit Margin %',
                            data: npm,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            pointBackgroundColor: '#10b981'
                        },
                        {
                            label: 'ROE %',
                            data: roe,
                            borderColor: '#ff6b35',
                            backgroundColor: 'rgba(255, 107, 53, 0.1)',
                            pointBackgroundColor: '#ff6b35'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } }
                }
            });
        }

        function drawLiquidityChart() {
            const ctx = document.getElementById('liquidityChart').getContext('2d');
            const currentRatios = appState.years.map(y => appState.ratios.liquidity[y].currentRatio);
            const quickRatios = appState.years.map(y => appState.ratios.liquidity[y].quickRatio);

            if (appState.charts.liquidity) appState.charts.liquidity.destroy();

            appState.charts.liquidity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: appState.years,
                    datasets: [
                        {
                            label: 'Current Ratio',
                            data: currentRatios,
                            backgroundColor: '#00d4aa',
                            borderRadius: 4
                        },
                        {
                            label: 'Quick Ratio',
                            data: quickRatios,
                            backgroundColor: '#0066cc',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function drawSolvencyChart() {
            const ctx = document.getElementById('solvencyChart').getContext('2d');
            const debtToEquity = appState.years.map(y => appState.ratios.solvency[y].debtToEquity);
            const equityRatio = appState.years.map(y => appState.ratios.solvency[y].equityRatio * 100);

            if (appState.charts.solvency) appState.charts.solvency.destroy();

            appState.charts.solvency = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: appState.years,
                    datasets: [
                        {
                            label: 'Debt-to-Equity',
                            data: debtToEquity,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y',
                            pointRadius: 4,
                            pointBackgroundColor: '#f59e0b'
                        },
                        {
                            label: 'Equity Ratio %',
                            data: equityRatio,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1',
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: {
                        y: { type: 'linear', position: 'left', beginAtZero: true },
                        y1: { type: 'linear', position: 'right', beginAtZero: true }
                    }
                }
            });
        }

        // ========================================
        // AI INSIGHTS
        // ========================================
        async function generateAIInsights() {
            const apiKey = document.getElementById('apiKey').value;
            const provider = document.getElementById('aiProvider').value;

            if (!apiKey) {
                showAlert('Please enter your API key', 'error');
                return;
            }

            const insightsContainer = document.getElementById('insightsContainer');
            insightsContainer.innerHTML = '<div class="insight-loading"><div class="spinner"></div> Generating insights...</div>';

            try {
                const prompt = generateAnalysisPrompt();
                const insights = await callAIAPI(apiKey, provider, prompt);
                
                insightsContainer.innerHTML = `
                    <div class="insight-card">
                        ${insights}
                    </div>
                `;
            } catch (error) {
                console.error('[v0] AI API error:', error);
                showAlert(`AI API Error: ${error.message}`, 'error');
                insightsContainer.innerHTML = '<p style="color: var(--danger);">Failed to generate insights. Please check your API key and try again.</p>';
            }
        }

        function generateAnalysisPrompt() {
            const latestYear = appState.years[appState.years.length - 1];
            const ratios = appState.ratios;
            const data = appState.financialData;

            return `Analyze the following financial data for ${appState.companyName} (${Math.min(...appState.years)}-${Math.max(...appState.years)}) and provide professional, actionable insights:

Financial Data:
${appState.years.map(y => `
Year ${y}:
- Revenue: ${formatCurrency(data[y].revenue)}
- Net Income: ${formatCurrency(data[y].netIncome)}
- Total Assets: ${formatCurrency(data[y].assets)}
- Current Ratio: ${ratios.liquidity[y].currentRatio.toFixed(2)}
- ROE: ${ratios.profitability[y].roe.toFixed(1)}%
- Debt-to-Equity: ${ratios.solvency[y].debtToEquity.toFixed(2)}
- Net Profit Margin: ${ratios.profitability[y].netProfitMargin.toFixed(1)}%
`).join('')}

Please provide:
1. Overall financial health assessment
2. Key strengths and weaknesses
3. Trend analysis and patterns
4. Specific risks and concerns
5. Actionable recommendations for improvement
6. Benchmarking insights (how this compares to industry averages)

Format the response in clear sections with practical advice for management.`;
        }

        async function callAIAPI(apiKey, provider, prompt) {
            let response;

            if (provider === 'openai') {
                response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) throw new Error('OpenAI API error');
                const data = await response.json();
                return data.choices[0].message.content;

            } else if (provider === 'grok') {
                response = await fetch('https://api.x.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'grok-1',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) throw new Error('Grok API error');
                const data = await response.json();
                return data.choices[0].message.content;

            } else if (provider === 'claude') {
                response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'x-api-key': apiKey,
                        'Content-Type': 'application/json',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-opus-20240229',
                        max_tokens: 2000,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!response.ok) throw new Error('Claude API error');
                const data = await response.json();
                return data.content[0].text;
            }
        }

        // ========================================
        // EXPORT & UTILITY
        // ========================================
        function exportToJSON() {
            const data = {
                company: appState.companyName,
                period: `${Math.min(...appState.years)}-${Math.max(...appState.years)}`,
                financialData: appState.financialData,
                ratios: appState.ratios,
                generatedAt: new Date().toISOString()
            };

            const json = JSON.stringify(data, null, 2);
            downloadFile(json, `${appState.companyName}-analysis.json`, 'application/json');
        }

        function exportToCSV() {
            let csv = 'Metric,' + appState.years.join(',') + '\n';

            // Add revenue
            csv += 'Revenue,' + appState.years.map(y => appState.financialData[y].revenue).join(',') + '\n';

            // Add ratios
            csv += 'Current Ratio,' + appState.years.map(y => appState.ratios.liquidity[y].currentRatio.toFixed(2)).join(',') + '\n';
            csv += 'Net Profit Margin %,' + appState.years.map(y => appState.ratios.profitability[y].netProfitMargin.toFixed(1)).join(',') + '\n';
            csv += 'ROE %,' + appState.years.map(y => appState.ratios.profitability[y].roe.toFixed(1)).join(',') + '\n';
            csv += 'Debt-to-Equity,' + appState.years.map(y => appState.ratios.solvency[y].debtToEquity.toFixed(2)).join(',') + '\n';

            downloadFile(csv, `${appState.companyName}-ratios.csv`, 'text/csv');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function resetApp() {
            if (confirm('Reset the entire analysis? This cannot be undone.')) {
                appState = { companyName: '', financialData: {}, years: [], ratios: {}, charts: {} };
                document.getElementById('filesList').innerHTML = '';
                document.getElementById('filesList').style.display = 'none';
                document.getElementById('dataEntry').style.display = 'none';
                document.getElementById('analysis').classList.remove('active');
                document.getElementById('proceedBtn').style.display = 'none';
                document.getElementById('pdfInput').value = '';
                document.getElementById('excelInput').value = '';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ========================================
        // HELPERS
        // ========================================
        function calculateHealthScore() {
            const latestYear = appState.years[appState.years.length - 1];
            const ratios = appState.ratios;

            let score = 50; // Base score

            // Liquidity boost (0-15 points)
            const currentRatio = ratios.liquidity[latestYear].currentRatio;
            if (currentRatio >= 1.5) score += 15;
            else if (currentRatio >= 1.0) score += 10;
            else score -= 5;

            // Profitability boost (0-20 points)
            const npm = ratios.profitability[latestYear].netProfitMargin;
            if (npm >= 15) score += 20;
            else if (npm >= 10) score += 15;
            else if (npm >= 5) score += 10;
            else if (npm < 0) score -= 10;

            // Leverage impact (0-20 points)
            const dte = ratios.solvency[latestYear].debtToEquity;
            if (dte <= 0.5) score += 20;
            else if (dte <= 1.0) score += 15;
            else if (dte <= 2.0) score += 5;
            else score -= 10;

            // ROE impact (0-20 points)
            const roe = ratios.profitability[latestYear].roe;
            if (roe >= 15) score += 20;
            else if (roe >= 10) score += 15;
            else if (roe >= 5) score += 10;

            return Math.max(0, Math.min(100, score));
        }

        function calculateTrend(current, previous) {
            if (previous === 0) return 0;
            return ((current - previous) / Math.abs(previous)) * 100;
        }

        function formatCurrency(value, decimals = 0) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }

        function formatNumber(value, decimals = 2) {
            if (isNaN(value) || !isFinite(value)) return '‚Äî';
            return parseFloat(value).toFixed(decimals);
        }

        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<span>${message}</span>`;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
            setTimeout(() => alert.remove(), 5000);
        }

        function showHelp() {
            alert(`Financial Statement Analyzer Help

üìÑ UPLOADING FILES
- Upload PDFs of financial statements (Income Statement, Balance Sheet, Cash Flow)
- Or upload Excel/CSV files with financial data
- App tries to auto-extract data; fallback to manual entry

üìä ANALYSIS PERIOD
- Choose 3 or 5 years for trend analysis
- Compare year-over-year improvements

üí∞ FINANCIAL RATIOS
- Liquidity: Can the company pay short-term obligations?
- Profitability: How much profit is the company making?
- Solvency: Can the company meet long-term obligations?
- Efficiency: How effectively is the company using assets?

ü§ñ AI INSIGHTS
- Add your API key (stored locally, never sent to our servers)
- AI analyzes your financial data and provides professional insights
- Supported: OpenAI GPT-4, xAI Grok, Anthropic Claude

üîí PRIVACY
- 100% client-side processing
- No data sent to our servers
- API calls go directly to AI providers only with your API key
- Your data is never stored or logged

üì• EXPORT
- Download analysis as JSON for record-keeping
- Export ratios as CSV for spreadsheets
- Print report for presentations`);
        }

        // Initialize
        updateYearInputs();
    </script>
</body>
</html>
